((t,e)=>{"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports["editor.min"]=e():t["editor.min"]=e()})(this,()=>{return o={"./src/components/Editor.ts":
/*!**********************************!*\
  !*** ./src/components/Editor.ts ***!
  \**********************************/(t,e,o)=>{o.r(e),o.d(e,{EditorEventType:()=>n,default:()=>s});var n,a=o(/*! ../managers/EditorStorageManager */"./src/managers/EditorStorageManager.ts"),l=o(/*! ../models/Layout */"./src/models/Layout.ts"),d=o(/*! ../utils/tildaUtils */"./src/utils/tildaUtils.ts"),r=o(/*! ../utils/TypedEventEmitter */"./src/utils/TypedEventEmitter.ts"),c=o(/*! ../utils/api */"./src/utils/api.ts"),h=o(/*! ../utils/canvasUtils */"./src/utils/canvasUtils.ts");let i={STATE_EXPIRATION_DAYS:30,CANVAS_AREA_HEIGHT:600,LOADING_INTERVAL_MS:100};(e=n=n||{}).MOCKUP_LOADING="mockup-loading",e.MOCKUP_UPDATED="mockup-updated",e.LOADING_TIME_UPDATED="loading-time-updated",e.STATE_CHANGED="state-changed",e.LAYOUT_ADDED="layout-added",e.LAYOUT_REMOVED="layout-removed",e.LAYOUT_UPDATED="layout-updated";class s{get selectType(){return this._selectType}get selectColor(){return this._selectColor}get selectSide(){return this._selectSide}get selectSize(){return this._selectSize}get selectLayout(){return this._selectLayout}constructor({blocks:t,productConfigs:e,formConfig:o,apiConfig:i,options:s}){if(this.quantityFormBlock=null,this.formBlock=null,this.formInputVariableName=null,this.formButton=null,this._selectLayout=null,this.layouts=[],this.canvases=[],this.layersCanvases=[],this.activeCanvas=null,this.events=new r.TypedEventEmitter,this.layersHistory=[],this.currentHistoryIndex=-1,this.isRestoringFromHistory=!1,this.isLoading=!0,this.isAddingToCart=!1,this.isAddedToCart=!1,this.isGenerating=!1,this.loadingTime=0,this.loadingInterval=null,this.colorBlocks=[],this.sizeBlocks=[],this.productBlocks=[],this.loadedUserImage=null,this.editorLoadWithAi=!1,this.editorRemoveBackground=!1,this.imageCache=new Map,this.loadingElementsCache={},this.productCache=new Map,this.mockupCache=new Map,!e||0===e.length)throw new Error("[Editor] Не предоставлены конфигурации продуктов");this.storageManager=new a.EditorStorageManager,this.productConfigs=e,this.apiConfig=i,this.options=s,this.editorBlock=this.getRequiredElement(t.editorBlockClass),this.changeSideButton=this.getRequiredElement(t.changeSideButtonClass),this.editorHistoryUndoBlock=this.getRequiredElement(t.editorHistoryUndoBlockClass),this.editorHistoryRedoBlock=this.getRequiredElement(t.editorHistoryRedoBlockClass),this.quantityFormBlock=document.querySelector(t.editorQuantityFormBlockClass);i=document.querySelector(t.productListBlockClass),i&&(this.productListBlock=i),s=document.querySelector(t.productItemClass),s&&(this.productItemBlock=s),i=document.querySelector(t.editorColorsListBlockClass),i&&(this.editorColorsListBlock=i),s=document.querySelector(t.editorColorItemBlockClass),s&&(this.editorColorItemBlock=s),i=document.querySelector(t.editorSizesListBlockClass),i&&(this.editorSizesListBlock=i),s=document.querySelector(t.editorSizeItemBlockClass),s&&(this.editorSizeItemBlock=s),i=document.querySelector(t.editorLayoutsListBlockClass),i&&(this.editorLayoutsListBlock=i),s=document.querySelector(t.editorLayoutItemBlockClass),s&&(this.editorLayoutItemBlock=s),i=document.querySelector(t.editorUploadImageButtonClass),i&&(this.editorUploadImageButton=i),s=document.querySelector(t.editorUploadViewBlockClass),s&&(this.editorUploadViewBlock=s),i=document.querySelector(t.editorUploadCancelButtonClass),i&&(this.editorUploadCancelButton=i),s=document.querySelector(t.editorLoadWithAiButtonClass),s&&(this.editorLoadWithAiButton=s),i=document.querySelector(t.editorLoadWithoutAiButtonClass),i&&(this.editorLoadWithoutAiButton=i),s=document.querySelector(t.editorRemoveBackgroundButtonClass),s&&(this.editorRemoveBackgroundButton=s),i=document.querySelector(t.editorAddOrderButtonClass),i&&(this.editorAddOrderButton=i),s=document.querySelector(t.editorSumBlockClass),s&&(this.editorSumBlock=s),i=document.querySelector(t.editorProductNameClass),i&&(this.editorProductName=i),this.editorLayoutItemBlockViewClass=t.editorLayoutItemBlockViewClass,this.editorLayoutItemBlockNameClass=t.editorLayoutItemBlockNameClass,this.editorLayoutItemBlockRemoveClass=t.editorLayoutItemBlockRemoveClass,this.editorLayoutItemBlockEditClass=t.editorLayoutItemBlockEditClass,o&&(this.formBlock=document.querySelector(o.formBlockClass),this.formInputVariableName=o.formInputVariableName,this.formButton=document.querySelector(o.formButtonClass)),s=e[0];if(!s)throw new Error("[Editor] Не найден дефолтный продукт");i=s.mockups[0];if(!i)throw new Error("[Editor] Не найден дефолтный mockup");this._selectColor=i.color,this._selectSide=i.side,this._selectType=s.type,this._selectSize=s.sizes?.[0]||"M",this.editorBlock.style.position="relative",this.createBackgroundBlock(),this.mockupBlock=this.createMockupBlock(),this.canvasesContainer=this.createCanvasesContainer(),this.editorLoadingBlock=this.createEditorLoadingBlock(),this.initEvents(),this.initKeyboardShortcuts(),this.initLoadingEvents(),this.initUIComponents(),this.initializeEditor(),window.getLayouts=()=>this.layouts.map(t=>({...t,url:void 0})),window.loadLayouts=t=>{this.layouts=t.map(t=>l.Layout.fromJSON(t)),this.updateLayouts(),this.showLayoutList()},window.exportPrint=async()=>{var t,e=await this.exportArt(!1,4096);for(t of Object.keys(e)){var o=document.createElement("a");document.body.appendChild(o),o.href=e[t],o.target="_self",o.download=t+".png",o.click()}return e}}initUIComponents(){this.changeSideButton&&(this.changeSideButton.style.cursor="pointer",this.changeSideButton.onclick=()=>this.changeSide()),this.editorHistoryUndoBlock&&this.initHistoryUndoBlock(),this.editorHistoryRedoBlock&&this.initHistoryRedoBlock(),this.productListBlock&&this.productItemBlock&&this.initProductList(),this.editorAddOrderButton&&this.initAddOrderButton(),this.editorUploadImageButton&&this.initUploadImageButton(),this.editorLoadWithAiButton&&this.editorLoadWithoutAiButton&&this.editorRemoveBackgroundButton&&this.initAiButtons(),this.formBlock&&this.formButton&&this.initForm(),this.quantityFormBlock&&setTimeout(()=>this.initFixQuantityForm(),500),this.editorLayoutsListBlock&&this.showLayoutList(),this.editorUploadCancelButton&&(this.editorUploadCancelButton.style.cursor="pointer",this.editorUploadCancelButton.onclick=()=>{console.debug("[upload image button] cancel button clicked"),this.resetUserUploadImage()})}getRequiredElement(t){var e=document.querySelector(t);if(e)return e;throw new Error("[Editor] Не найден обязательный элемент: "+t)}async initializeEditor(){try{await this.storageManager.waitForReady(),await this.loadState(),await this.preloadAllMockups(),console.debug("[editor] Инициализация завершена")}catch(t){console.error("[editor] Ошибка инициализации:",t),this.initializeWithDefaults()}}async initializeWithDefaults(){console.debug("[editor] Инициализация с дефолтными значениями");try{await this.updateMockup()}catch(t){console.error("[editor] Ошибка загрузки mockup по умолчанию:",t)}}initEvents(){this.options?.disableBeforeUnloadWarning||(window.onbeforeunload=t=>{var e;if(0<this.layouts.length&&!this.isAddedToCart&&0<this.layersHistory.length)return e="Дизайн редактора может быть потерян. Вы уверены, что хотите покинуть страницу?",t.preventDefault(),t.returnValue=e});let t;window.addEventListener("resize",()=>{clearTimeout(t),t=setTimeout(()=>{this.handleWindowResize()},150)}),this.events.on(n.MOCKUP_UPDATED,t=>{this.mockupBlock.src=t})}initLoadingEvents(){this.loadingElementsCache.loadingText=this.editorLoadingBlock.querySelector("#loading-text"),this.loadingElementsCache.spinner=this.editorLoadingBlock.querySelector("#spinner"),this.events.on(n.LOADING_TIME_UPDATED,t=>{var{loadingText:e,spinner:o}=this.loadingElementsCache;this.isLoading?5<this.loadingTime?(e&&(e.style.display="block",e.innerText=""+(this.loadingTime/10).toFixed(1)),o&&(o.style.display="block"),this.editorLoadingBlock.style.backgroundColor="rgba(255, 255, 255, 0.745)"):(e&&(e.style.display="none",e.innerText=""),o&&(o.style.display="none"),this.editorLoadingBlock.style.backgroundColor="rgba(255, 255, 255, 0)"):e&&(e.style.display="none",e.innerText="")}),this.events.on(n.MOCKUP_LOADING,t=>{var{loadingText:e,spinner:o}=this.loadingElementsCache;t?(this.loadingInterval&&clearInterval(this.loadingInterval),this.loadingTime=0,this.isLoading=!0,console.debug("[mockup] loading mockup"),this.loadingInterval=setInterval(()=>{this.loadingTime++,this.emit(n.LOADING_TIME_UPDATED,this.loadingTime)},100)):(this.editorLoadingBlock.style.backgroundColor="rgba(255, 255, 255, 0)",e&&(e.style.display="none",e.innerText=""),o&&(o.style.display="none"),this.isLoading=!1,this.loadingInterval&&(clearInterval(this.loadingInterval),this.loadingInterval=null),this.loadingTime=0)})}emit(t,e){this.events.emit(t,e)}initKeyboardShortcuts(){document.addEventListener("keydown",t=>{var e=document.activeElement;e&&("INPUT"===e.tagName||"TEXTAREA"===e.tagName||"true"===e.contentEditable||e.isContentEditable)||(t.ctrlKey&&"KeyZ"===t.code&&!t.shiftKey?(t.preventDefault(),this.undo()):(t.ctrlKey&&t.shiftKey&&"KeyZ"===t.code||t.ctrlKey&&"KeyY"===t.code&&!t.shiftKey)&&(t.preventDefault(),this.redo()))})}createBackgroundBlock(){var t=document.createElement("div");return t.classList.add("editor-position"),t.id="editor-background",this.editorBlock.appendChild(t),t}createMockupBlock(){var t=document.createElement("img");return t.classList.add("editor-position"),t.id="editor-mockup",this.editorBlock.appendChild(t),t}createCanvasesContainer(){var t=document.createElement("div");return t.classList.add("editor-position"),t.id="editor-canvases-container",t.style.zIndex="10",t.style.pointerEvents="auto",this.editorBlock.appendChild(t),t}createEditorLoadingBlock(){var t=document.createElement("div"),e=(t.style.display="flex",t.classList.add("editor-position"),t.id="editor-loading",t.style.zIndex="1000",t.style.pointerEvents="none",document.createElement("div")),e=(e.id="loading-text",e.style.display="none",e.style.textAlign="center",e.style.position="absolute",e.style.top="50%",e.style.left="50%",e.style.transform="translate(-50%, -50%)",t.appendChild(e),document.createElement("div"));return e.id="spinner",e.style.display="none",t.appendChild(e),this.editorBlock.appendChild(t),t}async updateMockup(){console.debug(`[mockup] update for ${this._selectType} ${this._selectSide} `+this._selectColor.name),this.emit(n.MOCKUP_LOADING,!0);try{var t=this.findMockupUrl();if(!t)throw new Error("[mockup] Не найден mockup для текущих параметров");var e=await this.loadAndConvertImage(t);this.emit(n.MOCKUP_UPDATED,e),this.mockupBlock.src=e,console.debug("[mockup] Mockup успешно обновлен")}catch(t){throw console.error("[mockup] Ошибка обновления mockup:",t),t}finally{this.emit(n.MOCKUP_LOADING,!1)}}findMockupUrl(){var t,e=`${this._selectType}-${this._selectSide}-`+this._selectColor.name;return this.mockupCache.has(e)?this.mockupCache.get(e):(t=this.getProductByType(this._selectType))?(t=t.mockups.find(t=>t.side===this._selectSide&&t.color.name===this._selectColor.name)?.url||null,this.mockupCache.set(e,t),t):(this.mockupCache.set(e,null),null)}getProductByType(e){var t;return this.productCache.has(e)||(t=this.productConfigs.find(t=>t.type===e))&&this.productCache.set(e,t),this.productCache.get(e)}clearMockupCache(){this.mockupCache.clear()}async loadAndConvertImage(r){return this.imageCache.has(r)?(console.debug("[cache] Изображение загружено из кэша:",r),this.imageCache.get(r)):new Promise((i,s)=>{let a=new Image;a.setAttribute("crossOrigin","anonymous"),a.onload=()=>{try{var t,e=document.createElement("canvas"),o=(e.width=a.width,e.height=a.height,e.getContext("2d"));o?(o.drawImage(a,0,0),t=e.toDataURL("image/png"),this.imageCache.set(r,t),console.debug("[cache] Изображение сохранено в кэш:",r),i(t)):s(new Error("Не удалось получить контекст canvas"))}catch(t){s(t)}},a.onerror=()=>{s(new Error("Ошибка загрузки изображения: "+r))},a.src=r})}async saveState(){console.debug("[state] Сохранение состояния редактора");try{var t={date:(new Date).toISOString(),type:this._selectType,color:this._selectColor.name,side:this._selectSide,size:this._selectSize};console.debug(`[state] Сохраняем: type=${t.type}, color=${t.color}, side=${t.side}, size=`+t.size),await this.storageManager.saveEditorState(t),console.debug("[state] Состояние успешно сохранено")}catch(t){console.error("[state] Ошибка сохранения состояния:",t)}}async saveLayouts(){console.debug("[layers] Сохранение слоёв");try{await this.storageManager.saveLayers(this.layouts),console.debug("[layers] Слои успешно сохранены")}catch(t){console.error("[layers] Ошибка сохранения слоёв:",t)}}async loadLayouts(){console.debug("[layers] Загрузка слоёв");try{var t=await this.storageManager.loadLayers();t&&Array.isArray(t)?(this.layouts=t.map(t=>new l.Layout(t)),console.debug(`[layers] Загружено ${this.layouts.length} слоёв`)):(this.layouts=[],console.debug("[layers] Нет сохранённых слоёв")),this.saveLayersToHistory()}catch(t){console.error("[layers] Ошибка загрузки слоёв:",t),this.layouts=[],this.saveLayersToHistory()}}async loadState(){console.debug("[state] Загрузка состояния редактора");try{var t,e=await this.storageManager.loadEditorState();e?(this.isStateExpired(e.date)?(console.warn("[state] Состояние устарело, очищаем"),await this.storageManager.clearEditorState(),await this.updateMockup(),this.loadProduct(),this.initColorsList(),this.initSizesList(),this.showLayoutList(),this.updateLayouts()):await this.applyState(e)?(console.debug("[state] Состояние успешно загружено"),await this.updateMockup(),this.loadProduct(),0<this.productBlocks.length&&(this.productBlocks.forEach(t=>{t.style.background="rgb(222 222 222)"}),t=this.productBlocks.find(t=>t.classList.contains("editor-settings__product-block__"+this._selectType)))&&(t.style.background=""),await this.loadLayouts(),this.initColorsList(),this.initSizesList(),this.showLayoutList(),this.updateLayouts(),await this.saveLayouts()):(console.warn("[state] Не удалось применить сохраненное состояние"),await this.updateMockup(),this.loadProduct(),this.initColorsList(),this.initSizesList(),this.showLayoutList(),this.updateLayouts()),this.updateSum()):(console.debug("[state] Сохраненное состояние не найдено"),await this.updateMockup(),this.loadProduct(),this.initColorsList(),this.initSizesList(),this.showLayoutList(),this.updateLayouts(),this.updateSum())}catch(t){console.error("[state] Ошибка загрузки состояния:",t),await this.updateMockup(),this.loadProduct(),this.initColorsList(),this.initSizesList(),this.showLayoutList(),this.updateLayouts(),this.updateSum()}}isStateExpired(t){var t=new Date(t),e=Date.now()-24*i.STATE_EXPIRATION_DAYS*60*60*1e3;return t.getTime()<e}async applyState(e){try{if(!e.type||!e.color||!e.side)return console.warn("[state] Некорректное состояние: отсутствуют обязательные поля"),!1;console.debug(`[state] Восстановление состояния: type=${e.type}, color=${e.color}, side=${e.side}, size=`+e.size);var t,o=this.productConfigs.find(t=>t.type===e.type);return o?(t=o.mockups.find(t=>t.color.name===e.color))?(this._selectType=e.type,this._selectColor=t.color,this._selectSide=e.side,this._selectSize=e.size||this._selectSize,console.debug(`[state] Состояние применено: type=${this._selectType}, color=${this._selectColor.name}, side=${this._selectSide}, size=`+this._selectSize),!0):(console.warn(`[state] Mockup с цветом ${e.color} не найден для продукта `+e.type),!1):(console.warn(`[state] Продукт типа ${e.type} не найден`),!1)}catch(t){return console.error("[state] Ошибка применения состояния:",t),!1}}setType(t){this._selectType!==t&&(this._selectType=t,this.clearMockupCache(),this.emit(n.STATE_CHANGED,void 0),this.saveState().catch(t=>console.error("[state] Ошибка сохранения:",t)))}setColor(t){this._selectColor!==t&&(this._selectColor=t,this.clearMockupCache(),this.emit(n.STATE_CHANGED,void 0),this.saveState().catch(t=>console.error("[state] Ошибка сохранения:",t)))}setSide(t){this._selectSide!==t&&(this._selectSide=t,this.clearMockupCache(),this.emit(n.STATE_CHANGED,void 0),this.saveState().catch(t=>console.error("[state] Ошибка сохранения:",t)))}setSize(t){this._selectSize!==t&&(this._selectSize=t,this.emit(n.STATE_CHANGED,void 0),this.saveState().catch(t=>console.error("[state] Ошибка сохранения:",t)))}addLayout(t){this.isRestoringFromHistory?this.layouts.push(t):(this.layouts.push(t),this.saveLayersToHistory()),this.emit(n.LAYOUT_ADDED,t),this.updateLayouts(),this.showLayoutList(),this.saveLayouts().catch(t=>console.error("[layers] Ошибка сохранения слоёв:",t))}removeLayout(e){var t=this.layouts.findIndex(t=>t.id===e);if(-1!==t&&this.layouts[t])return this.layouts.splice(t,1),this.isRestoringFromHistory||this.saveLayersToHistory(),this.emit(n.LAYOUT_REMOVED,e),this.updateLayouts(),this.saveLayouts().catch(t=>console.error("[layers] Ошибка сохранения слоёв:",t)),!0;return!1}updateLayout(e,t){var o=this.layouts.find(t=>t.id===e);return!!o&&(Object.assign(o,t),this.isRestoringFromHistory||("url"in t||"name"in t)&&this.saveLayersToHistory(),this.emit(n.LAYOUT_UPDATED,o),this.saveLayouts().catch(t=>console.error("[layers] Ошибка сохранения слоёв:",t)),!0)}getLayout(e){return this.layouts.find(t=>t.id===e)}getLayouts(){return this.layouts}initHistoryUndoBlock(){console.debug("[history block] init undo"),this.editorHistoryUndoBlock.style.cursor="pointer",this.editorHistoryUndoBlock.onclick=async()=>{console.debug("[history undo block] clicked"),await this.undo()},this.updateHistoryButtonsState()}initHistoryRedoBlock(){console.debug("[history redo block] init redo"),this.editorHistoryRedoBlock.style.cursor="pointer",this.editorHistoryRedoBlock.onclick=async()=>{console.debug("[history redo block] clicked"),await this.redo()},this.updateHistoryButtonsState()}initProductList(){var t;this.productListBlock&&this.productItemBlock&&(console.debug("[ProductList] init product list"),this.productItemBlock.style.display="none",this.productConfigs.forEach(t=>{var e=this.productItemBlock.cloneNode(!0),o=(e.style.display="table",e.querySelector(".product-item-image")),o=(o&&(o=(0,d.getLastChild)(o))&&(o.style.backgroundImage=`url(${t.mockups[0]?.url})`,o.style.backgroundSize="cover",o.style.backgroundPosition="center",o.style.backgroundRepeat="no-repeat"),e.querySelector(".product-item-text")),o=(o&&(o=(0,d.getLastChild)(o))&&(o.innerText=t.productName),e.firstElementChild);o.classList.add("editor-settings__product-block__"+t.type),o.style.cursor="pointer",o.style.borderColor="transparent",e.onclick=()=>this.changeProduct(t.type),this.productBlocks.push(o),this.productListBlock.firstElementChild.appendChild(e)}),0<this.productBlocks.length)&&(this.productBlocks.forEach(t=>{t.style.background="rgb(222 222 222)"}),t=this.productBlocks.find(t=>t.classList.contains("editor-settings__product-block__"+this._selectType)))&&(t.style.background="")}initColorsList(){var t;this.editorColorsListBlock&&this.editorColorItemBlock&&(console.debug("[settings] init colors for "+this._selectType),t=this.getProductByType(this._selectType))&&(this.editorColorItemBlock.style.display="none",this.editorColorsListBlock.firstElementChild.innerHTML="",this.colorBlocks=[],t.mockups.filter(t=>t.side===this._selectSide).map(t=>t.color).forEach(t=>{var e=this.editorColorItemBlock.cloneNode(!0),o=(e.style.display="table",e.firstElementChild);o.classList.add("editor-settings__color-block__"+t.name),o.style.cursor="pointer",o.style.backgroundColor=t.hex,o.style.borderColor="transparent",e.onclick=()=>this.changeColor(t.name),this.colorBlocks.push(o),this.editorColorsListBlock.firstElementChild.appendChild(e)}),0<this.colorBlocks.length)&&(this.colorBlocks.forEach(t=>{t.style.borderColor="#f3f3f3"}),t=this.colorBlocks.find(t=>t.classList.contains("editor-settings__color-block__"+this._selectColor.name)))&&(t.style.borderColor="")}initSizesList(){var t;this.editorSizesListBlock&&this.editorSizeItemBlock&&(console.debug("[settings] init sizes for "+this._selectType),t=this.getProductByType(this._selectType))&&t.sizes&&(this.editorSizeItemBlock.style.display="none",this.editorSizesListBlock.firstElementChild.innerHTML="",this.sizeBlocks=[],t.sizes.forEach(t=>{var e=this.editorSizeItemBlock.cloneNode(!0);e.style.display="table",e.style.cursor="pointer",e.style.userSelect="none",e.classList.add("editor-settings__size-block__"+t);e.firstElementChild.style.borderColor="#f3f3f3";var o=(0,d.getLastChild)(e);o&&(o.innerText=t),e.onclick=()=>this.changeSize(t),this.sizeBlocks.push(e),this.editorSizesListBlock.firstElementChild.appendChild(e)}),0<this.sizeBlocks.length)&&(this.sizeBlocks.forEach(t=>{t=t.firstElementChild;t&&(t.style.borderColor="#f3f3f3")}),t=this.sizeBlocks.find(t=>t.classList.contains("editor-settings__size-block__"+this._selectSize)))&&(t=t.firstElementChild)&&(t.style.borderColor="")}showLayoutList(){console.debug("[settings] [layouts] show layouts list"),this.editorLayoutItemBlock?this.editorLayoutsListBlock?(this.editorLayoutItemBlock.style.display="none",this.editorLayoutsListBlock.firstElementChild.innerHTML="",console.debug("[settings] [layouts] layouts list block children: "+this.editorLayoutsListBlock.firstElementChild.children.length),this.layouts.forEach(t=>{var e=this.editorLayoutItemBlock.cloneNode(!0);e.style.display="table";let o=this._selectLayout===t.id;var i=this.editorLayoutItemBlockViewClass?e.querySelector(this.editorLayoutItemBlockViewClass):null,s=this.editorLayoutItemBlockNameClass?e.querySelector(this.editorLayoutItemBlockNameClass):null,a=this.editorLayoutItemBlockRemoveClass?e.querySelector(this.editorLayoutItemBlockRemoveClass):null,r=this.editorLayoutItemBlockEditClass?e.querySelector(this.editorLayoutItemBlockEditClass):null;i&&(t.isImageLayout()?((i=i.firstElementChild)&&(i.style.backgroundImage=`url(${t.url})`,i.style.backgroundSize="contain",i.style.backgroundPosition="center",i.style.backgroundRepeat="no-repeat"),o?i.style.borderColor="rgb(254, 94, 58)":i.style.borderColor=""):t.type),s&&(i=s.firstElementChild)&&("image"===t.type?(s=t.name?t.name.includes("\n")?t.name.split("\n")[0]+"...":40<t.name.length?t.name.slice(0,40)+"...":t.name:"Изображение",i.innerText=s):"text"===t.type&&(i.innerText=t.name||"Текст")),a&&(a.style.cursor="pointer",a.onclick=()=>{this.removeLayout(t.id),this.showLayoutList(),o&&this.cancelEditLayout()},this.restoreIconFromDataOriginal(a.firstElementChild)),r&&(o||"start"===t.id?r.style.display="none":r.style.display="table",r.style.cursor="pointer",r.onclick=()=>this.editLayout(t),this.restoreIconFromDataOriginal((0,d.getLastChild)(r))),this.editorLayoutsListBlock.firstElementChild.appendChild(e)}),this.updateSum(),console.debug("[settings] [layouts] layouts shown: "+this.editorLayoutsListBlock.firstElementChild.children.length)):console.error("[settings] [layouts] editorLayoutsListBlock is not initialized"):console.error("[settings] [layouts] editorLayoutItemBlock is not initialized")}initAddOrderButton(){this.editorAddOrderButton&&(this.editorAddOrderButton.style.cursor="pointer",this.events.on(n.MOCKUP_LOADING,t=>{this.editorAddOrderButton&&(t?(this.editorAddOrderButton.style.opacity="0.5",this.editorAddOrderButton.style.cursor="not-allowed",this.editorAddOrderButton.style.pointerEvents="none",console.debug("[order] Кнопка заблокирована (идет генерация)")):(this.editorAddOrderButton.style.opacity="1",this.editorAddOrderButton.style.cursor="pointer",this.editorAddOrderButton.style.pointerEvents="auto",console.debug("[order] Кнопка разблокирована")))}),this.editorAddOrderButton.onclick=async()=>{if(this.isAddingToCart)console.warn("[order] Процесс добавления уже идет, игнорируем повторное нажатие");else if(0===this.getSum())alert("Для добавления заказа продукт не может быть пустым");else if(0===this.layouts.length)alert("Пожалуйста, дождитесь завершения генерации дизайна"),console.warn("[order] Попытка добавить в корзину без дизайна");else{let t=this.editorAddOrderButton?.querySelector(".tn-atom"),o=(t=t||this.editorAddOrderButton?.querySelector("div, span"))?.textContent?.trim()||"Добавить в корзину";try{this.isAddingToCart=!0,this.setAddToCartButtonLoading(!0,"Добавление...");var i,s,a,r,n,l,d=Math.floor(Math.random()*(99e6+1))+999999;console.debug("[order] Начало создания заказа");let e=await this.exportArt(!0,512);console.debug("[order] Экспорт дизайна завершен:",Object.keys(e)),0===Object.keys(e).length?(alert("Ошибка: не удалось экспортировать дизайн. Попробуйте еще раз."),console.error("[order] Экспорт вернул пустой результат")):(i=Object.keys(e).map(t=>({image_url:e[t]||""})),s=(console.debug("[order] Загрузка изображений на сервер..."),i.map(async t=>{var e=t.image_url.split(",")[1];return{side:t,uploadedUrl:await this.uploadImageToServer(e)}})),a=((await Promise.all(s)).forEach(({side:t,uploadedUrl:e})=>{t.image_url=e}),console.debug("[order] Изображения загружены на сервер"),`${this.capitalizeFirstLetter(this.getProductName())} с вашим ${1==Object.keys(e).length?"односторонним":"двухсторонним"} принтом`),r=this.layouts.map(t=>({...t,url:void 0})),n=await this.storageManager.getUserId(),(l=new FormData).append("layouts",JSON.stringify(r)),l.append("user_id",n),l.append("art",d.toString()),await fetch(this.apiConfig.webhookCart,{method:"POST",body:l}),(0,c.createProduct)({quantity:this.getQuantity(),name:a,size:this._selectSize,color:this._selectColor,sides:i,article:d,price:this.getSum()}),this.isAddedToCart=!0,console.debug("[order] Заказ успешно создан"),this.setAddToCartButtonLoading(!1,"✓ Добавлено!"),setTimeout(()=>{this.setAddToCartButtonLoading(!1,o)},2e3))}catch(t){console.error("[order] Ошибка создания заказа:",t),alert("Ошибка при создании заказа"),this.setAddToCartButtonLoading(!1,o)}finally{setTimeout(()=>{this.isAddingToCart=!1,console.debug("[order] Флаг isAddingToCart сброшен")},2e3)}}})}setAddToCartButtonLoading(e,o){if(this.editorAddOrderButton){this.injectPulseAnimation();var i=this.editorAddOrderButton;let t=i.querySelector(".tn-atom");var s=(t=t||i.querySelector("div, span"))||i;e?(i.style.opacity="0.7",i.style.cursor="not-allowed",i.style.pointerEvents="none",o&&(s.textContent=o),i.style.animation="cartButtonPulse 1.5s ease-in-out infinite",console.debug("[order] [animation] Кнопка заблокирована:",o)):(i.style.opacity="1",i.style.cursor="pointer",i.style.pointerEvents="auto",i.style.animation="none",o&&(s.textContent=o),console.debug("[order] [animation] Кнопка разблокирована:",o))}}injectPulseAnimation(){var t;document.getElementById("cart-button-pulse-animation")||((t=document.createElement("style")).id="cart-button-pulse-animation",t.textContent=`
            @keyframes cartButtonPulse {
                0%, 100% {
                    transform: scale(1);
                    opacity: 0.7;
                }
                50% {
                    transform: scale(1.02);
                    opacity: 0.85;
                }
            }
        `,document.head.appendChild(t),console.debug("[animation] CSS анимация пульсации добавлена"))}setGenerateButtonLoading(e,o){if(this.formButton){this.injectPulseAnimation();var i=this.formButton;let t=i.querySelector(".tn-atom");var s=(t=t||i.querySelector("div, span"))||i;e?(i.style.opacity="0.7",i.style.cursor="not-allowed",i.style.pointerEvents="none",o&&(s.textContent=o),i.style.animation="cartButtonPulse 1.5s ease-in-out infinite",console.debug("[generate] [animation] Кнопка заблокирована:",o)):(i.style.opacity="1",i.style.cursor="pointer",i.style.pointerEvents="auto",i.style.animation="none",o&&(s.textContent=o),console.debug("[generate] [animation] Кнопка разблокирована:",o))}}setControlsDisabled(t){let e=t?"0.5":"1",o=t?"none":"auto",i=t?"not-allowed":"pointer";this.changeSideButton&&(this.changeSideButton.style.opacity=e,this.changeSideButton.style.pointerEvents=o,this.changeSideButton.style.cursor=i),this.colorBlocks.forEach(t=>{t=t.parentElement;t&&(t.style.opacity=e,t.style.pointerEvents=o,t.style.cursor=i)}),this.productBlocks.forEach(t=>{t=t.parentElement;t&&(t.style.opacity=e,t.style.pointerEvents=o,t.style.cursor=i)}),console.debug("[controls] Элементы управления "+(t?"заблокированы":"разблокированы"))}initUploadImageButton(){this.editorUploadImageButton&&(this.resetUserUploadImage(),this.editorUploadImageButton.style.cursor="pointer",this.editorUploadImageButton.addEventListener("click",()=>{this.uploadUserImage()}))}initFixQuantityForm(){if(this.quantityFormBlock){var t;let e=this.quantityFormBlock.querySelector("form")?.querySelector('input[name="quantity"]');e&&(t=()=>{var t=e.value.trim();(""===t||isNaN(Number(t))||(t=parseInt(t,10))<1||0===t)&&(e.value="1")},e.addEventListener("input",t),e.addEventListener("blur",t),e.addEventListener("change",t),t())}}async initForm(){if(this.formBlock&&this.formButton&&this.formInputVariableName){let r=this.formBlock,e=this.formInputVariableName;var t=this.formButton;let o=async()=>{if(console.debug("[form] [button] clicked"),this.isGenerating)console.warn("[form] Генерация уже идет, игнорируем повторное нажатие");else{var t=r.querySelector(`[name="${e}"]`),o=t.value;if(this.loadedUserImage||o&&""!==o.trim()&&!(o.length<1)){console.debug("[form] [input] prompt: "+o),this.isGenerating=!0,this.setGenerateButtonLoading(!0,"Генерация..."),this.setControlsDisabled(!0),this.emit(n.MOCKUP_LOADING,!0);let e=this._selectLayout||l.Layout.generateId();try{var i=await(0,c.generateImage)({uri:this.apiConfig.webhookRequest,prompt:o,shirtColor:this._selectColor.name,image:!this._selectLayout||this.loadedUserImage!==this.layouts.find(t=>t.id===this._selectLayout)?.url?this.loadedUserImage:null,withAi:this.editorLoadWithAi,layoutId:e,isNew:!this._selectLayout,background:!this.editorRemoveBackground});try{window.ym(103279214,"reachGoal","generated")}catch(t){}this.emit(n.MOCKUP_LOADING,!1);var s,a=await this.getImageData(i);console.debug("[form] [input] image data received"),this._selectLayout?(s=this.layouts.find(t=>t.id===e))&&s.isImageLayout()&&(console.debug("[form] [input] updating layout: "+s.id),s.name=o,s.url=a,console.debug("[form] [input] layout updated"),this.showLayoutList(),this.updateLayouts(),this.saveState()):this.addLayout(l.Layout.createImage({id:e,view:this._selectSide,url:a,name:o,position:{x:0,y:0}})),t.style.borderColor="#f3f3f3",this._selectLayout=null,t.value="",this.cancelEditLayout(),this.resetUserUploadImage(),this.showLayoutList(),this.setGenerateButtonLoading(!1,"✓ Готово!"),this.setControlsDisabled(!1),setTimeout(()=>{this.setGenerateButtonLoading(!1,"Сгенерировать"),this.isGenerating=!1,console.debug("[form] Флаг isGenerating сброшен")},2e3)}catch(t){try{window.OpenReplay.issue("generate",{uri:this.apiConfig.webhookRequest,prompt:o,shirtColor:this._selectColor.name,image:!this._selectLayout||this.loadedUserImage!==this.layouts.find(t=>t.id===this._selectLayout)?.url?this.loadedUserImage:null,withAi:this.editorLoadWithAi,layoutId:e,isNew:!this._selectLayout,background:!this.editorRemoveBackground})}catch(t){console.error("Ошибка установки ID пользователя в tracker:",t)}this.emit(n.MOCKUP_LOADING,!1),console.error("[form] [input] error",t),alert("Ошибка при генерации изображения"),this.setGenerateButtonLoading(!1,"Сгенерировать"),this.setControlsDisabled(!1),this.isGenerating=!1}finally{this.loadedUserImage&&this.resetUserUploadImage(),this._selectLayout&&(this._selectLayout=null,this.cancelEditLayout())}}else console.warn("[form] [input] prompt is empty or too short"),alert("Минимальная длина запроса 1 символ")}};var i=await new Promise(e=>{let o=setInterval(()=>{var t=r.querySelector("form");t&&(clearInterval(o),e(t))},100);setTimeout(()=>{clearInterval(o),e(null)},1e4)});i?(i.action="",i.method="GET",i.onsubmit=t=>{t.preventDefault(),o()},(i=i.querySelector(`textarea[name='${e}']`))&&(i.style.padding="8px"),t.onclick=o,t.style.cursor="pointer",console.debug("[form] Инициализация формы завершена")):console.warn("[form] form not found")}}restoreIconFromDataOriginal(t){var e;t&&(e=t.attributes.getNamedItem("data-original")?.value)&&(t.style.backgroundImage=`url("${e}")`)}changeProduct(t){var e;this.isGenerating?console.warn("[changeProduct] Генерация в процессе, переключение заблокировано"):(this._selectType=t,this.clearMockupCache(),(e=this.getProductByType(t))&&!e.mockups.find(t=>t.side===this._selectSide&&t.color.name===this._selectColor.name)&&(e=e.mockups.find(t=>t.side===this._selectSide))&&(this._selectColor=e.color,console.debug(`[product] Цвет изменен на ${this._selectColor.name} для продукта `+t)),this.updateProductBlocksUI(),this.updateMockup(),this.loadProduct(),this.showLayoutList(),this.updateLayouts(),this.updateSum(),this.saveState())}updateProductBlocksUI(){var t;0!==this.productBlocks.length&&(this.productBlocks.forEach(t=>{t.style.background="rgb(222 222 222)"}),t=this.productBlocks.find(t=>t.classList.contains("editor-settings__product-block__"+this._selectType)))&&(t.style.background="")}changeSide(){var t;this.isGenerating?console.warn("[changeSide] Генерация в процессе, переключение заблокировано"):(t="front"===this._selectSide?"back":"front",this.setActiveSide(t),this.updateMockup(),this.showLayoutList(),this.updateLayouts(),this.saveState(),this.emit(n.STATE_CHANGED,void 0))}changeColor(e){var t;this.isGenerating?console.warn("[changeColor] Генерация в процессе, переключение заблокировано"):(t=this.getProductByType(this._selectType))&&(t=t.mockups.find(t=>t.color.name===e))&&(this._selectColor=t.color,this.clearMockupCache(),this.updateColorBlocksUI(e),this.updateMockup(),this.saveState())}updateColorBlocksUI(e){var t;0!==this.colorBlocks.length&&(this.colorBlocks.forEach(t=>{t.style.borderColor="#f3f3f3"}),t=this.colorBlocks.find(t=>t.classList.contains("editor-settings__color-block__"+e)))&&(t.style.borderColor="")}changeSize(t){this.updateSizeBlocksUI(t),this._selectSize=t,this.saveState()}updateSizeBlocksUI(e){var t,o;0!==this.sizeBlocks.length&&(this.sizeBlocks.forEach(t=>{t=t.firstElementChild;t&&(t.style.borderColor="#f3f3f3")}),t=this.sizeBlocks.find(t=>t.classList.contains("editor-settings__size-block__"+e)))&&(o=t.firstElementChild)&&(o.style.borderColor="")}editLayout(t){var e;console.debug("[settings] [layouts] edit layout "+t.id),this._selectLayout=t.id,this.formBlock&&this.formInputVariableName&&((e=this.formBlock.querySelector(`[name="${this.formInputVariableName}"]`))?(e.value=t.name||"",e.style.borderColor="rgb(254, 94, 58)",e.focus(),console.debug(`[settings] [layouts] Установлено значение в форму: "${t.name}"`)):console.warn(`[settings] [layouts] Не найден элемент формы с именем "${this.formInputVariableName}"`)),t.isImageLayout()?(this.loadedUserImage=t.url,this.setUserUploadImage(t.url),this.initAiButtons(),this.hideAiButtons()):(this.loadedUserImage=null,this.resetUserUploadImage()),this.showLayoutList()}cancelEditLayout(){var t;console.debug("[settings] [layouts] cancel edit layout"),this._selectLayout=null,this.formBlock&&this.formInputVariableName&&(t=this.formBlock.querySelector(`[name="${this.formInputVariableName}"]`))&&(t.value="",t.style.borderColor="#f3f3f3"),this.loadedUserImage=null,this.editorLoadWithAi=!1,this.showLayoutList(),console.debug("[settings] [layouts] Редактирование отменено")}initAiButtons(){this.editorLoadWithAi=!1,this.editorRemoveBackground=!1,this.changeLoadWithAi(),this.changeRemoveBackground(),this.editorLoadWithAiButton&&(this.editorLoadWithAiButton.style.cursor="pointer",this.editorLoadWithAiButton.onclick=()=>{this.changeLoadWithAi(!0)}),this.editorLoadWithoutAiButton&&(this.editorLoadWithoutAiButton.style.cursor="pointer",this.editorLoadWithoutAiButton.onclick=()=>{this.changeLoadWithAi(!1)}),this.editorRemoveBackgroundButton&&(this.editorRemoveBackgroundButton.style.cursor="pointer",this.editorRemoveBackgroundButton.onclick=()=>{this.changeRemoveBackground(!this.editorRemoveBackground)})}hideAiButtons(){this.editorLoadWithAi=!0,this.editorLoadWithAiButton&&((this.editorLoadWithAiButton.parentElement?.parentElement?.parentElement).style.display="none")}showAiButtons(){this.editorLoadWithAiButton&&((this.editorLoadWithAiButton.parentElement?.parentElement?.parentElement).style.display="flex")}uploadUserImage(){console.debug("[upload user image] starting user image upload"),this.showAiButtons();var t=document.createElement("input");t.type="file",t.accept="image/*",t.style.display="none",t.onchange=t=>{var e,t=t.target.files?.[0];t&&(console.debug("[upload user image] file selected:",t.name),t.type.startsWith("image/")?((e=new FileReader).onload=async t=>{t=t.target?.result,console.debug("[upload user image] file loaded as data URL"),t=await this.getImageData(t);this.setUserUploadImage(t),console.debug("[upload user image] image layout added successfully")},e.onerror=()=>{console.error("[upload user image] error reading file"),alert("Ошибка при загрузке файла")},e.readAsDataURL(t)):(console.warn("[upload user image] selected file is not an image"),alert("Пожалуйста, выберите файл изображения")))},document.body.appendChild(t),t.click(),document.body.removeChild(t)}setUserUploadImage(t){var e;this.loadedUserImage=t,this.editorUploadViewBlock&&(this.editorUploadViewBlock.style.display="table",e=(0,d.getLastChild)(this.editorUploadViewBlock))&&(e.style.backgroundImage=`url(${t})`,e.style.backgroundSize="contain",e.style.backgroundPosition="center",e.style.backgroundRepeat="no-repeat")}resetUserUploadImage(){this.editorUploadViewBlock&&(this.editorUploadViewBlock.style.display="none"),this.loadedUserImage=null,this.cancelEditLayout()}changeLoadWithAi(t=!1){var e,o,i;console.debug("[ai buttons] changeLoadWithAi вызван, value="+t),this.editorLoadWithAi=t,this.editorLoadWithAiButton&&this.editorLoadWithoutAiButton&&(e=this.editorLoadWithAiButton,o=this.editorLoadWithoutAiButton,t?(t=e.firstElementChild,i=o.firstElementChild,t&&(t.style.borderColor="",console.debug("[ai buttons] С ИИ: сброшен borderColor (оранжевый)")),i&&(i.style.borderColor="#f2f2f2",console.debug("[ai buttons] Без ИИ: установлен borderColor=#f2f2f2 (серый)"))):(t=e.firstElementChild,i=o.firstElementChild,t&&(t.style.borderColor="#f2f2f2",console.debug("[ai buttons] С ИИ: установлен borderColor=#f2f2f2 (серый)")),i&&(i.style.borderColor="",console.debug("[ai buttons] Без ИИ: сброшен borderColor (оранжевый)")))),this.updateRemoveBackgroundVisibility()}changeRemoveBackground(t=!1){var e;console.debug("[remove bg button] changeRemoveBackground вызван, value="+t),this.editorRemoveBackground=t,this.editorRemoveBackgroundButton&&(e=this.editorRemoveBackgroundButton.firstElementChild)&&(t?(e.style.borderColor="",console.debug("[remove bg button] Убрать фон: сброшен borderColor (оранжевый)")):(e.style.borderColor="#f2f2f2",console.debug("[remove bg button] Убрать фон: установлен borderColor=#f2f2f2 (серый)")))}updateRemoveBackgroundVisibility(){var t;this.editorRemoveBackgroundButton&&(t=this.editorRemoveBackgroundButton.parentElement)&&(this.editorLoadWithAi?(t.style.display="none",this.changeRemoveBackground(!1),console.debug("[remove bg button] Кнопка скрыта (С ИИ выбрано)")):(t.style.display="",console.debug("[remove bg button] Кнопка показана (Без ИИ выбрано)")))}loadImage(i){return new Promise((t,e)=>{let o=new Image;o.crossOrigin="anonymous",o.onload=()=>t(o),o.onerror=e,o.src=i})}getQuantity(){var t;return this.quantityFormBlock&&(t=this.quantityFormBlock.querySelector("form")?.querySelector('input[name="quantity"]'))&&parseInt(t.value)||1}getSum(){var t=this.layouts.some(t=>"front"===t.view),e=this.layouts.some(t=>"back"===t.view),o=this.getProductByType(this._selectType);return o?e&&t?o.doubleSidedPrice:o.price:0}updateSum(){var t,e;this.editorSumBlock&&(t=this.getSum(),(e=(0,d.getLastChild)(this.editorSumBlock))&&(e.innerText=t.toString()+" ₽"),this.editorAddOrderButton)&&(e=(0,d.getLastChild)(this.editorAddOrderButton))&&(e.style.backgroundColor=0===t?"rgb(121 121 121)":"")}loadProduct(){var t=this.getProductByType(this._selectType);if(t&&t.printConfig){this.clearAllCanvas();for(var e of t.printConfig)this.createCanvasForSide(e);this.setActiveSide(this._selectSide),setTimeout(()=>{this.isLoading=!1,this.emit(n.MOCKUP_LOADING,!1)},100)}else console.warn("[product] product or printConfig not found")}clearAllCanvas(){this.canvasesContainer&&(this.canvasesContainer.innerHTML=""),this.canvases.forEach(t=>{try{t.dispose()}catch(t){console.error("[canvas] Ошибка очистки canvas:",t)}}),this.canvases=[],this.layersCanvases=[],this.activeCanvas=null}handleWindowResize(){console.debug("[canvas] Изменение размера окна");let e=this.editorBlock.clientWidth,o=this.editorBlock.clientHeight;this.canvases.forEach(t=>{t.setWidth(e),t.setHeight(o)}),this.layersCanvases.forEach(t=>{t.setWidth(e),t.setHeight(o)});var t=this.getProductByType(this._selectType);t&&t.printConfig.forEach(e=>{var t=this.canvases.find(t=>t.side===e.side);t&&this.updatePrintArea(t,e)}),this.canvases.forEach(e=>{let o=e.side;var t=e.getObjects();let i=[];t.forEach(t=>{"area:border"===t.name||"area:clip"===t.name||t.name?.startsWith("guideline")||i.push(t)}),i.forEach(t=>e.remove(t)),console.debug(`[canvas] Удалено ${i.length} объектов для перерисовки на стороне `+o),this.layouts.filter(t=>t.view===o).forEach(t=>{this.addLayoutToCanvas(t)}),e.requestRenderAll()}),console.debug("[canvas] Размер изменен:",{width:e,height:o})}updatePrintArea(t,e){var o=e.size.width/600*this.editorBlock.clientWidth,i=e.size.height/600*this.editorBlock.clientHeight,s=(this.editorBlock.clientWidth-o)/2+e.position.x/100*this.editorBlock.clientWidth,e=(this.editorBlock.clientHeight-i)/2+e.position.y/100*this.editorBlock.clientHeight,a=t.clipPath,a=(a&&a.set({width:o,height:i,left:s,top:e}),this.getObject("area:border",t));a&&a.set({width:o-3,height:i-3,left:s,top:e}),t.requestRenderAll()}createCanvasForSide(t){var e,o;this.canvasesContainer?((e=document.createElement("canvas")).id="layers--"+t.side,e.classList.add("editor-position"),e.setAttribute("ref",t.side),e.style.zIndex="7",this.canvasesContainer.appendChild(e),(e=new fabric.StaticCanvas(e,{width:this.editorBlock.clientWidth,height:this.editorBlock.clientHeight})).side=t.side,e.name="static-"+t.side,(o=document.createElement("canvas")).id="editable--"+t.side,o.setAttribute("ref",t.side),o.classList.add("editor-position"),o.style.zIndex="9",this.canvasesContainer.appendChild(o),(o=new fabric.Canvas(o,{controlsAboveOverlay:!0,width:this.editorBlock.clientWidth,height:this.editorBlock.clientHeight,backgroundColor:"transparent",uniformScaling:!0})).side=t.side,o.name="editable-"+t.side,this.layersCanvases.push(e),this.canvases.push(o),1===this.canvases.length&&(this.activeCanvas=o),this.initMainCanvas(o,t)):console.error("[canvas] canvasesContainer не инициализирован")}initMainCanvas(t,e){var o,i,s,a,r;t&&t instanceof fabric.Canvas?(r=e.size.width/600*this.editorBlock.clientWidth,o=e.size.height/600*this.editorBlock.clientHeight,i=(this.editorBlock.clientWidth-r)/2+e.position.x/100*this.editorBlock.clientWidth,s=(this.editorBlock.clientHeight-o)/2+e.position.y/100*this.editorBlock.clientHeight,a=new fabric.Rect({width:r,height:o,left:i,top:s,fill:"rgb(255, 0, 0)",name:"area:clip",evented:!1}),r=new fabric.Rect({width:r-3,height:o-3,left:i,top:s,fill:"rgba(0,0,0,0)",strokeWidth:3,stroke:"rgb(254, 94, 58)",name:"area:border",opacity:.3,evented:!1,selectable:!1,hasControls:!1,strokeDashArray:[5,5]}),t.add(r),t.clipPath=a,this.setupCanvasEventHandlers(t,e)):console.warn("[canvas] canvas не валиден")}setupCanvasEventHandlers(e,o){e.on("mouse:down",()=>{var t=this.getObject("area:border",e);t&&(t.set("opacity",.8),e.requestRenderAll())}),e.on("mouse:up",()=>{var t=this.getObject("area:border",e);t&&(t.set("opacity",.3),e.requestRenderAll())}),e.on("object:rotating",t=>{if(void 0!==t.target?.angle){var e,o=t.target.angle%360;for(e of[0,90,180,270])Math.abs(o-e)<5&&t.target.rotate(e)}}),e.on("object:moving",t=>{this.handleObjectMoving(t,e,o)}),e.on("object:modified",t=>{this.handleObjectModified(t,e,o)})}handleObjectMoving(e,t,o){var i,s,a,r,n,l;e.target&&"area:border"!==e.target.name&&"area:clip"!==e.target.name&&(r=this.layouts.find(t=>t.id===e.target.name))&&(i=this.getProductByType(this._selectType))&&(r=(0,h.calculateLayoutDimensions)(r,i,this.editorBlock.clientWidth,this.editorBlock.clientHeight),i=e.target.width*e.target.scaleX,s=e.target.height*e.target.scaleY,n=e.target.left+i/2,l=e.target.top+s/2,a=r.printAreaLeft+r.printAreaWidth/2,r=r.printAreaTop+r.printAreaHeight/2,n=Math.abs(n-a)<7,l=Math.abs(l-r)<7,n?(this.showGuideline(t,"vertical",a,0,a,this.editorBlock.clientHeight),e.target.set({left:a-i/2})):this.hideGuideline(t,"vertical"),l?(this.showGuideline(t,"horizontal",0,r,this.editorBlock.clientWidth,r),e.target.set({top:r-s/2})):this.hideGuideline(t,"horizontal"))}handleObjectModified(t,e,o){let i=t.target;var s;i&&(this.hideGuideline(e,"vertical"),this.hideGuideline(e,"horizontal"),t=this.layouts.find(t=>t.id===i.name))&&(e=this.getProductByType(this._selectType))&&(e=(0,h.calculateLayoutDimensions)(t,e,this.editorBlock.clientWidth,this.editorBlock.clientHeight),t.position.x=(i.left-e.printAreaLeft)/e.printAreaWidth,t.position.y=(i.top-e.printAreaTop)/e.printAreaHeight,t.size=i.scaleX,t.aspectRatio=i.scaleY/i.scaleX,t.angle=i.angle,s=i.width*i.scaleX,t._relativeWidth=s=s/e.printAreaWidth,console.debug(`[canvas] Layout ${t.id} updated: position=(${t.position.x.toFixed(3)}, ${t.position.y.toFixed(3)}), size=${t.size.toFixed(3)}, relativeWidth=`+s.toFixed(3)),this.saveLayouts().catch(t=>console.error("[layers] Ошибка сохранения слоёв:",t)))}showGuideline(t,e,o,i,s,a){e="guideline:"+e;this.getObject(e,t)||(o=new fabric.Line([o,i,s,a],{stroke:"rgb(254, 94, 58)",strokeWidth:2,strokeDashArray:[5,5],selectable:!1,evented:!1,name:e}))&&t.add(o)}hideGuideline(t,e){e=this.getObject("guideline:"+e,t);e&&t.remove(e)}getObject(e,t){t=t||this.activeCanvas||this.canvases[0];if(t)return t.getObjects().find(t=>t.name===e)}setActiveSide(i){console.debug("[canvas] Установка активной стороны:",i),this.canvases.forEach(t=>{var e=t.getElement(),o=e.parentElement;t.side===i?(this.activeCanvas=t,o&&(o.style.pointerEvents="auto",o.style.display="block"),e.style.display="block"):(o&&(o.style.pointerEvents="none",o.style.display="none"),e.style.display="none")}),this.layersCanvases.forEach(t=>{t.getElement().style.display=t.side===i?"block":"none"}),this._selectSide=i}async addLayoutToCanvas(e){var t,o=this.canvases.find(t=>t.side===e.view);o?(t=this.getProductByType(this._selectType))&&(t=await(0,h.renderLayout)({layout:e,product:t,containerWidth:this.editorBlock.clientWidth,containerHeight:this.editorBlock.clientHeight,loadImage:this.loadImage.bind(this)}))&&o.add(t):console.warn(`[canvas] canvas для ${e.view} не найден`)}updateLayouts(){this.activeCanvas&&this.updateLayoutsForSide(this._selectSide)}updateLayoutsForSide(e){let a=this.canvases.find(t=>t.side===e);if(a){let o=a.getObjects();o.filter(t=>"area:border"!==t.name&&"area:clip"!==t.name&&!t.name?.startsWith("guideline")).filter(e=>!this.layouts.find(t=>t.id===e.name)).forEach(t=>{a.remove(t)});var t=this.layouts.filter(t=>t.view===e);let i=[],s=[];t.forEach(e=>{var t=o.find(t=>t.name===e.id);t?e.isImageLayout()&&t.layoutUrl!==e.url&&(console.debug(`[canvas] Layout ${e.id} изменился, требуется обновление`),i.push(e)):s.push(e)}),i.forEach(e=>{var t=o.find(t=>t.name===e.id);t&&(console.debug("[canvas] Удаляем старый объект для обновления: "+e.id),a.remove(t)),console.debug("[canvas] Добавляем обновленный объект: "+e.id),this.addLayoutToCanvas(e)}),s.forEach(t=>{this.addLayoutToCanvas(t)}),a.renderAll()}}async preloadAllMockups(){console.debug("[preload] Начало предзагрузки mockups");for(var t of this.productConfigs)for(var e of t.mockups)try{var o=await this.getImageData(e.url);e.url=o,console.debug("[preload] Mockup загружен: "+e.color.name)}catch(t){console.error(`[preload] Ошибка загрузки mockup ${e.url}:`,t)}console.debug("[preload] Предзагрузка завершена")}async getImageData(t){return this.loadAndConvertImage(t)}async uploadImage(a){return console.debug("[upload] Загрузка файла:",a.name),new Promise((i,s)=>{var t=new FileReader;t.onload=async t=>{try{var e=t.target?.result,o=await this.getImageData(e);console.debug("[upload] Файл успешно загружен"),i(o)}catch(t){try{window.OpenReplay.issue("load-file",a.name)}catch(t){console.error("Ошибка установки ID пользователя в tracker:",t)}console.error("[upload] Ошибка обработки файла:",t),s(t)}},t.onerror=()=>{console.error("[upload] Ошибка чтения файла"),s(new Error("Не удалось прочитать файл"))},t.readAsDataURL(a)})}async uploadImageToServer(t){console.debug("[upload] Загрузка изображения на сервер");var e=await this.storageManager.getUserId(),t=await(await fetch(this.apiConfig.uploadImage,{method:"POST",body:JSON.stringify({image:t,user_id:e}),headers:{"Content-Type":"application/json"}})).json();return console.debug("[upload] Изображение загружено на сервер:",t.image_url),t.image_url}getProductName(){return this.getProductByType(this._selectType)?.productName||""}capitalizeFirstLetter(t){return t.charAt(0).toUpperCase()+t.slice(1)}getMockupUrl(e){var t=this.getProductByType(this._selectType);return(t=t&&t.mockups.find(t=>t.side===e&&t.color.name===this._selectColor.name))?t.url:null}async exportArt(o=!0,i=1024){let e={};var t=this.getSidesWithLayers(),t=(console.debug("[export] Найдены стороны с слоями:",t,"(front первый)",o?"с мокапом":"без мокапа",`разрешение: ${i}px`),t.map(async e=>{try{var t=await this.exportSide(e,o,i);if(t)return console.debug(`[export] Сторона ${e} успешно экспортирована`),{side:e,data:t}}catch(t){console.error(`[export] Ошибка при экспорте стороны ${e}:`,t)}return null}));return(await Promise.all(t)).forEach(t=>{t&&(e[t.side]=t.data)}),console.debug(`[export] Экспорт завершен для ${Object.keys(e).length} сторон`),e}getSidesWithLayers(){return[...new Set(this.layouts.map(t=>t.view))].sort((t,e)=>"front"===t?-1:"front"===e?1:0)}async exportSide(e,t=!0,o=1024){var i,s,a,r,n,l,d,c=this.getCanvasesForSide(e);return c.editableCanvas?(this.updateLayoutsForSide(e),console.debug(`[export] Экспортируем сторону ${e}${t?" с мокапом":" без мокапа"} (${o}px)...`),t?(t=await this.loadMockupForSide(e))?(d=this.getProductByType(this._selectType)?.printConfig.find(t=>t.side===e))?({canvas:t,ctx:i,mockupDimensions:s}=this.createExportCanvas(o,t),a=await this.exportDesignWithClipPath(c.editableCanvas,c.layersCanvas,e,o),r=d.size.width/600*s.width,n=d.size.height/600*s.height,l=s.x+(s.width-r)/2+d.position.x/100*s.width,d=s.y+(s.height-n)/2+d.position.y/100*s.height,i.drawImage(a,0,0,a.width,a.height,l,d,r,n),console.debug(`[export] Наложен обрезанный дизайн (clipPath) на мокап для ${e} в области печати (${Math.round(l)}, ${Math.round(d)}, ${Math.round(r)}x${Math.round(n)})`),t.toDataURL("image/png",1)):(console.warn("[export] Не найдена конфигурация печати для "+e),null):null:(s=await this.exportDesignWithClipPath(c.editableCanvas,c.layersCanvas,e,o),console.debug(`[export] Экспортирован чистый дизайн для ${e} (обрезан по clipPath)`),s.toDataURL("image/png",1))):(console.warn(`[export] Canvas для стороны ${e} не найден`),null)}getCanvasesForSide(e){return{editableCanvas:this.canvases.find(t=>t.side===e),layersCanvas:this.layersCanvases.find(t=>t.side===e)}}async loadMockupForSide(t){var e,o=this.getMockupUrl(t);return o?(e=await this.loadImage(o),console.debug(`[export] Загружен мокап для ${t}: `+o),e):(console.warn(`[export] Мокап для стороны ${t} не найден`),null)}createExportCanvas(t,e){var o=document.createElement("canvas"),i=o.getContext("2d"),s=(o.width=t,o.height=t,Math.min(t/e.width,t/e.height)),a=e.width*s,s=e.height*s,r=(t-a)/2,t=(t-s)/2;return i.drawImage(e,r,t,a,s),console.debug(`[export] Нарисован мокап как фон (${a}x${s})`),{canvas:o,ctx:i,mockupDimensions:{x:r,y:t,width:a,height:s}}}async createDesignCanvas(t,e,o){var i=t.getWidth(),s=t.getHeight(),a=document.createElement("canvas"),r=a.getContext("2d");return a.width=10*i,a.height=10*s,await this.addStaticLayersToCanvas(e,r,a,o),await this.addEditableObjectsToCanvas(t,r,a,i,s,o),a}async addStaticLayersToCanvas(t,e,o,i){if(t)try{var s,a=t.toDataURL({format:"png",multiplier:10,quality:1}),r="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==";a!==r&&a.length>r.length&&(s=await this.loadImage(a),e.drawImage(s,0,0,o.width,o.height),console.debug("[export] Добавлены статические слои для "+i))}catch(t){console.warn(`[export] Ошибка экспорта статических слоев для ${i}:`,t)}}async addEditableObjectsToCanvas(t,e,o,i,s,a){try{var r,n=new fabric.StaticCanvas(null,{width:i,height:s,backgroundColor:"transparent"}),l=(t.clipPath&&(r=await new Promise(e=>{t.clipPath.clone(t=>e(t))}),n.clipPath=r,console.debug("[export] Применён clipPath для экспорта стороны "+a)),this.filterDesignObjects(t.getObjects()));for(let t of l){var d=await new Promise(e=>{t.clone(t=>e(t))});n.add(d)}var c,h=n.toDataURL({format:"png",multiplier:10,quality:1}),u="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==";h!==u&&h.length>u.length&&(c=await this.loadImage(h),e.drawImage(c,0,0,o.width,o.height),console.debug("[export] Добавлены объекты дизайна без границ для "+a)),n.dispose()}catch(t){console.warn(`[export] Ошибка создания дизайна без границ для ${a}:`,t)}}filterDesignObjects(t){let e=new Set(["area:border","area:clip","guideline","guideline:vertical","guideline:horizontal"]);return t.filter(t=>!e.has(t.name))}async exportDesignWithClipPath(t,e,o,i){var s=t.clipPath;if(!s)return console.warn("[export] clipPath не найден, экспортируем весь canvas"),this.createDesignCanvas(t,e,o);var a=s.width,r=s.height,n=s.left,s=s.top,t=(console.debug(`[export] clipPath: ${a}x${r} at (${n}, ${s})`),await this.createDesignCanvas(t,e,o)),e=i/Math.max(a,r),o=document.createElement("canvas");o.width=a*e,o.height=r*e;return o.getContext("2d").drawImage(t,10*n,10*s,10*a,10*r,0,0,o.width,o.height),console.debug(`[export] Дизайн обрезан по clipPath: ${o.width}x${o.height}px`),o}async uploadDesignToServer(t){try{console.debug("[export] Загрузка дизайна на сервер");var e,o,i=new FormData;for([e,o]of Object.entries(t)){var s=await(await fetch(o)).blob();i.append(e,s,e+".png")}return console.warn("[export] Загрузка на сервер не реализована"),t}catch(t){return console.error("[export] Ошибка при загрузке на сервер:",t),null}}saveLayersToHistory(){this.currentHistoryIndex<this.layersHistory.length-1&&(this.layersHistory=this.layersHistory.slice(0,this.currentHistoryIndex+1));var t={layers:JSON.parse(JSON.stringify(this.layouts)).map(t=>new l.Layout(t)),timestamp:Date.now()};this.layersHistory.push(t),this.currentHistoryIndex=this.layersHistory.length-1;50<this.layersHistory.length&&(this.layersHistory.shift(),this.currentHistoryIndex--),console.debug(`[history] Сохранено состояние слоёв. Индекс: ${this.currentHistoryIndex}, Всего: ${this.layersHistory.length}, Слоёв: `+this.layouts.length),this.updateHistoryButtonsState()}canUndo(){return this.currentHistoryIndex===this.layersHistory.length-1?2<=this.layersHistory.length:0<this.currentHistoryIndex}canRedo(){return this.currentHistoryIndex<this.layersHistory.length-1}updateHistoryButtonsState(){var t,e=this.canUndo(),o=this.canRedo();this.editorHistoryUndoBlock&&this.editorHistoryUndoBlock.firstElementChild&&(t=this.editorHistoryUndoBlock.firstElementChild,e?(t.style.backgroundColor="",t.style.cursor="pointer"):(t.style.backgroundColor="#f2f2f2",t.style.cursor="default")),this.editorHistoryRedoBlock&&this.editorHistoryRedoBlock.firstElementChild&&(t=this.editorHistoryRedoBlock.firstElementChild,o?(t.style.backgroundColor="",t.style.cursor="pointer"):(t.style.backgroundColor="#f2f2f2",t.style.cursor="default")),console.debug("[history] Состояние кнопок: undo =",e,", redo =",o)}async undo(){if(!this.canUndo())return console.debug("[history] Undo невозможен"),!1;this.currentHistoryIndex===this.layersHistory.length-1&&2<=this.layersHistory.length?this.currentHistoryIndex=this.layersHistory.length-2:this.currentHistoryIndex=Math.max(0,this.currentHistoryIndex-1);var t=this.layersHistory[this.currentHistoryIndex];return t?(console.debug(`[history] Undo к индексу ${this.currentHistoryIndex} из `+(this.layersHistory.length-1)),await this.restoreLayersFromHistory(t),this.updateHistoryButtonsState(),!0):(console.warn("[history] История не найдена"),!1)}async redo(){if(!this.canRedo())return console.debug("[history] Redo невозможен"),!1;this.currentHistoryIndex++;var t=this.layersHistory[this.currentHistoryIndex];return t?(console.debug(`[history] Redo к индексу ${this.currentHistoryIndex} из `+(this.layersHistory.length-1)),await this.restoreLayersFromHistory(t),this.updateHistoryButtonsState(),!0):(console.warn("[history] История не найдена"),!1)}async restoreLayersFromHistory(t){this.isRestoringFromHistory=!0;try{this.layouts=[],t.layers.forEach(t=>{this.layouts.push(new l.Layout(t))}),this.showLayoutList(),this.updateLayouts(),this.updateSum(),await this.saveState(),console.debug(`[history] Восстановлено ${this.layouts.length} слоёв`)}finally{this.isRestoringFromHistory=!1}}destroy(){console.debug("[editor] Очистка ресурсов редактора"),this.loadingInterval&&(clearInterval(this.loadingInterval),this.loadingInterval=null),this.events.destroy(),this.canvases.forEach(t=>{try{t.dispose()}catch(t){console.error("[cleanup] Ошибка очистки canvas:",t)}}),this.canvases=[],this.layersCanvases.forEach(t=>{try{t.dispose()}catch(t){console.error("[cleanup] Ошибка очистки layer canvas:",t)}}),this.layersCanvases=[],console.debug("[editor] Ресурсы успешно очищены")}getCurrentState(){return{type:this._selectType,color:this._selectColor,side:this._selectSide,size:this._selectSize,layouts:this.layouts,isLoading:this.isLoading}}}},"./src/entries/editor.ts":
/*!*******************************!*\
  !*** ./src/entries/editor.ts ***!
  \*******************************/(t,e,o)=>{o.r(e),o.d(e,{default:()=>s});let i=o(/*! ../components/Editor */"./src/components/Editor.ts"),s=i.default;window.Editor=i.default},"./src/managers/EditorStorageManager.ts":
/*!**********************************************!*\
  !*** ./src/managers/EditorStorageManager.ts ***!
  \**********************************************/(t,e,o)=>{o.r(e),o.d(e,{EditorStorageManager:()=>i});class i{constructor(){this.database=null,this.isReady=!1,this.readyPromise=this.init()}async init(){return new Promise((t,e)=>{let o=indexedDB.open("editor",2);o.onupgradeneeded=t=>{t=t.target.result;t.objectStoreNames.contains("history")||t.createObjectStore("history",{keyPath:"id"}),t.objectStoreNames.contains("editor_state")||t.createObjectStore("editor_state",{keyPath:"key"}),t.objectStoreNames.contains("user_data")||t.createObjectStore("user_data",{keyPath:"key"})},o.onerror=()=>{console.error("Ошибка открытия IndexedDB",o.error),e(o.error)},o.onsuccess=()=>{this.database=o.result,this.isReady=!0,t()}})}async waitForReady(){await this.readyPromise}async saveEditorState(t){if(await this.waitForReady(),!this.database)throw new Error("Database не инициализирована");var e=this.database.transaction(["editor_state"],"readwrite").objectStore("editor_state");await Promise.all([this.putData(e,"date",t.date),this.putData(e,"color",t.color),this.putData(e,"side",t.side),this.putData(e,"type",t.type),this.putData(e,"size",t.size)])}async loadEditorState(){if(await this.waitForReady(),!this.database)throw new Error("Database не инициализирована");var t=this.database.transaction(["editor_state"],"readonly").objectStore("editor_state");try{var[e,o,i,s,a]=await Promise.all([this.getData(t,"date"),this.getData(t,"color"),this.getData(t,"side"),this.getData(t,"type"),this.getData(t,"size")]);return e&&o&&i&&s&&a?{date:e,color:o,side:i,type:s,size:a}:null}catch(t){return console.error("Ошибка загрузки состояния редактора:",t),null}}async clearEditorState(){if(await this.waitForReady(),!this.database)throw new Error("Database не инициализирована");var t=this.database.transaction(["editor_state"],"readwrite").objectStore("editor_state");await Promise.all([this.deleteData(t,"date"),this.deleteData(t,"color"),this.deleteData(t,"side"),this.deleteData(t,"type"),this.deleteData(t,"size")])}async getUserId(){if(await this.waitForReady(),!this.database)throw new Error("Database не инициализирована");var t=this.database.transaction(["user_data"],"readwrite").objectStore("user_data");let e=await this.getData(t,"userId");e||(e=crypto.randomUUID(),await this.putData(t,"userId",e));try{window.OpenReplay.setUserID(e)}catch(t){console.error("Ошибка установки ID пользователя в tracker:",t)}return e}async saveToHistory(t,e){if(await this.waitForReady(),!this.database)throw new Error("Database не инициализирована");let i={...t,id:crypto.randomUUID(),timestamp:Date.now(),description:e||"Изменения от "+(new Date).toLocaleString()};let s=this.database.transaction(["history"],"readwrite").objectStore("history");return await new Promise((t,e)=>{let o=s.add(i);o.onerror=()=>e(o.error),o.onsuccess=()=>t()}),i.id}async saveLayerOperation(t,e,o,i,s){if(await this.waitForReady(),!this.database)throw new Error("Database не инициализирована");let a={id:crypto.randomUUID(),timestamp:Date.now(),operation:t,layout:JSON.parse(JSON.stringify(e)),side:o,type:i,description:s||`${"add"===t?"Добавлен":"Удален"} слой: `+(e.name||e.type)};let r=this.database.transaction(["history"],"readwrite").objectStore("history");return await new Promise((t,e)=>{let o=r.add({...a,isLayerOperation:!0});o.onerror=()=>e(o.error),o.onsuccess=()=>t()}),a.id}async getLayerHistory(i,s=50){if(await this.waitForReady(),!this.database)throw new Error("Database не инициализирована");let a=this.database.transaction(["history"],"readonly").objectStore("history");return new Promise((e,t)=>{let o=a.getAll();o.onerror=()=>t(o.error),o.onsuccess=()=>{var t=o.result.filter(t=>t.isLayerOperation&&t.side===i.side&&t.type===i.type).map(t=>({id:t.id,timestamp:t.timestamp,operation:t.operation,layout:t.layout,side:t.side,type:t.type,description:t.description})).sort((t,e)=>e.timestamp-t.timestamp).slice(0,s);e(t)}})}async getRecentLayerOperations(t,e=10){return this.getLayerHistory(t,e)}async getHistory(i,s=50){if(await this.waitForReady(),!this.database)throw new Error("Database не инициализирована");let a=this.database.transaction(["history"],"readonly").objectStore("history");return new Promise((e,t)=>{let o=a.getAll();o.onerror=()=>t(o.error),o.onsuccess=()=>{var t=o.result.filter(t=>t.side===i.side&&t.type===i.type).sort((t,e)=>e.timestamp-t.timestamp).slice(0,s);e(t)}})}async getHistoryItem(i){if(await this.waitForReady(),!this.database)throw new Error("Database не инициализирована");let s=this.database.transaction(["history"],"readonly").objectStore("history");return new Promise((t,e)=>{let o=s.get(i);o.onerror=()=>e(o.error),o.onsuccess=()=>t(o.result||null)})}async deleteHistoryItem(i){if(await this.waitForReady(),!this.database)throw new Error("Database не инициализирована");let s=this.database.transaction(["history"],"readwrite").objectStore("history");await new Promise((t,e)=>{let o=s.delete(i);o.onerror=()=>e(o.error),o.onsuccess=()=>t()})}async clearHistory(t){if(await this.waitForReady(),!this.database)throw new Error("Database не инициализирована");var e;let i=this.database.transaction(["history"],"readwrite").objectStore("history");if(t)for(e of await this.getHistory(t,1e3))await this.deleteHistoryItem(e.id);else await new Promise((t,e)=>{let o=i.clear();o.onerror=()=>e(o.error),o.onsuccess=()=>t()})}async saveLayers(t){if(await this.waitForReady(),!this.database)throw new Error("Database не инициализирована");var e=this.database.transaction(["editor_state"],"readwrite").objectStore("editor_state");await this.putData(e,"layers",t)}async loadLayers(){if(await this.waitForReady(),!this.database)throw new Error("Database не инициализирована");try{var t=this.database.transaction(["editor_state"],"readonly").objectStore("editor_state");return await this.getData(t,"layers")||null}catch(t){return console.error("Ошибка загрузки слоёв:",t),null}}putData(i,s,a){return new Promise((t,e)=>{let o=i.put({key:s,value:a});o.onerror=()=>e(o.error),o.onsuccess=()=>t()})}getData(i,s){return new Promise((t,e)=>{let o=i.get(s);o.onerror=()=>e(o.error),o.onsuccess=()=>t(o.result?.value||null)})}deleteData(i,s){return new Promise((t,e)=>{let o=i.delete(s);o.onerror=()=>e(o.error),o.onsuccess=()=>t()})}}}},i={},d.m=o,c=[],d.O=(t,e,o,i)=>{if(!e){for(var s=1/0,a=0;a<c.length;a++){for(var r,[e,o,i]=c[a],n=!0,l=0;l<e.length;l++)(!1&i||i<=s)&&Object.keys(d.O).every(t=>d.O[t](e[l]))?e.splice(l--,1):(n=!1,i<s&&(s=i));n&&(c.splice(a--,1),void 0!==(r=o()))&&(t=r)}return t}i=i||0;for(var a=c.length;0<a&&c[a-1][2]>i;a--)c[a]=c[a-1];c[a]=[e,o,i]},d.d=(t,e)=>{for(var o in e)d.o(e,o)&&!d.o(t,o)&&Object.defineProperty(t,o,{enumerable:!0,get:e[o]})},d.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),d.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},h={"editor.min":0},d.O.j=t=>0===h[t],e=(t,e)=>{var o,i,s,[a,r,n]=e,l=0;if(a.some(t=>0!==h[t])){for(o in r)d.o(r,o)&&(d.m[o]=r[o]);n&&(s=n(d))}for(t&&t(e);l<a.length;l++)i=a[l],d.o(h,i)&&h[i]&&h[i][0](),h[i]=0;return d.O(s)},(t=this.webpackChunkfrontend_project=this.webpackChunkfrontend_project||[]).forEach(e.bind(null,0)),t.push=e.bind(null,t.push.bind(t)),e=d.O(void 0,["common"],()=>d("./src/entries/editor.ts")),d.O(e).default;function d(t){var e=i[t];return void 0!==e||(e=i[t]={exports:{}},o[t](e,e.exports,d)),e.exports}var c,h,t,o,i,e});