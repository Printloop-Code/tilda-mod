((t,e)=>{"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports["editor.min"]=e():t["editor.min"]=e()})(this,()=>{var i={"./src/components/Editor.ts":
/*!**********************************!*\
  !*** ./src/components/Editor.ts ***!
  \**********************************/(t,e,i)=>{i.r(e),i.d(e,{EditorEventType:()=>n,default:()=>s});var n,r=i(/*! ../managers/EditorStorageManager */"./src/managers/EditorStorageManager.ts"),l=i(/*! ../models/Layout */"./src/models/Layout.ts"),d=i(/*! ../utils/tildaUtils */"./src/utils/tildaUtils.ts"),a=i(/*! ../utils/TypedEventEmitter */"./src/utils/TypedEventEmitter.ts"),c=i(/*! ../utils/api */"./src/utils/api.ts"),h=i(/*! ../utils/canvasUtils */"./src/utils/canvasUtils.ts");let u=(t,e)=>{try{"function"==typeof window.OpenReplay?.handleError&&window.OpenReplay.handleError(new Error(t),e)}catch(t){console.warn("[OpenReplay] Failed to log issue:",t)}},o={STATE_EXPIRATION_DAYS:30,CANVAS_AREA_HEIGHT:600,LOADING_INTERVAL_MS:100};(e=n=n||{}).MOCKUP_LOADING="mockup-loading",e.MOCKUP_UPDATED="mockup-updated",e.LOADING_TIME_UPDATED="loading-time-updated",e.STATE_CHANGED="state-changed",e.LAYOUT_ADDED="layout-added",e.LAYOUT_REMOVED="layout-removed",e.LAYOUT_UPDATED="layout-updated";class s{get selectType(){return this._selectType}get selectColor(){return this._selectColor}get selectSide(){return this._selectSide}get selectSize(){return this._selectSize}get selectLayout(){return this._selectLayout}constructor({blocks:t,productConfigs:e,formConfig:i,apiConfig:o,options:s}){if(this.quantityFormBlock=null,this.formBlock=null,this.formInputVariableName=null,this.formButton=null,this._selectLayout=null,this.layouts=[],this.canvases=[],this.layersCanvases=[],this.activeCanvas=null,this.events=new a.TypedEventEmitter,this.layersHistory=[],this.currentHistoryIndex=-1,this.isRestoringFromHistory=!1,this.isLoading=!0,this.isAddingToCart=!1,this.isAddedToCart=!1,this.isGenerating=!1,this.loadingTime=0,this.loadingInterval=null,this.colorBlocks=[],this.sizeBlocks=[],this.productBlocks=[],this.loadedUserImage=null,this.editorLoadWithAi=!1,this.editorRemoveBackground=!1,this.imageCache=new Map,this.loadingElementsCache={},this.productCache=new Map,this.mockupCache=new Map,!e||0===e.length)throw u("editor_init_error",{error:"product_configs_missing",hasProductConfigs:!!e,productsCount:e?.length||0}),new Error("[Editor] Не предоставлены конфигурации продуктов");this.storageManager=new r.EditorStorageManager,this.productConfigs=e,this.apiConfig=o,this.options=s,this.editorBlock=this.getRequiredElement(t.editorBlockClass),this.changeSideButton=this.getRequiredElement(t.changeSideButtonClass),this.editorHistoryUndoBlock=this.getRequiredElement(t.editorHistoryUndoBlockClass),this.editorHistoryRedoBlock=this.getRequiredElement(t.editorHistoryRedoBlockClass),this.quantityFormBlock=document.querySelector(t.editorQuantityFormBlockClass);o=document.querySelector(t.productListBlockClass),o&&(this.productListBlock=o),s=document.querySelector(t.productItemClass),s&&(this.productItemBlock=s),o=document.querySelector(t.editorColorsListBlockClass),o&&(this.editorColorsListBlock=o),s=document.querySelector(t.editorColorItemBlockClass),s&&(this.editorColorItemBlock=s),o=document.querySelector(t.editorSizesListBlockClass),o&&(this.editorSizesListBlock=o),s=document.querySelector(t.editorSizeItemBlockClass),s&&(this.editorSizeItemBlock=s),o=document.querySelector(t.editorLayoutsListBlockClass),o&&(this.editorLayoutsListBlock=o),s=document.querySelector(t.editorLayoutItemBlockClass),s&&(this.editorLayoutItemBlock=s),o=document.querySelector(t.editorUploadImageButtonClass),o&&(this.editorUploadImageButton=o),s=document.querySelector(t.editorUploadViewBlockClass),s&&(this.editorUploadViewBlock=s),o=document.querySelector(t.editorUploadCancelButtonClass),o&&(this.editorUploadCancelButton=o),s=document.querySelector(t.editorLoadWithAiButtonClass),s&&(this.editorLoadWithAiButton=s),o=document.querySelector(t.editorLoadWithoutAiButtonClass),o&&(this.editorLoadWithoutAiButton=o),s=document.querySelector(t.editorRemoveBackgroundButtonClass),s&&(this.editorRemoveBackgroundButton=s),o=document.querySelector(t.editorAddOrderButtonClass),o&&(this.editorAddOrderButton=o),s=document.querySelector(t.editorSumBlockClass),s&&(this.editorSumBlock=s),o=document.querySelector(t.editorProductNameClass),o&&(this.editorProductName=o),this.editorLayoutItemBlockViewClass=t.editorLayoutItemBlockViewClass,this.editorLayoutItemBlockNameClass=t.editorLayoutItemBlockNameClass,this.editorLayoutItemBlockRemoveClass=t.editorLayoutItemBlockRemoveClass,this.editorLayoutItemBlockEditClass=t.editorLayoutItemBlockEditClass,i&&(this.formBlock=document.querySelector(i.formBlockClass),this.formInputVariableName=i.formInputVariableName,this.formButton=document.querySelector(i.formButtonClass)),s=e[0];if(!s)throw u("editor_init_error",{error:"default_product_not_found",productsCount:e.length}),new Error("[Editor] Не найден дефолтный продукт");o=s.mockups[0];if(!o)throw u("editor_init_error",{error:"default_mockup_not_found",productType:s.type,mockupsCount:s.mockups?.length||0}),new Error("[Editor] Не найден дефолтный mockup");this._selectColor=o.color,this._selectSide=o.side,this._selectType=s.type,this._selectSize=s.sizes?.[0]||"M",this.editorBlock.style.position="relative",this.createBackgroundBlock(),this.mockupBlock=this.createMockupBlock(),this.canvasesContainer=this.createCanvasesContainer(),this.editorLoadingBlock=this.createEditorLoadingBlock(),this.initEvents(),this.initKeyboardShortcuts(),this.initLoadingEvents(),this.initUIComponents(),this.initializeEditor(),window.getLayouts=()=>this.layouts.map(t=>({...t,url:void 0})),window.loadLayouts=t=>{this.layouts=t.map(t=>l.Layout.fromJSON(t)),this.updateLayouts(),this.showLayoutList()},window.exportPrint=async()=>{var t,e=await this.exportArt(!1,4096);for(t of Object.keys(e)){var i=document.createElement("a");document.body.appendChild(i),i.href=e[t],i.target="_self",i.download=t+".png",i.click()}return e}}initUIComponents(){this.changeSideButton&&(this.changeSideButton.style.cursor="pointer",this.changeSideButton.onclick=()=>this.changeSide()),this.editorHistoryUndoBlock&&this.initHistoryUndoBlock(),this.editorHistoryRedoBlock&&this.initHistoryRedoBlock(),this.productListBlock&&this.productItemBlock&&this.initProductList(),this.editorAddOrderButton&&this.initAddOrderButton(),this.editorUploadImageButton&&this.initUploadImageButton(),this.editorLoadWithAiButton&&this.editorLoadWithoutAiButton&&this.editorRemoveBackgroundButton&&this.initAiButtons(),this.formBlock&&this.formButton&&this.initForm(),this.quantityFormBlock&&setTimeout(()=>this.initFixQuantityForm(),500),this.editorLayoutsListBlock&&this.showLayoutList(),this.editorUploadCancelButton&&(this.editorUploadCancelButton.style.cursor="pointer",this.editorUploadCancelButton.onclick=()=>{console.debug("[upload image button] cancel button clicked"),this.resetUserUploadImage()})}getRequiredElement(t){var e=document.querySelector(t);if(e)return e;throw u("editor_required_element_not_found",{selector:t}),new Error("[Editor] Не найден обязательный элемент: "+t)}async initializeEditor(){try{await this.storageManager.waitForReady(),await this.loadState(),await this.preloadAllMockups(),console.debug("[editor] Инициализация завершена")}catch(t){console.error("[editor] Ошибка инициализации:",t),u("editor_initialization_error",{error:t instanceof Error?t.message:String(t),hasStorage:!!this.storageManager}),this.initializeWithDefaults()}}async initializeWithDefaults(){console.debug("[editor] Инициализация с дефолтными значениями");try{await this.updateMockup()}catch(t){console.error("[editor] Ошибка загрузки mockup по умолчанию:",t),u("editor_default_mockup_load_error",{error:t instanceof Error?t.message:String(t),selectedType:this._selectType,selectedColor:this._selectColor,selectedSide:this._selectSide})}}initEvents(){this.options?.disableBeforeUnloadWarning||(window.onbeforeunload=t=>{var e;if(0<this.layouts.length&&!this.isAddedToCart&&0<this.layersHistory.length)return e="Дизайн редактора может быть потерян. Вы уверены, что хотите покинуть страницу?",t.preventDefault(),t.returnValue=e});let t;window.addEventListener("resize",()=>{clearTimeout(t),t=setTimeout(()=>{this.handleWindowResize()},150)}),this.events.on(n.MOCKUP_UPDATED,t=>{this.mockupBlock.src=t})}initLoadingEvents(){this.loadingElementsCache.loadingText=this.editorLoadingBlock.querySelector("#loading-text"),this.loadingElementsCache.spinner=this.editorLoadingBlock.querySelector("#spinner"),this.events.on(n.LOADING_TIME_UPDATED,t=>{var{loadingText:e,spinner:i}=this.loadingElementsCache;this.isLoading?5<this.loadingTime?(e&&(e.style.display="block",e.innerText=""+(this.loadingTime/10).toFixed(1)),i&&(i.style.display="block"),this.editorLoadingBlock.style.backgroundColor="rgba(255, 255, 255, 0.745)"):(e&&(e.style.display="none",e.innerText=""),i&&(i.style.display="none"),this.editorLoadingBlock.style.backgroundColor="rgba(255, 255, 255, 0)"):e&&(e.style.display="none",e.innerText="")}),this.events.on(n.MOCKUP_LOADING,t=>{var{loadingText:e,spinner:i}=this.loadingElementsCache;t?(this.loadingInterval&&clearInterval(this.loadingInterval),this.loadingTime=0,this.isLoading=!0,console.debug("[mockup] loading mockup"),this.loadingInterval=setInterval(()=>{this.loadingTime++,this.emit(n.LOADING_TIME_UPDATED,this.loadingTime)},100)):(this.editorLoadingBlock.style.backgroundColor="rgba(255, 255, 255, 0)",e&&(e.style.display="none",e.innerText=""),i&&(i.style.display="none"),this.isLoading=!1,this.loadingInterval&&(clearInterval(this.loadingInterval),this.loadingInterval=null),this.loadingTime=0)})}emit(t,e){this.events.emit(t,e)}initKeyboardShortcuts(){document.addEventListener("keydown",t=>{var e=document.activeElement;e&&("INPUT"===e.tagName||"TEXTAREA"===e.tagName||"true"===e.contentEditable||e.isContentEditable)||(t.ctrlKey&&"KeyZ"===t.code&&!t.shiftKey?(t.preventDefault(),this.undo()):(t.ctrlKey&&t.shiftKey&&"KeyZ"===t.code||t.ctrlKey&&"KeyY"===t.code&&!t.shiftKey)&&(t.preventDefault(),this.redo()))})}createBackgroundBlock(){var t=document.createElement("div");return t.classList.add("editor-position"),t.id="editor-background",this.editorBlock.appendChild(t),t}createMockupBlock(){var t=document.createElement("img");return t.classList.add("editor-position"),t.id="editor-mockup",this.editorBlock.appendChild(t),t}createCanvasesContainer(){var t=document.createElement("div");return t.classList.add("editor-position"),t.id="editor-canvases-container",t.style.zIndex="10",t.style.pointerEvents="auto",this.editorBlock.appendChild(t),t}createEditorLoadingBlock(){var t=document.createElement("div"),e=(t.style.display="flex",t.classList.add("editor-position"),t.id="editor-loading",t.style.zIndex="1000",t.style.pointerEvents="none",document.createElement("div")),e=(e.id="loading-text",e.style.display="none",e.style.textAlign="center",e.style.position="absolute",e.style.top="50%",e.style.left="50%",e.style.transform="translate(-50%, -50%)",t.appendChild(e),document.createElement("div"));return e.id="spinner",e.style.display="none",t.appendChild(e),this.editorBlock.appendChild(t),t}async updateMockup(){console.debug(`[mockup] update for ${this._selectType} ${this._selectSide} `+this._selectColor.name),this.emit(n.MOCKUP_LOADING,!0);try{var t=this.findMockupUrl();if(!t)throw u("mockup_not_found",{productType:this._selectType,color:this._selectColor.name,side:this._selectSide}),new Error("[mockup] Не найден mockup для текущих параметров");var e=await this.loadAndConvertImage(t);this.emit(n.MOCKUP_UPDATED,e),this.mockupBlock.src=e,console.debug("[mockup] Mockup успешно обновлен")}catch(t){throw console.error("[mockup] Ошибка обновления mockup:",t),u("mockup_update_error",{error:t instanceof Error?t.message:String(t),productType:this._selectType,color:this._selectColor.name,side:this._selectSide}),t}finally{this.emit(n.MOCKUP_LOADING,!1)}}findMockupUrl(){var t,e=`${this._selectType}-${this._selectSide}-`+this._selectColor.name;return this.mockupCache.has(e)?this.mockupCache.get(e):(t=this.getProductByType(this._selectType))?(t=t.mockups.find(t=>t.side===this._selectSide&&t.color.name===this._selectColor.name)?.url||null,this.mockupCache.set(e,t),t):(this.mockupCache.set(e,null),null)}getProductByType(e){var t;return this.productCache.has(e)||(t=this.productConfigs.find(t=>t.type===e))&&this.productCache.set(e,t),this.productCache.get(e)}clearMockupCache(){this.mockupCache.clear()}async loadAndConvertImage(a){return this.imageCache.has(a)?(console.debug("[cache] Изображение загружено из кэша:",a),this.imageCache.get(a)):new Promise((o,s)=>{let r=new Image;r.setAttribute("crossOrigin","anonymous"),r.onload=()=>{try{var t,e=document.createElement("canvas"),i=(e.width=r.width,e.height=r.height,e.getContext("2d"));i?(i.drawImage(r,0,0),t=e.toDataURL("image/png"),this.imageCache.set(a,t),console.debug("[cache] Изображение сохранено в кэш:",a),o(t)):s(new Error("Не удалось получить контекст canvas"))}catch(t){s(t)}},r.onerror=()=>{s(new Error("Ошибка загрузки изображения: "+a))},r.src=a})}async saveState(){console.debug("[state] Сохранение состояния редактора");try{var t={date:(new Date).toISOString(),type:this._selectType,color:this._selectColor.name,side:this._selectSide,size:this._selectSize};console.debug(`[state] Сохраняем: type=${t.type}, color=${t.color}, side=${t.side}, size=`+t.size),await this.storageManager.saveEditorState(t),console.debug("[state] Состояние успешно сохранено")}catch(t){console.error("[state] Ошибка сохранения состояния:",t),u("editor_state_save_error",{error:t instanceof Error?t.message:String(t),state:{type:this._selectType,color:this._selectColor.name,side:this._selectSide,size:this._selectSize}})}}async saveLayouts(){console.debug("[layers] Сохранение слоёв");try{await this.storageManager.saveLayers(this.layouts),console.debug("[layers] Слои успешно сохранены")}catch(t){console.error("[layers] Ошибка сохранения слоёв:",t),u("editor_layers_save_error",{error:t instanceof Error?t.message:String(t),layersCount:this.layouts.length})}}async loadLayouts(){console.debug("[layers] Загрузка слоёв");try{var t=await this.storageManager.loadLayers();t&&Array.isArray(t)?(this.layouts=t.map(t=>new l.Layout(t)),console.debug(`[layers] Загружено ${this.layouts.length} слоёв`)):(this.layouts=[],console.debug("[layers] Нет сохранённых слоёв")),this.saveLayersToHistory()}catch(t){console.error("[layers] Ошибка загрузки слоёв:",t),u("editor_layers_load_error",{error:t instanceof Error?t.message:String(t)}),this.layouts=[],this.saveLayersToHistory()}}async loadState(){console.debug("[state] Загрузка состояния редактора");try{var t,e=await this.storageManager.loadEditorState();e?(this.isStateExpired(e.date)?(console.warn("[state] Состояние устарело, очищаем"),await this.storageManager.clearEditorState(),await this.updateMockup(),this.loadProduct(),this.initColorsList(),this.initSizesList(),this.showLayoutList(),this.updateLayouts()):await this.applyState(e)?(console.debug("[state] Состояние успешно загружено"),await this.updateMockup(),this.loadProduct(),0<this.productBlocks.length&&(this.productBlocks.forEach(t=>{t.style.background="rgb(222 222 222)"}),t=this.productBlocks.find(t=>t.classList.contains("editor-settings__product-block__"+this._selectType)))&&(t.style.background=""),await this.loadLayouts(),this.initColorsList(),this.initSizesList(),this.showLayoutList(),this.updateLayouts(),await this.saveLayouts()):(console.warn("[state] Не удалось применить сохраненное состояние"),await this.updateMockup(),this.loadProduct(),this.initColorsList(),this.initSizesList(),this.showLayoutList(),this.updateLayouts()),this.updateSum()):(console.debug("[state] Сохраненное состояние не найдено"),await this.updateMockup(),this.loadProduct(),this.initColorsList(),this.initSizesList(),this.showLayoutList(),this.updateLayouts(),this.updateSum())}catch(t){console.error("[state] Ошибка загрузки состояния:",t),await this.updateMockup(),this.loadProduct(),this.initColorsList(),this.initSizesList(),this.showLayoutList(),this.updateLayouts(),this.updateSum()}}isStateExpired(t){var t=new Date(t),e=Date.now()-24*o.STATE_EXPIRATION_DAYS*60*60*1e3;return t.getTime()<e}async applyState(e){try{if(!e.type||!e.color||!e.side)return console.warn("[state] Некорректное состояние: отсутствуют обязательные поля"),!1;console.debug(`[state] Восстановление состояния: type=${e.type}, color=${e.color}, side=${e.side}, size=`+e.size);var t,i=this.productConfigs.find(t=>t.type===e.type);return i?(t=i.mockups.find(t=>t.color.name===e.color))?(this._selectType=e.type,this._selectColor=t.color,this._selectSide=e.side,this._selectSize=e.size||this._selectSize,console.debug(`[state] Состояние применено: type=${this._selectType}, color=${this._selectColor.name}, side=${this._selectSide}, size=`+this._selectSize),!0):(console.warn(`[state] Mockup с цветом ${e.color} не найден для продукта `+e.type),!1):(console.warn(`[state] Продукт типа ${e.type} не найден`),!1)}catch(t){return console.error("[state] Ошибка применения состояния:",t),!1}}setType(t){this._selectType!==t&&(this._selectType=t,this.clearMockupCache(),this.emit(n.STATE_CHANGED,void 0),this.saveState().catch(t=>console.error("[state] Ошибка сохранения:",t)))}setColor(t){this._selectColor!==t&&(this._selectColor=t,this.clearMockupCache(),this.emit(n.STATE_CHANGED,void 0),this.saveState().catch(t=>console.error("[state] Ошибка сохранения:",t)))}setSide(t){this._selectSide!==t&&(this._selectSide=t,this.clearMockupCache(),this.emit(n.STATE_CHANGED,void 0),this.saveState().catch(t=>console.error("[state] Ошибка сохранения:",t)))}setSize(t){this._selectSize!==t&&(this._selectSize=t,this.emit(n.STATE_CHANGED,void 0),this.saveState().catch(t=>console.error("[state] Ошибка сохранения:",t)))}addLayout(t){this.isRestoringFromHistory?this.layouts.push(t):(this.layouts.push(t),this.saveLayersToHistory()),this.emit(n.LAYOUT_ADDED,t),this.updateLayouts(),this.showLayoutList(),this.saveLayouts().catch(t=>console.error("[layers] Ошибка сохранения слоёв:",t))}removeLayout(e){var t=this.layouts.findIndex(t=>t.id===e);if(-1!==t&&this.layouts[t])return this.layouts.splice(t,1),this.isRestoringFromHistory||this.saveLayersToHistory(),this.emit(n.LAYOUT_REMOVED,e),this.updateLayouts(),this.saveLayouts().catch(t=>console.error("[layers] Ошибка сохранения слоёв:",t)),!0;return!1}updateLayout(e,t){var i=this.layouts.find(t=>t.id===e);return!!i&&(Object.assign(i,t),this.isRestoringFromHistory||("url"in t||"name"in t)&&this.saveLayersToHistory(),this.emit(n.LAYOUT_UPDATED,i),this.saveLayouts().catch(t=>console.error("[layers] Ошибка сохранения слоёв:",t)),!0)}getLayout(e){return this.layouts.find(t=>t.id===e)}getLayouts(){return this.layouts}initHistoryUndoBlock(){console.debug("[history block] init undo"),this.editorHistoryUndoBlock.style.cursor="pointer",this.editorHistoryUndoBlock.onclick=async()=>{console.debug("[history undo block] clicked"),await this.undo()},this.updateHistoryButtonsState()}initHistoryRedoBlock(){console.debug("[history redo block] init redo"),this.editorHistoryRedoBlock.style.cursor="pointer",this.editorHistoryRedoBlock.onclick=async()=>{console.debug("[history redo block] clicked"),await this.redo()},this.updateHistoryButtonsState()}initProductList(){var t;this.productListBlock&&this.productItemBlock&&(console.debug("[ProductList] init product list"),this.productItemBlock.style.display="none",this.productConfigs.forEach(t=>{var e=this.productItemBlock.cloneNode(!0),i=(e.style.display="table",e.querySelector(".product-item-image")),i=(i&&(i=(0,d.getLastChild)(i))&&(i.style.backgroundImage=`url(${t.mockups[0]?.url})`,i.style.backgroundSize="cover",i.style.backgroundPosition="center",i.style.backgroundRepeat="no-repeat"),e.querySelector(".product-item-text")),i=(i&&(i=(0,d.getLastChild)(i))&&(i.innerText=t.productName),e.firstElementChild);i.classList.add("editor-settings__product-block__"+t.type),i.style.cursor="pointer",i.style.borderColor="transparent",e.onclick=()=>this.changeProduct(t.type),this.productBlocks.push(i),this.productListBlock.firstElementChild.appendChild(e)}),0<this.productBlocks.length)&&(this.productBlocks.forEach(t=>{t.style.background="rgb(222 222 222)"}),t=this.productBlocks.find(t=>t.classList.contains("editor-settings__product-block__"+this._selectType)))&&(t.style.background="")}initColorsList(){var t;this.editorColorsListBlock&&this.editorColorItemBlock&&(console.debug("[settings] init colors for "+this._selectType),t=this.getProductByType(this._selectType))&&(this.editorColorItemBlock.style.display="none",this.editorColorsListBlock.firstElementChild.innerHTML="",this.colorBlocks=[],t.mockups.filter(t=>t.side===this._selectSide).map(t=>t.color).forEach(t=>{var e=this.editorColorItemBlock.cloneNode(!0),i=(e.style.display="table",e.firstElementChild);i.classList.add("editor-settings__color-block__"+t.name),i.style.cursor="pointer",i.style.backgroundColor=t.hex,i.style.borderColor="transparent",e.onclick=()=>this.changeColor(t.name),this.colorBlocks.push(i),this.editorColorsListBlock.firstElementChild.appendChild(e)}),0<this.colorBlocks.length)&&(this.colorBlocks.forEach(t=>{t.style.borderColor="#f3f3f3"}),t=this.colorBlocks.find(t=>t.classList.contains("editor-settings__color-block__"+this._selectColor.name)))&&(t.style.borderColor="")}initSizesList(){var t;this.editorSizesListBlock&&this.editorSizeItemBlock&&(console.debug("[settings] init sizes for "+this._selectType),t=this.getProductByType(this._selectType))&&t.sizes&&(this.editorSizeItemBlock.style.display="none",this.editorSizesListBlock.firstElementChild.innerHTML="",this.sizeBlocks=[],t.sizes.forEach(t=>{var e=this.editorSizeItemBlock.cloneNode(!0);e.style.display="table",e.style.cursor="pointer",e.style.userSelect="none",e.classList.add("editor-settings__size-block__"+t);e.firstElementChild.style.borderColor="#f3f3f3";var i=(0,d.getLastChild)(e);i&&(i.innerText=t),e.onclick=()=>this.changeSize(t),this.sizeBlocks.push(e),this.editorSizesListBlock.firstElementChild.appendChild(e)}),0<this.sizeBlocks.length)&&(this.sizeBlocks.forEach(t=>{t=t.firstElementChild;t&&(t.style.borderColor="#f3f3f3")}),t=this.sizeBlocks.find(t=>t.classList.contains("editor-settings__size-block__"+this._selectSize)))&&(t=t.firstElementChild)&&(t.style.borderColor="")}showLayoutList(){console.debug("[settings] [layouts] show layouts list"),this.editorLayoutItemBlock?this.editorLayoutsListBlock?(this.editorLayoutItemBlock.style.display="none",this.editorLayoutsListBlock.firstElementChild.innerHTML="",console.debug("[settings] [layouts] layouts list block children: "+this.editorLayoutsListBlock.firstElementChild.children.length),this.layouts.forEach(t=>{var e=this.editorLayoutItemBlock.cloneNode(!0);e.style.display="table";let i=this._selectLayout===t.id;var o=this.editorLayoutItemBlockViewClass?e.querySelector(this.editorLayoutItemBlockViewClass):null,s=this.editorLayoutItemBlockNameClass?e.querySelector(this.editorLayoutItemBlockNameClass):null,r=this.editorLayoutItemBlockRemoveClass?e.querySelector(this.editorLayoutItemBlockRemoveClass):null,a=this.editorLayoutItemBlockEditClass?e.querySelector(this.editorLayoutItemBlockEditClass):null;o&&(t.isImageLayout()?((o=o.firstElementChild)&&(o.style.backgroundImage=`url(${t.url})`,o.style.backgroundSize="contain",o.style.backgroundPosition="center",o.style.backgroundRepeat="no-repeat"),i?o.style.borderColor="rgb(254, 94, 58)":o.style.borderColor=""):t.type),s&&(o=s.firstElementChild)&&("image"===t.type?(s=t.name?t.name.includes("\n")?t.name.split("\n")[0]+"...":40<t.name.length?t.name.slice(0,40)+"...":t.name:"Изображение",o.innerText=s):"text"===t.type&&(o.innerText=t.name||"Текст")),r&&(r.style.cursor="pointer",r.onclick=()=>{this.removeLayout(t.id),this.showLayoutList(),i&&this.cancelEditLayout()},this.restoreIconFromDataOriginal(r.firstElementChild)),a&&(i||"start"===t.id?a.style.display="none":a.style.display="table",a.style.cursor="pointer",a.onclick=()=>this.editLayout(t),this.restoreIconFromDataOriginal((0,d.getLastChild)(a))),this.editorLayoutsListBlock.firstElementChild.appendChild(e)}),this.updateSum(),console.debug("[settings] [layouts] layouts shown: "+this.editorLayoutsListBlock.firstElementChild.children.length)):console.error("[settings] [layouts] editorLayoutsListBlock is not initialized"):console.error("[settings] [layouts] editorLayoutItemBlock is not initialized")}initAddOrderButton(){this.editorAddOrderButton&&(this.editorAddOrderButton.style.cursor="pointer",this.events.on(n.MOCKUP_LOADING,t=>{this.editorAddOrderButton&&(t?(this.editorAddOrderButton.style.opacity="0.5",this.editorAddOrderButton.style.cursor="not-allowed",this.editorAddOrderButton.style.pointerEvents="none",console.debug("[order] Кнопка заблокирована (идет генерация)")):(this.editorAddOrderButton.style.opacity="1",this.editorAddOrderButton.style.cursor="pointer",this.editorAddOrderButton.style.pointerEvents="auto",console.debug("[order] Кнопка разблокирована")))}),this.editorAddOrderButton.onclick=async()=>{if(this.isAddingToCart)console.warn("[order] Процесс добавления уже идет, игнорируем повторное нажатие");else if(0===this.getSum())alert("Для добавления заказа продукт не может быть пустым");else if(0===this.layouts.length)alert("Пожалуйста, дождитесь завершения генерации дизайна"),console.warn("[order] Попытка добавить в корзину без дизайна");else{let t=this.editorAddOrderButton?.querySelector(".tn-atom"),i=(t=t||this.editorAddOrderButton?.querySelector("div, span"))?.textContent?.trim()||"Добавить в корзину";try{this.isAddingToCart=!0,this.setAddToCartButtonLoading(!0,"Добавление...");var o,s,r,a,n,l,d=Math.floor(Math.random()*(99e6+1))+999999;console.debug("[order] Начало создания заказа");let e=await this.exportArt(!0,512);console.debug("[order] Экспорт дизайна завершен:",Object.keys(e)),0===Object.keys(e).length?(alert("Ошибка: не удалось экспортировать дизайн. Попробуйте еще раз."),console.error("[order] Экспорт вернул пустой результат")):(o=Object.keys(e).map(t=>({image_url:e[t]||""})),s=(console.debug("[order] Загрузка изображений на сервер..."),o.map(async t=>{var e=t.image_url.split(",")[1];return{side:t,uploadedUrl:await this.uploadImageToServer(e)}})),r=((await Promise.all(s)).forEach(({side:t,uploadedUrl:e})=>{t.image_url=e}),console.debug("[order] Изображения загружены на сервер"),`${this.capitalizeFirstLetter(this.getProductName())} с вашим ${1==Object.keys(e).length?"односторонним":"двухсторонним"} принтом`),a=this.layouts.map(t=>({...t,url:void 0})),n=await this.storageManager.getUserId(),(l=new FormData).append("layouts",JSON.stringify(a)),l.append("user_id",n),l.append("art",d.toString()),await fetch(this.apiConfig.webhookCart,{method:"POST",body:l}),(0,c.createProduct)({quantity:this.getQuantity(),name:r,size:this._selectSize,color:this._selectColor,sides:o,article:d,price:this.getSum()}),this.isAddedToCart=!0,console.debug("[order] Заказ успешно создан"),this.setAddToCartButtonLoading(!1,"✓ Добавлено!"),setTimeout(()=>{this.setAddToCartButtonLoading(!1,i)},2e3))}catch(t){console.error("[order] Ошибка создания заказа:",t),u("order_creation_error",{error:t instanceof Error?t.message:String(t),productType:this._selectType,size:this._selectSize,color:this._selectColor.name,layersCount:this.layouts.length}),alert("Ошибка при создании заказа"),this.setAddToCartButtonLoading(!1,i)}finally{setTimeout(()=>{this.isAddingToCart=!1,console.debug("[order] Флаг isAddingToCart сброшен")},2e3)}}})}setAddToCartButtonLoading(e,i){if(this.editorAddOrderButton){this.injectPulseAnimation();var o=this.editorAddOrderButton;let t=o.querySelector(".tn-atom");var s=(t=t||o.querySelector("div, span"))||o;e?(o.style.opacity="0.7",o.style.cursor="not-allowed",o.style.pointerEvents="none",i&&(s.textContent=i),o.style.animation="cartButtonPulse 1.5s ease-in-out infinite",console.debug("[order] [animation] Кнопка заблокирована:",i)):(o.style.opacity="1",o.style.cursor="pointer",o.style.pointerEvents="auto",o.style.animation="none",i&&(s.textContent=i),console.debug("[order] [animation] Кнопка разблокирована:",i))}}injectPulseAnimation(){var t;document.getElementById("cart-button-pulse-animation")||((t=document.createElement("style")).id="cart-button-pulse-animation",t.textContent=`
            @keyframes cartButtonPulse {
                0%, 100% {
                    transform: scale(1);
                    opacity: 0.7;
                }
                50% {
                    transform: scale(1.02);
                    opacity: 0.85;
                }
            }
        `,document.head.appendChild(t),console.debug("[animation] CSS анимация пульсации добавлена"))}setGenerateButtonLoading(e,i){if(this.formButton){this.injectPulseAnimation();var o=this.formButton;let t=o.querySelector(".tn-atom");var s=(t=t||o.querySelector("div, span"))||o;e?(o.style.opacity="0.7",o.style.cursor="not-allowed",o.style.pointerEvents="none",i&&(s.textContent=i),o.style.animation="cartButtonPulse 1.5s ease-in-out infinite",console.debug("[generate] [animation] Кнопка заблокирована:",i)):(o.style.opacity="1",o.style.cursor="pointer",o.style.pointerEvents="auto",o.style.animation="none",i&&(s.textContent=i),console.debug("[generate] [animation] Кнопка разблокирована:",i))}}setControlsDisabled(t){let e=t?"0.5":"1",i=t?"none":"auto",o=t?"not-allowed":"pointer";this.changeSideButton&&(this.changeSideButton.style.opacity=e,this.changeSideButton.style.pointerEvents=i,this.changeSideButton.style.cursor=o),this.colorBlocks.forEach(t=>{t=t.parentElement;t&&(t.style.opacity=e,t.style.pointerEvents=i,t.style.cursor=o)}),this.productBlocks.forEach(t=>{t=t.parentElement;t&&(t.style.opacity=e,t.style.pointerEvents=i,t.style.cursor=o)}),console.debug("[controls] Элементы управления "+(t?"заблокированы":"разблокированы"))}initUploadImageButton(){this.editorUploadImageButton&&(this.resetUserUploadImage(),this.editorUploadImageButton.style.cursor="pointer",this.editorUploadImageButton.addEventListener("click",()=>{this.uploadUserImage()}))}initFixQuantityForm(){if(this.quantityFormBlock){var t;let e=this.quantityFormBlock.querySelector("form")?.querySelector('input[name="quantity"]');e&&(t=()=>{var t=e.value.trim();(""===t||isNaN(Number(t))||(t=parseInt(t,10))<1||0===t)&&(e.value="1")},e.addEventListener("input",t),e.addEventListener("blur",t),e.addEventListener("change",t),t())}}async initForm(){if(this.formBlock&&this.formButton&&this.formInputVariableName){let a=this.formBlock,e=this.formInputVariableName;var t=this.formButton;let i=async()=>{if(console.debug("[form] [button] clicked"),this.isGenerating)console.warn("[form] Генерация уже идет, игнорируем повторное нажатие");else{var t=a.querySelector(`[name="${e}"]`),i=t.value;if(this.loadedUserImage||i&&""!==i.trim()&&!(i.length<1)){console.debug("[form] [input] prompt: "+i),this.isGenerating=!0,this.setGenerateButtonLoading(!0,"Генерация..."),this.setControlsDisabled(!0),this.emit(n.MOCKUP_LOADING,!0);let e=this._selectLayout||l.Layout.generateId();try{var o=await(0,c.generateImage)({uri:this.apiConfig.webhookRequest,prompt:i,shirtColor:this._selectColor.name,image:!this._selectLayout||this.loadedUserImage!==this.layouts.find(t=>t.id===this._selectLayout)?.url?this.loadedUserImage:null,withAi:this.editorLoadWithAi,layoutId:e,isNew:!this._selectLayout,background:!this.editorRemoveBackground});try{window.ym(103279214,"reachGoal","generated")}catch(t){}this.emit(n.MOCKUP_LOADING,!1);var s,r=await this.getImageData(o);console.debug("[form] [input] image data received"),this._selectLayout?(s=this.layouts.find(t=>t.id===e))&&s.isImageLayout()&&(console.debug("[form] [input] updating layout: "+s.id),s.name=i,s.url=r,console.debug("[form] [input] layout updated"),this.isRestoringFromHistory||this.saveLayersToHistory(),this.showLayoutList(),this.updateLayouts(),this.saveState(),this.saveLayouts().catch(t=>console.error("[layers] Ошибка сохранения слоёв:",t))):this.addLayout(l.Layout.createImage({id:e,view:this._selectSide,url:r,name:i,position:{x:0,y:0}})),t.style.borderColor="#f3f3f3",this._selectLayout=null,t.value="",this.cancelEditLayout(),this.resetUserUploadImage(),this.showLayoutList(),this.setGenerateButtonLoading(!1,"✓ Готово!"),this.setControlsDisabled(!1),setTimeout(()=>{this.setGenerateButtonLoading(!1,"Сгенерировать"),this.isGenerating=!1,console.debug("[form] Флаг isGenerating сброшен")},2e3)}catch(t){u("image_generation_error",{error:t instanceof Error?t.message:String(t),prompt:i,shirtColor:this._selectColor.name,withAi:this.editorLoadWithAi,isEditing:!!this._selectLayout}),this.emit(n.MOCKUP_LOADING,!1),console.error("[form] [input] error",t),alert("Ошибка при генерации изображения"),this.setGenerateButtonLoading(!1,"Сгенерировать"),this.setControlsDisabled(!1),this.isGenerating=!1}finally{this.loadedUserImage&&this.resetUserUploadImage(),this._selectLayout&&(this._selectLayout=null,this.cancelEditLayout())}}else console.warn("[form] [input] prompt is empty or too short"),alert("Минимальная длина запроса 1 символ")}};var o=await new Promise(e=>{let i=setInterval(()=>{var t=a.querySelector("form");t&&(clearInterval(i),e(t))},100);setTimeout(()=>{clearInterval(i),e(null)},1e4)});o?(o.action="",o.method="GET",o.onsubmit=t=>{t.preventDefault(),i()},(o=o.querySelector(`textarea[name='${e}']`))&&(o.style.padding="8px"),t.onclick=i,t.style.cursor="pointer",console.debug("[form] Инициализация формы завершена")):console.warn("[form] form not found")}}restoreIconFromDataOriginal(t){var e;t&&(e=t.attributes.getNamedItem("data-original")?.value)&&(t.style.backgroundImage=`url("${e}")`)}changeProduct(t){var e;this.isGenerating?console.warn("[changeProduct] Генерация в процессе, переключение заблокировано"):(this._selectType=t,this.clearMockupCache(),(e=this.getProductByType(t))&&!e.mockups.find(t=>t.side===this._selectSide&&t.color.name===this._selectColor.name)&&(e=e.mockups.find(t=>t.side===this._selectSide))&&(this._selectColor=e.color,console.debug(`[product] Цвет изменен на ${this._selectColor.name} для продукта `+t)),this.updateProductBlocksUI(),this.updateMockup(),this.loadProduct(),this.showLayoutList(),this.updateLayouts(),this.updateSum(),this.saveState())}updateProductBlocksUI(){var t;0!==this.productBlocks.length&&(this.productBlocks.forEach(t=>{t.style.background="rgb(222 222 222)"}),t=this.productBlocks.find(t=>t.classList.contains("editor-settings__product-block__"+this._selectType)))&&(t.style.background="")}changeSide(){var t;this.isGenerating?console.warn("[changeSide] Генерация в процессе, переключение заблокировано"):(t="front"===this._selectSide?"back":"front",this.setActiveSide(t),this.updateMockup(),this.showLayoutList(),this.updateLayouts(),this.saveState(),this.emit(n.STATE_CHANGED,void 0))}changeColor(e){var t;this.isGenerating?console.warn("[changeColor] Генерация в процессе, переключение заблокировано"):(t=this.getProductByType(this._selectType))&&(t=t.mockups.find(t=>t.color.name===e))&&(this._selectColor=t.color,this.clearMockupCache(),this.updateColorBlocksUI(e),this.updateMockup(),this.saveState())}updateColorBlocksUI(e){var t;0!==this.colorBlocks.length&&(this.colorBlocks.forEach(t=>{t.style.borderColor="#f3f3f3"}),t=this.colorBlocks.find(t=>t.classList.contains("editor-settings__color-block__"+e)))&&(t.style.borderColor="")}changeSize(t){this.updateSizeBlocksUI(t),this._selectSize=t,this.saveState()}updateSizeBlocksUI(e){var t,i;0!==this.sizeBlocks.length&&(this.sizeBlocks.forEach(t=>{t=t.firstElementChild;t&&(t.style.borderColor="#f3f3f3")}),t=this.sizeBlocks.find(t=>t.classList.contains("editor-settings__size-block__"+e)))&&(i=t.firstElementChild)&&(i.style.borderColor="")}editLayout(t){var e;console.debug("[settings] [layouts] edit layout "+t.id),this._selectLayout=t.id,this.formBlock&&this.formInputVariableName&&((e=this.formBlock.querySelector(`[name="${this.formInputVariableName}"]`))?(e.value=t.name||"",e.style.borderColor="rgb(254, 94, 58)",e.focus(),console.debug(`[settings] [layouts] Установлено значение в форму: "${t.name}"`)):console.warn(`[settings] [layouts] Не найден элемент формы с именем "${this.formInputVariableName}"`)),t.isImageLayout()?(this.loadedUserImage=t.url,this.setUserUploadImage(t.url),this.initAiButtons(),this.hideAiButtons()):(this.loadedUserImage=null,this.resetUserUploadImage()),this.showLayoutList()}cancelEditLayout(){var t;console.debug("[settings] [layouts] cancel edit layout"),this._selectLayout=null,this.formBlock&&this.formInputVariableName&&(t=this.formBlock.querySelector(`[name="${this.formInputVariableName}"]`))&&(t.value="",t.style.borderColor="#f3f3f3"),this.loadedUserImage=null,this.editorLoadWithAi=!1,this.showLayoutList(),console.debug("[settings] [layouts] Редактирование отменено")}initAiButtons(){this.editorLoadWithAi=!1,this.editorRemoveBackground=!1,this.changeLoadWithAi(),this.changeRemoveBackground(),this.editorLoadWithAiButton&&(this.editorLoadWithAiButton.style.cursor="pointer",this.editorLoadWithAiButton.onclick=()=>{this.changeLoadWithAi(!0)}),this.editorLoadWithoutAiButton&&(this.editorLoadWithoutAiButton.style.cursor="pointer",this.editorLoadWithoutAiButton.onclick=()=>{this.changeLoadWithAi(!1)}),this.editorRemoveBackgroundButton&&(this.editorRemoveBackgroundButton.style.cursor="pointer",this.editorRemoveBackgroundButton.onclick=()=>{this.changeRemoveBackground(!this.editorRemoveBackground)})}hideAiButtons(){this.editorLoadWithAi=!0,this.editorLoadWithAiButton&&((this.editorLoadWithAiButton.parentElement?.parentElement?.parentElement).style.display="none")}showAiButtons(){this.editorLoadWithAiButton&&((this.editorLoadWithAiButton.parentElement?.parentElement?.parentElement).style.display="flex")}uploadUserImage(){console.debug("[upload user image] starting user image upload"),this.showAiButtons();var t=document.createElement("input");t.type="file",t.accept="image/*",t.style.display="none",t.onchange=t=>{var e,t=t.target.files?.[0];t&&(console.debug("[upload user image] file selected:",t.name),t.type.startsWith("image/")?((e=new FileReader).onload=async t=>{t=t.target?.result,console.debug("[upload user image] file loaded as data URL"),t=await this.getImageData(t);this.setUserUploadImage(t),console.debug("[upload user image] image layout added successfully")},e.onerror=()=>{console.error("[upload user image] error reading file"),alert("Ошибка при загрузке файла")},e.readAsDataURL(t)):(console.warn("[upload user image] selected file is not an image"),alert("Пожалуйста, выберите файл изображения")))},document.body.appendChild(t),t.click(),document.body.removeChild(t)}setUserUploadImage(t){var e;this.loadedUserImage=t,this.editorUploadViewBlock&&(this.editorUploadViewBlock.style.display="table",e=(0,d.getLastChild)(this.editorUploadViewBlock))&&(e.style.backgroundImage=`url(${t})`,e.style.backgroundSize="contain",e.style.backgroundPosition="center",e.style.backgroundRepeat="no-repeat")}resetUserUploadImage(){this.editorUploadViewBlock&&(this.editorUploadViewBlock.style.display="none"),this.loadedUserImage=null,this.cancelEditLayout()}changeLoadWithAi(t=!1){var e,i,o;console.debug("[ai buttons] changeLoadWithAi вызван, value="+t),this.editorLoadWithAi=t,this.editorLoadWithAiButton&&this.editorLoadWithoutAiButton&&(e=this.editorLoadWithAiButton,i=this.editorLoadWithoutAiButton,t?(t=e.firstElementChild,o=i.firstElementChild,t&&(t.style.borderColor="",console.debug("[ai buttons] С ИИ: сброшен borderColor (оранжевый)")),o&&(o.style.borderColor="#f2f2f2",console.debug("[ai buttons] Без ИИ: установлен borderColor=#f2f2f2 (серый)"))):(t=e.firstElementChild,o=i.firstElementChild,t&&(t.style.borderColor="#f2f2f2",console.debug("[ai buttons] С ИИ: установлен borderColor=#f2f2f2 (серый)")),o&&(o.style.borderColor="",console.debug("[ai buttons] Без ИИ: сброшен borderColor (оранжевый)")))),this.updateRemoveBackgroundVisibility()}changeRemoveBackground(t=!1){var e;console.debug("[remove bg button] changeRemoveBackground вызван, value="+t),this.editorRemoveBackground=t,this.editorRemoveBackgroundButton&&(e=this.editorRemoveBackgroundButton.firstElementChild)&&(t?(e.style.borderColor="",console.debug("[remove bg button] Убрать фон: сброшен borderColor (оранжевый)")):(e.style.borderColor="#f2f2f2",console.debug("[remove bg button] Убрать фон: установлен borderColor=#f2f2f2 (серый)")))}updateRemoveBackgroundVisibility(){var t;this.editorRemoveBackgroundButton&&(t=this.editorRemoveBackgroundButton.parentElement)&&(this.editorLoadWithAi?(t.style.display="none",this.changeRemoveBackground(!1),console.debug("[remove bg button] Кнопка скрыта (С ИИ выбрано)")):(t.style.display="",console.debug("[remove bg button] Кнопка показана (Без ИИ выбрано)")))}loadImage(o){return new Promise((t,e)=>{let i=new Image;i.crossOrigin="anonymous",i.onload=()=>t(i),i.onerror=e,i.src=o})}getQuantity(){var t;return this.quantityFormBlock&&(t=this.quantityFormBlock.querySelector("form")?.querySelector('input[name="quantity"]'))&&parseInt(t.value)||1}getSum(){var t=this.layouts.some(t=>"front"===t.view),e=this.layouts.some(t=>"back"===t.view),i=this.getProductByType(this._selectType);return i?e&&t?i.doubleSidedPrice:i.price:0}updateSum(){var t,e;this.editorSumBlock&&(t=this.getSum(),(e=(0,d.getLastChild)(this.editorSumBlock))&&(e.innerText=t.toString()+" ₽"),this.editorAddOrderButton)&&(e=(0,d.getLastChild)(this.editorAddOrderButton))&&(e.style.backgroundColor=0===t?"rgb(121 121 121)":"")}loadProduct(){var t=this.getProductByType(this._selectType);if(t&&t.printConfig){this.clearAllCanvas();for(var e of t.printConfig)this.createCanvasForSide(e);this.setActiveSide(this._selectSide),setTimeout(()=>{this.isLoading=!1,this.emit(n.MOCKUP_LOADING,!1)},100)}else console.warn("[product] product or printConfig not found")}clearAllCanvas(){this.canvasesContainer&&(this.canvasesContainer.innerHTML=""),this.canvases.forEach(t=>{try{t.dispose()}catch(t){console.error("[canvas] Ошибка очистки canvas:",t)}}),this.canvases=[],this.layersCanvases=[],this.activeCanvas=null}handleWindowResize(){console.debug("[canvas] Изменение размера окна");let e=this.editorBlock.clientWidth,i=this.editorBlock.clientHeight;this.canvases.forEach(t=>{t.setWidth(e),t.setHeight(i)}),this.layersCanvases.forEach(t=>{t.setWidth(e),t.setHeight(i)});var t=this.getProductByType(this._selectType);t&&t.printConfig.forEach(e=>{var t=this.canvases.find(t=>t.side===e.side);t&&this.updatePrintArea(t,e)}),this.canvases.forEach(e=>{let i=e.side;var t=e.getObjects();let o=[];t.forEach(t=>{"area:border"===t.name||"area:clip"===t.name||t.name?.startsWith("guideline")||o.push(t)}),o.forEach(t=>e.remove(t)),console.debug(`[canvas] Удалено ${o.length} объектов для перерисовки на стороне `+i),this.layouts.filter(t=>t.view===i).forEach(t=>{this.addLayoutToCanvas(t)}),e.requestRenderAll()}),console.debug("[canvas] Размер изменен:",{width:e,height:i})}updatePrintArea(t,e){var i=e.size.width/600*this.editorBlock.clientWidth,o=e.size.height/600*this.editorBlock.clientHeight,s=(this.editorBlock.clientWidth-i)/2+e.position.x/100*this.editorBlock.clientWidth,e=(this.editorBlock.clientHeight-o)/2+e.position.y/100*this.editorBlock.clientHeight,r=t.clipPath,r=(r&&r.set({width:i,height:o,left:s,top:e}),this.getObject("area:border",t));r&&r.set({width:i-3,height:o-3,left:s,top:e}),t.requestRenderAll()}createCanvasForSide(t){var e,i;this.canvasesContainer?((e=document.createElement("canvas")).id="layers--"+t.side,e.classList.add("editor-position"),e.setAttribute("ref",t.side),e.style.zIndex="7",this.canvasesContainer.appendChild(e),(e=new fabric.StaticCanvas(e,{width:this.editorBlock.clientWidth,height:this.editorBlock.clientHeight})).side=t.side,e.name="static-"+t.side,(i=document.createElement("canvas")).id="editable--"+t.side,i.setAttribute("ref",t.side),i.classList.add("editor-position"),i.style.zIndex="9",this.canvasesContainer.appendChild(i),(i=new fabric.Canvas(i,{controlsAboveOverlay:!0,width:this.editorBlock.clientWidth,height:this.editorBlock.clientHeight,backgroundColor:"transparent",uniformScaling:!0})).side=t.side,i.name="editable-"+t.side,this.layersCanvases.push(e),this.canvases.push(i),1===this.canvases.length&&(this.activeCanvas=i),this.initMainCanvas(i,t)):console.error("[canvas] canvasesContainer не инициализирован")}initMainCanvas(t,e){var i,o,s,r,a;t&&t instanceof fabric.Canvas?(a=e.size.width/600*this.editorBlock.clientWidth,i=e.size.height/600*this.editorBlock.clientHeight,o=(this.editorBlock.clientWidth-a)/2+e.position.x/100*this.editorBlock.clientWidth,s=(this.editorBlock.clientHeight-i)/2+e.position.y/100*this.editorBlock.clientHeight,r=new fabric.Rect({width:a,height:i,left:o,top:s,fill:"rgb(255, 0, 0)",name:"area:clip",evented:!1}),a=new fabric.Rect({width:a-3,height:i-3,left:o,top:s,fill:"rgba(0,0,0,0)",strokeWidth:3,stroke:"rgb(254, 94, 58)",name:"area:border",opacity:.3,evented:!1,selectable:!1,hasControls:!1,strokeDashArray:[5,5]}),t.add(a),t.clipPath=r,this.setupCanvasEventHandlers(t,e)):console.warn("[canvas] canvas не валиден")}setupCanvasEventHandlers(e,i){e.on("mouse:down",()=>{var t=this.getObject("area:border",e);t&&(t.set("opacity",.8),e.requestRenderAll())}),e.on("mouse:up",()=>{var t=this.getObject("area:border",e);t&&(t.set("opacity",.3),e.requestRenderAll())}),e.on("object:rotating",t=>{if(void 0!==t.target?.angle){var e,i=t.target.angle%360;for(e of[0,90,180,270])Math.abs(i-e)<5&&t.target.rotate(e)}}),e.on("object:moving",t=>{this.handleObjectMoving(t,e,i)}),e.on("object:modified",t=>{this.handleObjectModified(t,e,i)})}handleObjectMoving(e,t,i){var o,s,r,a,n,l;e.target&&"area:border"!==e.target.name&&"area:clip"!==e.target.name&&(a=this.layouts.find(t=>t.id===e.target.name))&&(o=this.getProductByType(this._selectType))&&(a=(0,h.calculateLayoutDimensions)(a,o,this.editorBlock.clientWidth,this.editorBlock.clientHeight),o=e.target.width*e.target.scaleX,s=e.target.height*e.target.scaleY,n=e.target.left+o/2,l=e.target.top+s/2,r=a.printAreaLeft+a.printAreaWidth/2,a=a.printAreaTop+a.printAreaHeight/2,n=Math.abs(n-r)<7,l=Math.abs(l-a)<7,n?(this.showGuideline(t,"vertical",r,0,r,this.editorBlock.clientHeight),e.target.set({left:r-o/2})):this.hideGuideline(t,"vertical"),l?(this.showGuideline(t,"horizontal",0,a,this.editorBlock.clientWidth,a),e.target.set({top:a-s/2})):this.hideGuideline(t,"horizontal"))}handleObjectModified(t,e,i){let o=t.target;var s;o&&(this.hideGuideline(e,"vertical"),this.hideGuideline(e,"horizontal"),t=this.layouts.find(t=>t.id===o.name))&&(e=this.getProductByType(this._selectType))&&(e=(0,h.calculateLayoutDimensions)(t,e,this.editorBlock.clientWidth,this.editorBlock.clientHeight),t.position.x=(o.left-e.printAreaLeft)/e.printAreaWidth,t.position.y=(o.top-e.printAreaTop)/e.printAreaHeight,t.size=o.scaleX,t.aspectRatio=o.scaleY/o.scaleX,t.angle=o.angle,s=o.width*o.scaleX,t._relativeWidth=s=s/e.printAreaWidth,console.debug(`[canvas] Layout ${t.id} updated: position=(${t.position.x.toFixed(3)}, ${t.position.y.toFixed(3)}), size=${t.size.toFixed(3)}, relativeWidth=`+s.toFixed(3)),this.saveLayouts().catch(t=>console.error("[layers] Ошибка сохранения слоёв:",t)))}showGuideline(t,e,i,o,s,r){e="guideline:"+e;this.getObject(e,t)||(i=new fabric.Line([i,o,s,r],{stroke:"rgb(254, 94, 58)",strokeWidth:2,strokeDashArray:[5,5],selectable:!1,evented:!1,name:e}))&&t.add(i)}hideGuideline(t,e){e=this.getObject("guideline:"+e,t);e&&t.remove(e)}getObject(e,t){t=t||this.activeCanvas||this.canvases[0];if(t)return t.getObjects().find(t=>t.name===e)}setActiveSide(o){console.debug("[canvas] Установка активной стороны:",o),this.canvases.forEach(t=>{var e=t.getElement(),i=e.parentElement;t.side===o?(this.activeCanvas=t,i&&(i.style.pointerEvents="auto",i.style.display="block"),e.style.display="block"):(i&&(i.style.pointerEvents="none",i.style.display="none"),e.style.display="none")}),this.layersCanvases.forEach(t=>{t.getElement().style.display=t.side===o?"block":"none"}),this._selectSide=o}async addLayoutToCanvas(e){var t,i=this.canvases.find(t=>t.side===e.view);i?(t=this.getProductByType(this._selectType))&&(t=await(0,h.renderLayout)({layout:e,product:t,containerWidth:this.editorBlock.clientWidth,containerHeight:this.editorBlock.clientHeight,loadImage:this.loadImage.bind(this)}))&&i.add(t):console.warn(`[canvas] canvas для ${e.view} не найден`)}updateLayouts(){this.activeCanvas&&this.updateLayoutsForSide(this._selectSide)}updateLayoutsForSide(e){let r=this.canvases.find(t=>t.side===e);if(r){let i=r.getObjects();i.filter(t=>"area:border"!==t.name&&"area:clip"!==t.name&&!t.name?.startsWith("guideline")).filter(e=>!this.layouts.find(t=>t.id===e.name)).forEach(t=>{r.remove(t)});var t=this.layouts.filter(t=>t.view===e);let o=[],s=[];t.forEach(e=>{var t=i.find(t=>t.name===e.id);t?e.isImageLayout()&&t.layoutUrl!==e.url&&(console.debug(`[canvas] Layout ${e.id} изменился, требуется обновление`),o.push(e)):s.push(e)}),o.forEach(e=>{var t=i.find(t=>t.name===e.id);t&&(console.debug("[canvas] Удаляем старый объект для обновления: "+e.id),r.remove(t)),console.debug("[canvas] Добавляем обновленный объект: "+e.id),this.addLayoutToCanvas(e)}),s.forEach(t=>{this.addLayoutToCanvas(t)}),r.renderAll()}}async preloadAllMockups(){console.debug("[preload] Начало предзагрузки mockups");for(var t of this.productConfigs)for(var e of t.mockups)try{var i=await this.getImageData(e.url);e.url=i,console.debug("[preload] Mockup загружен: "+e.color.name)}catch(t){console.error(`[preload] Ошибка загрузки mockup ${e.url}:`,t)}console.debug("[preload] Предзагрузка завершена")}async getImageData(t){return this.loadAndConvertImage(t)}async uploadImage(r){return console.debug("[upload] Загрузка файла:",r.name),new Promise((o,s)=>{var t=new FileReader;t.onload=async t=>{try{var e=t.target?.result,i=await this.getImageData(e);console.debug("[upload] Файл успешно загружен"),o(i)}catch(t){u("load_file",{error:t instanceof Error?t.message:String(t),file_name:r.name}),console.error("[upload] Ошибка обработки файла:",t),s(t)}},t.onerror=()=>{console.error("[upload] Ошибка чтения файла"),s(new Error("Не удалось прочитать файл"))},t.readAsDataURL(r)})}async uploadImageToServer(t){console.debug("[upload] Загрузка изображения на сервер");var e=await this.storageManager.getUserId(),t=await(await fetch(this.apiConfig.uploadImage,{method:"POST",body:JSON.stringify({image:t,user_id:e}),headers:{"Content-Type":"application/json"}})).json();return console.debug("[upload] Изображение загружено на сервер:",t.image_url),t.image_url}getProductName(){return this.getProductByType(this._selectType)?.productName||""}capitalizeFirstLetter(t){return t.charAt(0).toUpperCase()+t.slice(1)}getMockupUrl(e){var t=this.getProductByType(this._selectType);return(t=t&&t.mockups.find(t=>t.side===e&&t.color.name===this._selectColor.name))?t.url:null}async exportArt(i=!0,o=1024){let e={};var t=this.getSidesWithLayers(),t=(console.debug("[export] Найдены стороны с слоями:",t,"(front первый)",i?"с мокапом":"без мокапа",`разрешение: ${o}px`),t.map(async e=>{try{var t=await this.exportSide(e,i,o);if(t)return console.debug(`[export] Сторона ${e} успешно экспортирована`),{side:e,data:t}}catch(t){console.error(`[export] Ошибка при экспорте стороны ${e}:`,t),u("export_side_error",{error:t instanceof Error?t.message:String(t),side:e,withMockup:i,resolution:o})}return null}));return(await Promise.all(t)).forEach(t=>{t&&(e[t.side]=t.data)}),console.debug(`[export] Экспорт завершен для ${Object.keys(e).length} сторон`),e}getSidesWithLayers(){return[...new Set(this.layouts.map(t=>t.view))].sort((t,e)=>"front"===t?-1:"front"===e?1:0)}async exportSide(e,t=!0,i=1024){var o,s,r,a,n,l,d,c=this.getCanvasesForSide(e);return c.editableCanvas?(this.updateLayoutsForSide(e),console.debug(`[export] Экспортируем сторону ${e}${t?" с мокапом":" без мокапа"} (${i}px)...`),t?(t=await this.loadMockupForSide(e))?(d=this.getProductByType(this._selectType)?.printConfig.find(t=>t.side===e))?({canvas:t,ctx:o,mockupDimensions:s}=this.createExportCanvas(i,t),r=await this.exportDesignWithClipPath(c.editableCanvas,c.layersCanvas,e,i),a=d.size.width/600*s.width,n=d.size.height/600*s.height,l=s.x+(s.width-a)/2+d.position.x/100*s.width,d=s.y+(s.height-n)/2+d.position.y/100*s.height,o.drawImage(r,0,0,r.width,r.height,l,d,a,n),console.debug(`[export] Наложен обрезанный дизайн (clipPath) на мокап для ${e} в области печати (${Math.round(l)}, ${Math.round(d)}, ${Math.round(a)}x${Math.round(n)})`),t.toDataURL("image/png",1)):(console.warn("[export] Не найдена конфигурация печати для "+e),null):null:(s=await this.exportDesignWithClipPath(c.editableCanvas,c.layersCanvas,e,i),console.debug(`[export] Экспортирован чистый дизайн для ${e} (обрезан по clipPath)`),s.toDataURL("image/png",1))):(console.warn(`[export] Canvas для стороны ${e} не найден`),null)}getCanvasesForSide(e){return{editableCanvas:this.canvases.find(t=>t.side===e),layersCanvas:this.layersCanvases.find(t=>t.side===e)}}async loadMockupForSide(t){var e,i=this.getMockupUrl(t);return i?(e=await this.loadImage(i),console.debug(`[export] Загружен мокап для ${t}: `+i),e):(console.warn(`[export] Мокап для стороны ${t} не найден`),null)}createExportCanvas(t,e){var i=document.createElement("canvas"),o=i.getContext("2d"),s=(i.width=t,i.height=t,Math.min(t/e.width,t/e.height)),r=e.width*s,s=e.height*s,a=(t-r)/2,t=(t-s)/2;return o.drawImage(e,a,t,r,s),console.debug(`[export] Нарисован мокап как фон (${r}x${s})`),{canvas:i,ctx:o,mockupDimensions:{x:a,y:t,width:r,height:s}}}async createDesignCanvas(t,e,i){var o=t.getWidth(),s=t.getHeight(),r=document.createElement("canvas"),a=r.getContext("2d");return r.width=10*o,r.height=10*s,await this.addStaticLayersToCanvas(e,a,r,i),await this.addEditableObjectsToCanvas(t,a,r,o,s,i),r}async addStaticLayersToCanvas(t,e,i,o){if(t)try{var s,r=t.toDataURL({format:"png",multiplier:10,quality:1}),a="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==";r!==a&&r.length>a.length&&(s=await this.loadImage(r),e.drawImage(s,0,0,i.width,i.height),console.debug("[export] Добавлены статические слои для "+o))}catch(t){console.warn(`[export] Ошибка экспорта статических слоев для ${o}:`,t)}}async addEditableObjectsToCanvas(t,e,i,o,s,r){try{var a,n=new fabric.StaticCanvas(null,{width:o,height:s,backgroundColor:"transparent"}),l=(t.clipPath&&(a=await new Promise(e=>{t.clipPath.clone(t=>e(t))}),n.clipPath=a,console.debug("[export] Применён clipPath для экспорта стороны "+r)),this.filterDesignObjects(t.getObjects()));for(let t of l){var d=await new Promise(e=>{t.clone(t=>e(t))});n.add(d)}var c,h=n.toDataURL({format:"png",multiplier:10,quality:1}),u="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==";h!==u&&h.length>u.length&&(c=await this.loadImage(h),e.drawImage(c,0,0,i.width,i.height),console.debug("[export] Добавлены объекты дизайна без границ для "+r)),n.dispose()}catch(t){console.warn(`[export] Ошибка создания дизайна без границ для ${r}:`,t)}}filterDesignObjects(t){let e=new Set(["area:border","area:clip","guideline","guideline:vertical","guideline:horizontal"]);return t.filter(t=>!e.has(t.name))}async exportDesignWithClipPath(t,e,i,o){var s=t.clipPath;if(!s)return console.warn("[export] clipPath не найден, экспортируем весь canvas"),this.createDesignCanvas(t,e,i);var r=s.width,a=s.height,n=s.left,s=s.top,t=(console.debug(`[export] clipPath: ${r}x${a} at (${n}, ${s})`),await this.createDesignCanvas(t,e,i)),e=o/Math.max(r,a),i=document.createElement("canvas");i.width=r*e,i.height=a*e;return i.getContext("2d").drawImage(t,10*n,10*s,10*r,10*a,0,0,i.width,i.height),console.debug(`[export] Дизайн обрезан по clipPath: ${i.width}x${i.height}px`),i}async uploadDesignToServer(t){try{console.debug("[export] Загрузка дизайна на сервер");var e,i,o=new FormData;for([e,i]of Object.entries(t)){var s=await(await fetch(i)).blob();o.append(e,s,e+".png")}return console.warn("[export] Загрузка на сервер не реализована"),t}catch(t){return console.error("[export] Ошибка при загрузке на сервер:",t),null}}saveLayersToHistory(){this.currentHistoryIndex<this.layersHistory.length-1&&(this.layersHistory=this.layersHistory.slice(0,this.currentHistoryIndex+1));var t={layers:JSON.parse(JSON.stringify(this.layouts)).map(t=>new l.Layout(t)),timestamp:Date.now()};this.layersHistory.push(t),this.currentHistoryIndex=this.layersHistory.length-1;50<this.layersHistory.length&&(this.layersHistory.shift(),this.currentHistoryIndex--),console.debug(`[history] Сохранено состояние слоёв. Индекс: ${this.currentHistoryIndex}, Всего: ${this.layersHistory.length}, Слоёв: `+this.layouts.length),this.updateHistoryButtonsState()}canUndo(){return this.currentHistoryIndex===this.layersHistory.length-1?2<=this.layersHistory.length:0<this.currentHistoryIndex}canRedo(){return this.currentHistoryIndex<this.layersHistory.length-1}updateHistoryButtonsState(){var t,e=this.canUndo(),i=this.canRedo();this.editorHistoryUndoBlock&&this.editorHistoryUndoBlock.firstElementChild&&(t=this.editorHistoryUndoBlock.firstElementChild,e?(t.style.backgroundColor="",t.style.cursor="pointer"):(t.style.backgroundColor="#f2f2f2",t.style.cursor="default")),this.editorHistoryRedoBlock&&this.editorHistoryRedoBlock.firstElementChild&&(t=this.editorHistoryRedoBlock.firstElementChild,i?(t.style.backgroundColor="",t.style.cursor="pointer"):(t.style.backgroundColor="#f2f2f2",t.style.cursor="default")),console.debug("[history] Состояние кнопок: undo =",e,", redo =",i)}async undo(){if(!this.canUndo())return console.debug("[history] Undo невозможен"),!1;this.currentHistoryIndex===this.layersHistory.length-1&&2<=this.layersHistory.length?this.currentHistoryIndex=this.layersHistory.length-2:this.currentHistoryIndex=Math.max(0,this.currentHistoryIndex-1);var t=this.layersHistory[this.currentHistoryIndex];return t?(console.debug(`[history] Undo к индексу ${this.currentHistoryIndex} из `+(this.layersHistory.length-1)),await this.restoreLayersFromHistory(t),this.updateHistoryButtonsState(),!0):(console.warn("[history] История не найдена"),!1)}async redo(){if(!this.canRedo())return console.debug("[history] Redo невозможен"),!1;this.currentHistoryIndex++;var t=this.layersHistory[this.currentHistoryIndex];return t?(console.debug(`[history] Redo к индексу ${this.currentHistoryIndex} из `+(this.layersHistory.length-1)),await this.restoreLayersFromHistory(t),this.updateHistoryButtonsState(),!0):(console.warn("[history] История не найдена"),!1)}async restoreLayersFromHistory(t){this.isRestoringFromHistory=!0;try{this.layouts=[],t.layers.forEach(t=>{this.layouts.push(new l.Layout(t))}),this.showLayoutList(),this.updateLayouts(),this.updateSum(),await this.saveState(),console.debug(`[history] Восстановлено ${this.layouts.length} слоёв`)}finally{this.isRestoringFromHistory=!1}}destroy(){console.debug("[editor] Очистка ресурсов редактора"),this.loadingInterval&&(clearInterval(this.loadingInterval),this.loadingInterval=null),this.events.destroy(),this.canvases.forEach(t=>{try{t.dispose()}catch(t){console.error("[cleanup] Ошибка очистки canvas:",t)}}),this.canvases=[],this.layersCanvases.forEach(t=>{try{t.dispose()}catch(t){console.error("[cleanup] Ошибка очистки layer canvas:",t)}}),this.layersCanvases=[],console.debug("[editor] Ресурсы успешно очищены")}getCurrentState(){return{type:this._selectType,color:this._selectColor,side:this._selectSide,size:this._selectSize,layouts:this.layouts,isLoading:this.isLoading}}}},"./src/managers/EditorStorageManager.ts":
/*!**********************************************!*\
  !*** ./src/managers/EditorStorageManager.ts ***!
  \**********************************************/(t,e,i)=>{i.r(e),i.d(e,{EditorStorageManager:()=>o});class o{constructor(){this.database=null,this.isReady=!1,this.readyPromise=this.init()}async init(){return new Promise((t,e)=>{let i=indexedDB.open("editor",2);i.onupgradeneeded=t=>{t=t.target.result;t.objectStoreNames.contains("history")||t.createObjectStore("history",{keyPath:"id"}),t.objectStoreNames.contains("editor_state")||t.createObjectStore("editor_state",{keyPath:"key"}),t.objectStoreNames.contains("user_data")||t.createObjectStore("user_data",{keyPath:"key"})},i.onerror=()=>{console.error("Ошибка открытия IndexedDB",i.error),e(i.error)},i.onsuccess=()=>{this.database=i.result,this.isReady=!0,t()}})}async waitForReady(){await this.readyPromise}async saveEditorState(t){if(await this.waitForReady(),!this.database)throw new Error("Database не инициализирована");var e=this.database.transaction(["editor_state"],"readwrite").objectStore("editor_state");await Promise.all([this.putData(e,"date",t.date),this.putData(e,"color",t.color),this.putData(e,"side",t.side),this.putData(e,"type",t.type),this.putData(e,"size",t.size)])}async loadEditorState(){if(await this.waitForReady(),!this.database)throw new Error("Database не инициализирована");var t=this.database.transaction(["editor_state"],"readonly").objectStore("editor_state");try{var[e,i,o,s,r]=await Promise.all([this.getData(t,"date"),this.getData(t,"color"),this.getData(t,"side"),this.getData(t,"type"),this.getData(t,"size")]);return e&&i&&o&&s&&r?{date:e,color:i,side:o,type:s,size:r}:null}catch(t){return console.error("Ошибка загрузки состояния редактора:",t),null}}async clearEditorState(){if(await this.waitForReady(),!this.database)throw new Error("Database не инициализирована");var t=this.database.transaction(["editor_state"],"readwrite").objectStore("editor_state");await Promise.all([this.deleteData(t,"date"),this.deleteData(t,"color"),this.deleteData(t,"side"),this.deleteData(t,"type"),this.deleteData(t,"size")])}async getUserId(){if(await this.waitForReady(),!this.database)throw new Error("Database не инициализирована");var t=this.database.transaction(["user_data"],"readwrite").objectStore("user_data");let e=await this.getData(t,"userId");e||(e=crypto.randomUUID(),await this.putData(t,"userId",e));try{window.OpenReplay.setUserID(e)}catch(t){console.error("Ошибка установки ID пользователя в tracker:",t)}return e}async saveToHistory(t,e){if(await this.waitForReady(),!this.database)throw new Error("Database не инициализирована");let o={...t,id:crypto.randomUUID(),timestamp:Date.now(),description:e||"Изменения от "+(new Date).toLocaleString()};let s=this.database.transaction(["history"],"readwrite").objectStore("history");return await new Promise((t,e)=>{let i=s.add(o);i.onerror=()=>e(i.error),i.onsuccess=()=>t()}),o.id}async saveLayerOperation(t,e,i,o,s){if(await this.waitForReady(),!this.database)throw new Error("Database не инициализирована");let r={id:crypto.randomUUID(),timestamp:Date.now(),operation:t,layout:JSON.parse(JSON.stringify(e)),side:i,type:o,description:s||`${"add"===t?"Добавлен":"Удален"} слой: `+(e.name||e.type)};let a=this.database.transaction(["history"],"readwrite").objectStore("history");return await new Promise((t,e)=>{let i=a.add({...r,isLayerOperation:!0});i.onerror=()=>e(i.error),i.onsuccess=()=>t()}),r.id}async getLayerHistory(o,s=50){if(await this.waitForReady(),!this.database)throw new Error("Database не инициализирована");let r=this.database.transaction(["history"],"readonly").objectStore("history");return new Promise((e,t)=>{let i=r.getAll();i.onerror=()=>t(i.error),i.onsuccess=()=>{var t=i.result.filter(t=>t.isLayerOperation&&t.side===o.side&&t.type===o.type).map(t=>({id:t.id,timestamp:t.timestamp,operation:t.operation,layout:t.layout,side:t.side,type:t.type,description:t.description})).sort((t,e)=>e.timestamp-t.timestamp).slice(0,s);e(t)}})}async getRecentLayerOperations(t,e=10){return this.getLayerHistory(t,e)}async getHistory(o,s=50){if(await this.waitForReady(),!this.database)throw new Error("Database не инициализирована");let r=this.database.transaction(["history"],"readonly").objectStore("history");return new Promise((e,t)=>{let i=r.getAll();i.onerror=()=>t(i.error),i.onsuccess=()=>{var t=i.result.filter(t=>t.side===o.side&&t.type===o.type).sort((t,e)=>e.timestamp-t.timestamp).slice(0,s);e(t)}})}async getHistoryItem(o){if(await this.waitForReady(),!this.database)throw new Error("Database не инициализирована");let s=this.database.transaction(["history"],"readonly").objectStore("history");return new Promise((t,e)=>{let i=s.get(o);i.onerror=()=>e(i.error),i.onsuccess=()=>t(i.result||null)})}async deleteHistoryItem(o){if(await this.waitForReady(),!this.database)throw new Error("Database не инициализирована");let s=this.database.transaction(["history"],"readwrite").objectStore("history");await new Promise((t,e)=>{let i=s.delete(o);i.onerror=()=>e(i.error),i.onsuccess=()=>t()})}async clearHistory(t){if(await this.waitForReady(),!this.database)throw new Error("Database не инициализирована");var e;let o=this.database.transaction(["history"],"readwrite").objectStore("history");if(t)for(e of await this.getHistory(t,1e3))await this.deleteHistoryItem(e.id);else await new Promise((t,e)=>{let i=o.clear();i.onerror=()=>e(i.error),i.onsuccess=()=>t()})}async saveLayers(t){if(await this.waitForReady(),!this.database)throw new Error("Database не инициализирована");var e=this.database.transaction(["editor_state"],"readwrite").objectStore("editor_state");await this.putData(e,"layers",t)}async loadLayers(){if(await this.waitForReady(),!this.database)throw new Error("Database не инициализирована");try{var t=this.database.transaction(["editor_state"],"readonly").objectStore("editor_state");return await this.getData(t,"layers")||null}catch(t){return console.error("Ошибка загрузки слоёв:",t),null}}putData(o,s,r){return new Promise((t,e)=>{let i=o.put({key:s,value:r});i.onerror=()=>e(i.error),i.onsuccess=()=>t()})}getData(o,s){return new Promise((t,e)=>{let i=o.get(s);i.onerror=()=>e(i.error),i.onsuccess=()=>t(i.result?.value||null)})}deleteData(o,s){return new Promise((t,e)=>{let i=o.delete(s);i.onerror=()=>e(i.error),i.onsuccess=()=>t()})}}},"./src/models/Layout.ts":
/*!******************************!*\
  !*** ./src/models/Layout.ts ***!
  \******************************/(t,e,i)=>{i.r(e),i.d(e,{Layout:()=>s});let o={POSITION:{x:.5,y:.5},SIZE:1,ASPECT_RATIO:1,ANGLE:0,TEXT:"PrintLoop",FONT:{family:"Arial",size:12}};class s{constructor(t){this.id=t.id||s.generateId(),this.type=t.type,this.position=t.position||{...o.POSITION},this.size=this.validateSize(t.size??o.SIZE),this.aspectRatio=this.validateAspectRatio(t.aspectRatio??o.ASPECT_RATIO),this.view=t.view,this.angle=this.normalizeAngle(t.angle??o.ANGLE),this.name=t.name??null,this._relativeWidth=t._relativeWidth,"image"===t.type?this.url=t.url:"text"===t.type&&(this.text=t.text||o.TEXT,this.font=t.font?{...t.font}:{...o.FONT})}static generateId(){return"undefined"!=typeof crypto&&crypto.randomUUID?crypto.randomUUID():Date.now()+"-"+Math.random().toString(36).substring(2,11)}validateSize(t){return t<=0?(console.warn(`Invalid size ${t}, using default `+o.SIZE),o.SIZE):t}validateAspectRatio(t){return t<=0?(console.warn(`Invalid aspect ratio ${t}, using default `+o.ASPECT_RATIO),o.ASPECT_RATIO):t}normalizeAngle(t){t%=360;return t<0?360+t:t}isImageLayout(){return"image"===this.type&&void 0!==this.url}isTextLayout(){return"text"===this.type&&void 0!==this.text&&void 0!==this.font}setPosition(t,e){this.position={x:t,y:e}}move(t,e){this.position.x+=t,this.position.y+=e}setSize(t){this.size=this.validateSize(t)}rotate(t){this.angle=this.normalizeAngle(this.angle+t)}setAngle(t){this.angle=this.normalizeAngle(t)}setText(t){this.isTextLayout()&&(this.text=t)}setFont(t){this.isTextLayout()&&this.font&&(this.font={...this.font,...t})}clone(){var t;return"image"===this.type?(t={type:"image",url:this.url,position:{...this.position},size:this.size,aspectRatio:this.aspectRatio,view:this.view,angle:this.angle,name:this.name},(t=new s(t))._relativeWidth=this._relativeWidth,t):(t={type:"text",position:{...this.position},size:this.size,aspectRatio:this.aspectRatio,view:this.view,angle:this.angle,name:this.name},void 0!==this.text&&(t.text=this.text),void 0!==this.font&&(t.font={...this.font}),(t=new s(t))._relativeWidth=this._relativeWidth,t)}toJSON(){var t={id:this.id,type:this.type,position:this.position,size:this.size,aspectRatio:this.aspectRatio,view:this.view,angle:this.angle,name:this.name,_relativeWidth:this._relativeWidth};return"image"===this.type?{...t,url:this.url}:"text"===this.type?{...t,text:this.text,font:this.font}:t}static fromJSON(t){return new s(t)}static createImage(t){return new s({...t,type:"image"})}static createText(t){return new s({...t,type:"text"})}}},"./src/utils/TypedEventEmitter.ts":
/*!****************************************!*\
  !*** ./src/utils/TypedEventEmitter.ts ***!
  \****************************************/(t,e,i)=>{i.r(e),i.d(e,{TypedEventEmitter:()=>o});class o{constructor(){this.listeners=new Map}on(t,e){this.listeners.has(t)||this.listeners.set(t,new Set),this.listeners.get(t).add(e)}once(e,i){let o=t=>{i(t),this.off(e,o)};this.on(e,o)}off(t,e){var i=this.listeners.get(t);i&&(i.delete(e),0===i.size)&&this.listeners.delete(t)}emit(e,i){var t=this.listeners.get(e);t&&t.forEach(t=>{try{t(i)}catch(t){console.error(`[EventEmitter] Ошибка в обработчике события "${String(e)}":`,t)}})}removeAllListeners(t){t?this.listeners.delete(t):this.listeners.clear()}listenerCount(t){return this.listeners.get(t)?.size||0}hasListeners(t){return 0<this.listenerCount(t)}eventNames(){return Array.from(this.listeners.keys())}destroy(){this.listeners.clear()}}},"./src/utils/api.ts":
/*!**************************!*\
  !*** ./src/utils/api.ts ***!
  \**************************/(t,e,i)=>{i.r(e),i.d(e,{createProduct:()=>function({quantity:t,name:e,size:i,color:o,sides:s,article:r,price:a}){var n="698341642832_"+Date.now(),l=1<s.length?`<a target="_blank" href="${s[0]?.image_url}" target="_blank">${s[0]?.image_url.slice(-10)}</a>, <a target="_blank" href="${s[1]?.image_url}" target="_blank">${s[1]?.image_url.slice(-10)}</a>`:`<a target="_blank" href="${s[0]?.image_url}" target="_blank">${s[0]?.image_url.slice(-10)}</a>`,n={id:n,name:e,price:a,quantity:t,img:s[0]?.image_url,options:[{option:"Размер",variant:i},{option:"Дизайн",variant:l},{option:"Артикул",variant:r},{option:"Цвет",variant:o.name},{option:"Принт",variant:1==s.length?"Односторонний":"Двухсторонний"}]};if(console.debug("[cart] add product",n),"function"==typeof window.tcart__addProduct)try{window.tcart__addProduct(n);try{window.ym(103279214,"reachGoal","add_to_cart")}catch(t){}}catch(t){console.error("[cart] Ошибка при добавлении продукта в корзину",t)}else console.warn("[cart] Корзина Tilda не загружена.")},generateImage:()=>async function({uri:t,prompt:e,shirtColor:i,image:o,withAi:s,layoutId:r,isNew:a=!0,background:n=!0}){var l=new u.EditorStorageManager,l=await l.getUserId(),d=new FormData;d.set("userId",l),d.set("prompt",e),d.set("shirtColor",i),d.set("placement","center"),d.set("printSize","big"),d.set("transferType",""),d.set("request_type","generate"),d.set("background",n.toString()),r&&d.set("layoutId",r);if(o){console.debug("[generate image]",o);var[l,e]=o.split(","),i=l.split(":")[1].split(";")[0],c=(console.debug("[generate image] [type]",i),atob(e)),h=new Array(c.length);for(let t=0;t<c.length;t++)h[t]=c.charCodeAt(t);n=new Uint8Array(h);d.set("request_type","image"),d.set("user_image",new Blob([n],{type:"image/png"})),d.set("transferType",s?"ai":"no-ai")}a||d.set("request_type","edit");r=await fetch(t,{method:"POST",body:d}),o=await r.json();return o.image_url||o.image}});var u=i(/*! ../managers/EditorStorageManager */"./src/managers/EditorStorageManager.ts")},"./src/utils/canvasUtils.ts":
/*!**********************************!*\
  !*** ./src/utils/canvasUtils.ts ***!
  \**********************************/(t,e,i)=>{function l(e,t,i,o){var s,r,t=t.printConfig.find(t=>t.side===e.view);if(t)return s=t.size.width/600*i,r=t.size.height/600*o,i=Math.round((i-s)/2+t.position.x/100*i),t=Math.round((o-r)/2+t.position.y/100*o),{left:i+s*e.position.x,top:t+r*e.position.y,scaleX:e.size,scaleY:e.size*e.aspectRatio,angle:e.angle,printAreaWidth:s,printAreaHeight:r,printAreaLeft:i,printAreaTop:t};throw new Error("Print config not found for side: "+e.view)}i.r(e),i.d(e,{calculateLayoutDimensions:()=>l,renderLayout:()=>async function(e){var{layout:e,product:i,containerWidth:o,containerHeight:s,loadImage:r}=e,i=l(e,i,o,s),o=window.fabric;if(o){if(e.isImageLayout()){s=await r(e.url),r=new o.Image(s);let t=e.size;var a,n=e._relativeWidth;return n&&0<n?(a=i.printAreaWidth*n,t=a/s.width,console.debug(`[renderLayout] Адаптация к новому размеру: relativeWidth=${n.toFixed(3)}, targetWidth=${a.toFixed(1)}px, scale=`+t.toFixed(3))):1===e.size&&s.width>i.printAreaWidth?(t=i.printAreaWidth/s.width,e.size=t,a=s.width*t/i.printAreaWidth,e._relativeWidth=a,console.debug(`[renderLayout] Автоподгонка размера: ${s.width}px → ${i.printAreaWidth}px, scale=${t.toFixed(3)}, relativeWidth=`+a.toFixed(3))):n&&0!==n||(n=s.width*e.size/i.printAreaWidth,e._relativeWidth=n,console.debug("[renderLayout] Вычислен _relativeWidth для старого layout: "+n.toFixed(3))),r.set({left:i.left,top:i.top,scaleX:t,scaleY:t*e.aspectRatio,angle:i.angle,name:e.id,layoutUrl:e.url}),r}if(e.isTextLayout())return(s=new o.Text(e.text,{fontFamily:e.font.family,fontSize:e.font.size})).set({left:i.left,top:i.top,scaleX:i.scaleX,scaleY:i.scaleY,angle:i.angle,name:e.id}),s}else console.error("[renderLayout] fabric.js не загружен");return null},renderLayoutToCanvas:()=>async function(t,e,i,o,s,r){i=l(e,i,o,s);e.isImageLayout()?(o=await r(e.url),t.save(),t.translate(i.left,i.top),t.rotate(i.angle*Math.PI/180),s=o.width*i.scaleX,r=o.height*i.scaleY,t.drawImage(o,0,0,s,r),t.restore()):e.isTextLayout()&&(t.save(),t.translate(i.left,i.top),t.rotate(i.angle*Math.PI/180),t.font=e.font.size*i.scaleX+"px "+e.font.family,t.fillStyle="black",t.fillText(e.text,0,0),t.restore())}})},"./src/utils/tildaUtils.ts":
/*!*********************************!*\
  !*** ./src/utils/tildaUtils.ts ***!
  \*********************************/(t,e,i)=>{i.r(e),i.d(e,{getLastChild:()=>function t(e){if(!e)return null;if(!e.firstElementChild)return e;return t(e.firstElementChild)}})}},o={};function s(t){var e=o[t];return void 0!==e||(e=o[t]={exports:{}},i[t](e,e.exports,s)),e.exports}s.d=(t,e)=>{for(var i in e)s.o(e,i)&&!s.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:e[i]})},s.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),s.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})};var e={};{
/*!*******************************!*\
  !*** ./src/entries/editor.ts ***!
  \*******************************/
s.r(e),s.d(e,{default:()=>t});var r=s(/*! ../components/Editor */"./src/components/Editor.ts");"undefined"!=typeof window&&(window.Editor=r.default);let t=r.default}return e});