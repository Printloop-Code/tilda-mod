(()=>{var t,e,o,i,s={"./src/components/CardForm.ts":
/*!************************************!*\
  !*** ./src/components/CardForm.ts ***!
  \************************************/(t,e,o)=>{o.r(e),o.d(e,{CardForm:()=>i});let n={CART_CONTAINER:".t706__cartwin-products, .t-store__cart-products, .t-store",CART_PRODUCT:".t706__cartwin-product, .t-store__card, .t706__product",PRODUCT_TITLE:".t706__product-title, .t-store__card__title, .t706__product-name",PRODUCT_DEL_BUTTON:".t706__product-del",PRODUCT_PLUS_BUTTON:".t706__product-plus",PRODUCT_MINUS_BUTTON:".t706__product-minus",PRODUCT_PLUSMINUS:".t706__product-plusminus",PRODUCT_QUANTITY:".t706__product-quantity, .t-store__card__quantity",CART_COUNTER:".t706__carticon-counter, .t-store__counter",CART_AMOUNT:".t706__cartwin-prodamount, .t-store__total-amount"},l={CART_UPDATE:300,DOM_UPDATE:100,OBSERVER_CHECK:500,CART_LOAD_TIMEOUT:3e3};class d{static wait(e){return new Promise(t=>setTimeout(t,e))}static async waitForElement(e,o=10,i=100){for(let t=0;t<o;t++){var s=document.querySelector(e);if(s)return s;t<o-1&&await this.wait(i)}return null}static findProductElement(t){var e;for(e of document.querySelectorAll(n.CART_PRODUCT)){var o=e.querySelector(n.PRODUCT_TITLE);if(o&&o.textContent?.trim()===t.trim())return e}return null}}class i{constructor({cardBlockId:t,rules:e}){this.actionsStates=new Map,this.isUpdatingCart=!1,this.isApplyingActions=!1,this.cardBlock=document.querySelector(t),this.cardBlock||console.error(`Card block with id ${t} not found`),this.form=this.cardBlock.querySelector("form"),this.form?this.initForm():console.error(`Form block with id ${t} not found`),this.rules=e,this.fields=document.querySelectorAll(".t-input-group"),this.initRules(),this.initCartObserver()}initForm(){console.debug("[form] [init]",this.form.elements),this.form.addEventListener("input",async t=>{var e=t.target;let o=e?.name,i=e?.value;console.debug("[form] [input]",t),console.debug(i,"|",o);var e=this.rules.find(t=>t.variable===o);e&&(t=new Map(this.actionsStates),(e=e.actions.find(t=>t.value===i))?this.actionsStates.set(o,{value:i,action:e}):this.actionsStates.set(o,{value:"",action:null}),await this.applyActions(t))}),this.form.addEventListener("change",async t=>{var e=t.target;let o=e?.name,i=e?.value;console.debug("[form] [change]",t),console.debug(i,"|",o);var e=this.rules.find(t=>t.variable===o);e&&((t=e.actions.find(t=>t.value===i))?(e=new Map(this.actionsStates),this.actionsStates.set(o,{value:i,action:t}),await this.applyActions(e)):(t=new Map(this.actionsStates),this.actionsStates.set(o,{value:"",action:null}),await this.applyActions(t)))})}async initRules(){this.rules.forEach(t=>{if(t.alwaysActive&&0<t.actions.length)(o=t.actions[0])&&(this.actionsStates.set(t.variable,{value:o.value,action:o}),console.debug("[form] [initRules] Инициализировано постоянное правило:",t.variable,o));else{var o=this.form.elements.namedItem(t.variable);if(o){let e="";o instanceof RadioNodeList?(i=Array.from(o).find(t=>t.checked),e=i?.value||""):o instanceof HTMLSelectElement?e=o.value||"":o instanceof HTMLInputElement&&(e="radio"===o.type||"checkbox"===o.type?o.checked?o.value:"":o.value||""),console.debug("[form] [initRules] Поле:",t.variable,"Значение:",e);var i=t.actions.find(t=>t.value===e);i&&e&&(this.actionsStates.set(t.variable,{value:e,action:i}),console.debug("[form] [initRules] Инициализировано состояние для:",t.variable,i))}}}),await this.cleanupCartOnInit(),await this.applyActions()}async cleanupCartOnInit(){console.debug("[form] [cleanupCartOnInit] Начало очистки корзины"),await new Promise(e=>{let o=()=>{var t=window.tcart;t&&t.products?e(void 0):setTimeout(o,200)};o()});var t=window.tcart;if(t&&Array.isArray(t.products)){console.debug("[form] [cleanupCartOnInit] Товары в корзине:",t.products.map(t=>t.name));let e=new Set,o=(this.rules.forEach(t=>{t.actions.forEach(t=>{t.value&&e.add(t.value.trim())})}),new Set),i=(this.actionsStates.forEach(t=>{t.action&&t.action.value&&o.add(t.action.value.trim())}),console.debug("[form] [cleanupCartOnInit] Все товары из правил:",Array.from(e)),console.debug("[form] [cleanupCartOnInit] Активные товары:",Array.from(o)),[]);if(t.products.forEach(t=>{t=t.name?.trim();t&&e.has(t)&&!o.has(t)&&i.push(t)}),console.debug("[form] [cleanupCartOnInit] Товары для удаления:",i),0<i.length){for(var s of i)console.debug("[form] [cleanupCartOnInit] Удаляем:",s),await this.removeProductFromCart(s);console.debug("[form] [cleanupCartOnInit] ✓ Очистка завершена")}else console.debug("[form] [cleanupCartOnInit] Нет товаров для удаления");await this.hideQuantityControlsForRuleProducts()}else console.warn("[form] [cleanupCartOnInit] Корзина недоступна")}saveTildaCart(t){try{this.isUpdatingCart=!0,t.updated=Math.floor(Date.now()/1e3);var e={products:t.products||[],prodamount:t.prodamount||0,amount:t.amount||0,total:t.products?.length||0,updated:t.updated,currency:t.currency||"р.",currency_side:t.currency_side||"r",currency_sep:t.currency_sep||",",currency_dec:t.currency_dec||"",currency_txt:t.currency_txt||"р.",currency_txt_r:t.currency_txt_r||" р.",currency_txt_l:t.currency_txt_l||"",system:t.system||"none",settings:t.settings||{},delivery:t.delivery||{name:"nodelivery",price:0}};return localStorage.setItem("tcart",JSON.stringify(e)),console.debug("[form] [saveTildaCart] ✓ Корзина сохранена в localStorage"),setTimeout(()=>{this.isUpdatingCart=!1},100),!0}catch(t){return console.warn("[form] [saveTildaCart] Ошибка сохранения:",t),this.isUpdatingCart=!1}}initCartObserver(){console.debug("[form] [initCartObserver] Инициализация наблюдателя корзины");let e=this.getMainProductsQuantity(),s=()=>{var t=this.getMainProductsQuantity();t!==e&&(console.debug("[form] [cartObserver] Изменилось количество товаров:",{"было":e,"стало":t}),e=t,this.updateRuleProductsQuantity())},o=()=>{var t=document.querySelector(n.CART_CONTAINER);t?(new MutationObserver(()=>{console.debug("[form] [cartObserver] MutationObserver: обнаружены изменения"),setTimeout(()=>{var t=this.getMainProductsQuantity();t!==e&&(e=t,this.updateRuleProductsQuantity()),this.hideQuantityControlsForRuleProducts()},l.CART_UPDATE)}).observe(t,{childList:!0,subtree:!0}),console.debug("[form] [initCartObserver] ✓ MutationObserver установлен")):setTimeout(o,1e3)};o(),document.addEventListener("click",t=>{var t=t.target,e=t.closest(n.PRODUCT_DEL_BUTTON),e=(e&&(e=e.closest(n.CART_PRODUCT))&&(e=e.querySelector(n.PRODUCT_TITLE)?.textContent?.trim())&&(console.debug("[form] [cartObserver] Удаление товара:",e),this.handleRuleProductDeletion(e)),t.closest(`${n.PRODUCT_PLUS_BUTTON}, ${n.PRODUCT_MINUS_BUTTON}, `+n.PRODUCT_DEL_BUTTON));e&&(console.debug("[form] [cartObserver] Клик на кнопку корзины"),setTimeout(()=>s(),l.OBSERVER_CHECK))});var t=()=>{if(!window.__cardform_localstorage_intercepted){let o=Storage.prototype.setItem,i=this;Storage.prototype.setItem=function(t,e){e=o.apply(this,[t,e]);return"tcart"!==t||i.isUpdatingCart||(console.debug("[form] [cartObserver] localStorage tcart изменен извне"),setTimeout(()=>s(),l.CART_UPDATE)),e},window.__cardform_localstorage_intercepted=!0,console.debug("[form] [initCartObserver] ✓ localStorage.setItem перехвачен")}};"complete"===document.readyState?t():window.addEventListener("load",t),window.addEventListener("hashchange",()=>{"#opencart"===window.location.hash&&(console.debug("[form] [cartObserver] Корзина открывается через #opencart"),setTimeout(()=>{this.hideQuantityControlsForRuleProducts()},l.CART_UPDATE+200))});let i=()=>{var t=document.querySelector(".t706__cartwin");t?(new MutationObserver(t=>{t.forEach(t=>{"attributes"===t.type&&"class"===t.attributeName&&t.target.classList.contains("t706__cartwin_showed")&&(console.debug("[form] [cartObserver] Корзина показана (класс t706__cartwin_showed)"),setTimeout(()=>{this.hideQuantityControlsForRuleProducts()},l.CART_UPDATE))})}).observe(t,{attributes:!0,attributeFilter:["class"]}),console.debug("[form] [initCartObserver] ✓ Наблюдатель видимости корзины установлен")):setTimeout(i,1e3)};i(),console.debug("[form] [initCartObserver] ✓ Наблюдатели инициализированы")}handleRuleProductDeletion(e){console.debug("[form] [handleRuleProductDeletion] Проверка товара:",e);for(let[t,o]of this.actionsStates)if(o.action&&o.action.value===e){console.debug("[form] [handleRuleProductDeletion] Товар из правила найден:",{variable:t,action:o.action.value});let e=null;var i=this.form.querySelectorAll("input, select");i.forEach(t=>{"radio"!==t.type&&"checkbox"!==t.type||!t.value||t.value.trim()===o.action.value.trim()&&(e=t,console.debug("[form] [handleRuleProductDeletion] Найден элемент:",{type:t.type,value:t.value,checked:t.checked}))}),e?(console.debug("[form] [handleRuleProductDeletion] Снимаем выбор с:",e),e.checked=!1,this.actionsStates.delete(t),console.debug("[form] [handleRuleProductDeletion] ✓ Правило отменено, checkbox снят")):console.warn("[form] [handleRuleProductDeletion] Элемент формы не найден для:",{key:t,actionValue:o.action.value,availableInputs:Array.from(i).map(t=>({type:t.type,value:t.value}))});break}}async updateRuleProductsQuantity(){console.debug("[form] [updateRuleProductsQuantity] Начало обновления количества");var e=window.tcart;if(e&&Array.isArray(e.products)){console.debug("[form] [updateRuleProductsQuantity] Активных правил:",this.actionsStates.size);for(let[t,o]of this.actionsStates)if(o.action&&"perProduct"===o.action.quantityType){var i=this.calculateRuleProductQuantity(o.action),s=e.products.findIndex(t=>t.name?.trim()===o.action.value.trim());if(-1!==s){var a,r=parseInt(e.products[s].quantity);if(console.debug(`[form] [updateRuleProductsQuantity] Товар "${o.action.value}":`,{productIndex:s,oldQuantity:r,newQuantity:i,needsUpdate:r!==i}),r!==i){console.debug("[form] [updateRuleProductsQuantity] ⚡ Обновляем через tcart__product__updateQuantity");let e=null;for(let t=0;t<10;t++){if(e=d.findProductElement(o.action.value)){console.debug("[form] [updateRuleProductsQuantity] Элемент найден на попытке:",t+1);break}t<9&&await d.wait(l.DOM_UPDATE)}e?(a=e.querySelector(n.PRODUCT_QUANTITY))&&"function"==typeof window.tcart__product__updateQuantity?(window.tcart__product__updateQuantity(a,e,s,i),console.debug("[form] [updateRuleProductsQuantity] ✓ Количество обновлено через Tilda API:",{name:o.action.value,oldQuantity:r,newQuantity:i}),await d.wait(l.DOM_UPDATE),(a=e.querySelector(n.PRODUCT_PLUSMINUS))&&(a.style.display="none")):console.warn("[form] [updateRuleProductsQuantity] Не найден quantityElement или функция updateQuantity"):console.warn("[form] [updateRuleProductsQuantity] Не найден DOM элемент товара после ожидания")}}else console.warn(`[form] [updateRuleProductsQuantity] Товар "${o.action.value}" НЕ найден в корзине`)}console.debug("[form] [updateRuleProductsQuantity] ✓ Обновление завершено"),await this.hideQuantityControlsForRuleProducts()}else console.warn("[form] [updateRuleProductsQuantity] Корзина недоступна")}updateCartItemQuantityInDOM(e,t){console.debug("[form] [updateCartItemQuantityInDOM] Обновление:",{productName:e,newQuantity:t});var o;let i=null;for(o of[".t706__product-title",".t-store__product-name",".t-product__title",".js-product-name"]){var s=[...document.querySelectorAll(o)],s=(console.debug(`[form] [updateCartItemQuantityInDOM] Поиск через "${o}":`,s.length,"элементов"),s.find(t=>t.innerText.trim()===e.trim()));if(s&&(i=s.closest(".t706__cartwin-product, .t-store__product, .t-product"))){console.debug("[form] [updateCartItemQuantityInDOM] ✓ Товар найден через:",o);break}}if(i){var a,r=null;for(a of[".t706__product-quantity",".t-store__quantity-input",'input[name="quantity"]',".js-product-quantity"])if(r=i.querySelector(a)){r.value=t.toString(),r.dispatchEvent(new Event("change",{bubbles:!0})),r.dispatchEvent(new Event("input",{bubbles:!0})),console.debug("[form] [updateCartItemQuantityInDOM] ✓ Обновлен input через:",a);break}var n;for(n of[".t-quantity__value",".t706__product-quantity-value",".t-store__quantity-value"]){var l=i.querySelector(n);if(l){l.textContent=t.toString(),console.debug("[form] [updateCartItemQuantityInDOM] ✓ Обновлен display через:",n);break}}var d=window.tcart;if(d){var c=d.products.find(t=>t.name?.trim()===e.trim());if(c){var u,h=parseFloat(c.price)*t;for(u of[".t706__product-price",".t-store__product-price",".t-product__price",".js-product-price"]){var p=i.querySelector(u);if(p){p.textContent=h.toLocaleString("ru-RU")+" "+(d.currency_txt_r||" р."),console.debug("[form] [updateCartItemQuantityInDOM] ✓ Обновлена стоимость через:",u,h);break}}}}console.debug("[form] [updateCartItemQuantityInDOM] ✓ Обновление завершено для:",e)}else console.warn("[form] [updateCartItemQuantityInDOM] ✗ Элемент товара НЕ найден в DOM:",e),console.debug("[form] [updateCartItemQuantityInDOM] Все товары в DOM:",[...document.querySelectorAll(".t706__product-title, .t-store__product-name")].map(t=>t.innerText))}updateAllCartItemsInDOM(){var t=window.tcart;t&&Array.isArray(t.products)?(console.debug("[form] [updateAllCartItemsInDOM] Обновляем все товары в DOM"),t.products.forEach(t=>{var e=t.name?.trim(),t=parseInt(t.quantity||1);e&&this.updateCartItemQuantityInDOM(e,t)}),console.debug("[form] [updateAllCartItemsInDOM] ✓ Все товары обновлены")):console.warn("[form] [updateAllCartItemsInDOM] Корзина недоступна")}refreshCartUI(){console.debug("[form] [refreshCartUI] Начало обновления UI корзины"),"function"==typeof window.t_store__refreshcart&&(window.t_store__refreshcart(),console.debug("[form] [refreshCartUI] ✓ Вызван t_store__refreshcart"));["t706__updateCart","tcart__updateCart","t_store__updateCart","t706_init"].forEach(e=>{if("function"==typeof window[e])try{window[e](),console.debug("[form] [refreshCartUI] ✓ Вызван "+e)}catch(t){console.warn(`[form] [refreshCartUI] Ошибка ${e}:`,t)}}),this.updateAllCartItemsInDOM(),window.dispatchEvent(new Event("cart-updated")),document.dispatchEvent(new Event("tcart-updated")),this.updateCartCounters()}updateCartCounters(){let o=window.tcart;o&&(document.querySelectorAll(n.CART_COUNTER).forEach(t=>{t&&(t.textContent=o.total.toString())}),document.querySelectorAll(n.CART_AMOUNT).forEach(t=>{var e;t&&(e=o.amount.toLocaleString("ru-RU"),t.textContent=e+" "+(o.currency_txt_r||" р."))}),console.debug("[form] [updateCartCounters] ✓ Счетчики обновлены"))}getMainProductsQuantity(){var t=window.tcart;if(!t||!Array.isArray(t.products))return 0;let i=new Set,s=(this.rules.forEach(t=>{t.actions.forEach(t=>{t.value&&i.add(t.value.trim())})}),0),a=[];return t.products.forEach(t=>{var e=t.name?.trim(),o=i.has(e),t=parseInt(t.quantity||1);e&&!o&&(s+=t,a.push(e+` (${t} шт)`))}),console.debug("[form] [getMainProductsQuantity]",{"Основных товаров":s,"Список":a,"Товары правил":Array.from(i)}),s}calculateRuleProductQuantity(t){return void 0!==t.quantity?t.quantity:"perProduct"===t.quantityType?Math.max(1,this.getMainProductsQuantity()):1}async removeProductFromCart(e){console.debug("[form] [removeProduct] Попытка удалить:",e);var t=d.findProductElement(e);if(t){t=t.querySelector(n.PRODUCT_DEL_BUTTON);if(t)return t.click(),console.debug("[form] [removeProduct] ✓ Удалено через DOM (клик):",e),await d.wait(l.CART_UPDATE),!0}t=window.tcart;if(t&&Array.isArray(t.products)){var o=t.products.findIndex(t=>t.name?.trim()===e.trim());if(-1!==o){var i,s=t.products[o];for(i of["tcart__removeProduct","tcart_removeProduct","t_store__removeProduct"])if("function"==typeof window[i])try{return window[i](s.uid||s.id),console.debug(`[form] [removeProduct] ✓ Удалено через ${i}:`,e),await d.wait(l.CART_UPDATE),!0}catch(t){console.warn(`[form] [removeProduct] Ошибка ${i}:`,t)}if(t.products.splice(o,1),t.amount=t.products.reduce((t,e)=>t+parseFloat(e.price)*parseInt(e.quantity||1),0),t.prodamount=t.products.length,t.total=t.products.length,t.updated=Math.floor(Date.now()/1e3),this.saveTildaCart(t))return"function"==typeof window.t_store__refreshcart&&window.t_store__refreshcart(),console.debug("[form] [removeProduct] ✓ Удалено напрямую из массива:",e),await d.wait(l.CART_UPDATE),!0}}return console.warn("[form] [removeProduct] ✗ Не удалось удалить товар:",e),!1}async applyActions(e=new Map){if(this.isApplyingActions)console.debug("[form] [applyActions] Уже выполняется, пропускаем");else{this.isApplyingActions=!0;try{console.debug("[form] [applyActions] Начало применения действий"),console.debug("[form] [applyActions] Старое состояние:",Object.fromEntries(e)),console.debug("[form] [applyActions] Новое состояние:",Object.fromEntries(this.actionsStates)),await Promise.race([new Promise(t=>{let e=setInterval(()=>{0<[...document.querySelectorAll(".t706__product-title")].length&&(clearInterval(e),t(!0))},200)}),new Promise(t=>setTimeout(()=>t(!1),3e3))])||console.warn("[form] [applyActions] Корзина не загрузилась за 3 секунды, продолжаем");for(let[t,o]of this.actionsStates){var i,s,a,r,n=e.get(t)?.value,l=e.get(t)?.action;console.debug(`[form] [applyActions] Обработка поля "${t}":`,{oldValue:n,newValue:o.value,oldAction:l?.value,newAction:o.action?.value}),o.value!==n&&(l&&l.value&&(console.debug("[form] [applyActions] Удаляем старый товар:",l.value),await this.removeProductFromCart(l.value)),o.value&&o.action?(i=`rule_${t}_`+Date.now(),s=this.calculateRuleProductQuantity(o.action),console.debug("[form] [applyActions] Добавляем новый товар:",{id:i,name:o.action.value,price:o.action.sum||0,quantity:s,quantityType:o.action.quantityType||"fixed"}),window.tcart__addProduct({id:i,name:o.action.value,price:o.action.sum||0,quantity:s}),(a=await new Promise(e=>{setTimeout(()=>{var t=[...document.querySelectorAll(".t706__product-title")].find(t=>t.innerText.trim()===o.action.value.trim())?.parentElement;e(t||void 0)},300)}))&&(r=a.querySelector(".t706__product-plusminus"))&&(r.style.display="none",console.debug("[form] [applyActions] ✓ Скрыты кнопки количества"))):o.value&&o.action||console.debug("[form] [applyActions] Значение сброшено, товар удален"))}console.debug("[form] [applyActions] ✓ Применение действий завершено"),await this.hideQuantityControlsForRuleProducts()}finally{this.isApplyingActions=!1}}}getAllRuleProductNames(){let e=new Set;return this.rules.forEach(t=>{t.actions.forEach(t=>{t.value&&e.add(t.value.trim())})}),console.debug("[form] [hideQuantity] Все товары из правил:",Array.from(e)),e}async hideQuantityControlsForRuleProducts(){console.debug("[form] [hideQuantity] Начало скрытия счетчиков для товаров из правил");let i=this.getAllRuleProductNames();if(0===i.size)console.debug("[form] [hideQuantity] Нет товаров из правил");else{await d.wait(l.DOM_UPDATE);var t=document.querySelectorAll(n.CART_PRODUCT);let o=0;t.forEach(t=>{var e=t.querySelector(n.PRODUCT_TITLE)?.textContent?.trim();e&&i.has(e)&&(t=t.querySelector(n.PRODUCT_PLUSMINUS))&&"none"!==t.style.display&&(t.style.display="none",o++,console.debug(`[form] [hideQuantity] ✓ Скрыты кнопки для товара: "${e}"`))}),console.debug("[form] [hideQuantity] ✓ Скрыто счетчиков: "+o)}}}},"./src/components/Editor.ts":
/*!**********************************!*\
  !*** ./src/components/Editor.ts ***!
  \**********************************/(t,e,o)=>{o.r(e),o.d(e,{EditorEventType:()=>n,default:()=>s});var n,a=o(/*! ../managers/EditorStorageManager */"./src/managers/EditorStorageManager.ts"),l=o(/*! ../models/Layout */"./src/models/Layout.ts"),d=o(/*! ../utils/tildaUtils */"./src/utils/tildaUtils.ts"),r=o(/*! ../utils/TypedEventEmitter */"./src/utils/TypedEventEmitter.ts"),c=o(/*! ../utils/api */"./src/utils/api.ts"),u=o(/*! ../utils/canvasUtils */"./src/utils/canvasUtils.ts");let i={STATE_EXPIRATION_DAYS:30,CANVAS_AREA_HEIGHT:600,LOADING_INTERVAL_MS:100};(e=n=n||{}).MOCKUP_LOADING="mockup-loading",e.MOCKUP_UPDATED="mockup-updated",e.LOADING_TIME_UPDATED="loading-time-updated",e.STATE_CHANGED="state-changed",e.LAYOUT_ADDED="layout-added",e.LAYOUT_REMOVED="layout-removed",e.LAYOUT_UPDATED="layout-updated";class s{get selectType(){return this._selectType}get selectColor(){return this._selectColor}get selectSide(){return this._selectSide}get selectSize(){return this._selectSize}get selectLayout(){return this._selectLayout}constructor({blocks:t,productConfigs:e,formConfig:o,apiConfig:i,options:s}){if(this.quantityFormBlock=null,this.formBlock=null,this.formInputVariableName=null,this.formButton=null,this._selectLayout=null,this.layouts=[],this.canvases=[],this.layersCanvases=[],this.activeCanvas=null,this.events=new r.TypedEventEmitter,this.layersHistory=[],this.currentHistoryIndex=-1,this.isRestoringFromHistory=!1,this.isLoading=!0,this.isAddingToCart=!1,this.isAddedToCart=!1,this.isGenerating=!1,this.loadingTime=0,this.loadingInterval=null,this.colorBlocks=[],this.sizeBlocks=[],this.productBlocks=[],this.loadedUserImage=null,this.editorLoadWithAi=!1,this.editorRemoveBackground=!1,this.imageCache=new Map,this.loadingElementsCache={},this.productCache=new Map,this.mockupCache=new Map,!e||0===e.length)throw new Error("[Editor] Не предоставлены конфигурации продуктов");this.storageManager=new a.EditorStorageManager,this.productConfigs=e,this.apiConfig=i,this.options=s,this.editorBlock=this.getRequiredElement(t.editorBlockClass),this.changeSideButton=this.getRequiredElement(t.changeSideButtonClass),this.editorHistoryUndoBlock=this.getRequiredElement(t.editorHistoryUndoBlockClass),this.editorHistoryRedoBlock=this.getRequiredElement(t.editorHistoryRedoBlockClass),this.quantityFormBlock=document.querySelector(t.editorQuantityFormBlockClass);i=document.querySelector(t.productListBlockClass),i&&(this.productListBlock=i),s=document.querySelector(t.productItemClass),s&&(this.productItemBlock=s),i=document.querySelector(t.editorColorsListBlockClass),i&&(this.editorColorsListBlock=i),s=document.querySelector(t.editorColorItemBlockClass),s&&(this.editorColorItemBlock=s),i=document.querySelector(t.editorSizesListBlockClass),i&&(this.editorSizesListBlock=i),s=document.querySelector(t.editorSizeItemBlockClass),s&&(this.editorSizeItemBlock=s),i=document.querySelector(t.editorLayoutsListBlockClass),i&&(this.editorLayoutsListBlock=i),s=document.querySelector(t.editorLayoutItemBlockClass),s&&(this.editorLayoutItemBlock=s),i=document.querySelector(t.editorUploadImageButtonClass),i&&(this.editorUploadImageButton=i),s=document.querySelector(t.editorUploadViewBlockClass),s&&(this.editorUploadViewBlock=s),i=document.querySelector(t.editorUploadCancelButtonClass),i&&(this.editorUploadCancelButton=i),s=document.querySelector(t.editorLoadWithAiButtonClass),s&&(this.editorLoadWithAiButton=s),i=document.querySelector(t.editorLoadWithoutAiButtonClass),i&&(this.editorLoadWithoutAiButton=i),s=document.querySelector(t.editorRemoveBackgroundButtonClass),s&&(this.editorRemoveBackgroundButton=s),i=document.querySelector(t.editorAddOrderButtonClass),i&&(this.editorAddOrderButton=i),s=document.querySelector(t.editorSumBlockClass),s&&(this.editorSumBlock=s),i=document.querySelector(t.editorProductNameClass),i&&(this.editorProductName=i),this.editorLayoutItemBlockViewClass=t.editorLayoutItemBlockViewClass,this.editorLayoutItemBlockNameClass=t.editorLayoutItemBlockNameClass,this.editorLayoutItemBlockRemoveClass=t.editorLayoutItemBlockRemoveClass,this.editorLayoutItemBlockEditClass=t.editorLayoutItemBlockEditClass,o&&(this.formBlock=document.querySelector(o.formBlockClass),this.formInputVariableName=o.formInputVariableName,this.formButton=document.querySelector(o.formButtonClass)),s=e[0];if(!s)throw new Error("[Editor] Не найден дефолтный продукт");i=s.mockups[0];if(!i)throw new Error("[Editor] Не найден дефолтный mockup");this._selectColor=i.color,this._selectSide=i.side,this._selectType=s.type,this._selectSize=s.sizes?.[0]||"M",this.editorBlock.style.position="relative",this.createBackgroundBlock(),this.mockupBlock=this.createMockupBlock(),this.canvasesContainer=this.createCanvasesContainer(),this.editorLoadingBlock=this.createEditorLoadingBlock(),this.initEvents(),this.initKeyboardShortcuts(),this.initLoadingEvents(),this.initUIComponents(),this.initializeEditor(),window.getLayouts=()=>this.layouts.map(t=>({...t,url:void 0})),window.loadLayouts=t=>{this.layouts=t.map(t=>l.Layout.fromJSON(t)),this.updateLayouts(),this.showLayoutList()},window.exportPrint=async()=>{var t,e=await this.exportArt(!1,4096);for(t of Object.keys(e)){var o=document.createElement("a");document.body.appendChild(o),o.href=e[t],o.target="_self",o.download=t+".png",o.click()}return e}}initUIComponents(){this.changeSideButton&&(this.changeSideButton.style.cursor="pointer",this.changeSideButton.onclick=()=>this.changeSide()),this.editorHistoryUndoBlock&&this.initHistoryUndoBlock(),this.editorHistoryRedoBlock&&this.initHistoryRedoBlock(),this.productListBlock&&this.productItemBlock&&this.initProductList(),this.editorAddOrderButton&&this.initAddOrderButton(),this.editorUploadImageButton&&this.initUploadImageButton(),this.editorLoadWithAiButton&&this.editorLoadWithoutAiButton&&this.editorRemoveBackgroundButton&&this.initAiButtons(),this.formBlock&&this.formButton&&this.initForm(),this.quantityFormBlock&&setTimeout(()=>this.initFixQuantityForm(),500),this.editorLayoutsListBlock&&this.showLayoutList(),this.editorUploadCancelButton&&(this.editorUploadCancelButton.style.cursor="pointer",this.editorUploadCancelButton.onclick=()=>{console.debug("[upload image button] cancel button clicked"),this.resetUserUploadImage()})}getRequiredElement(t){var e=document.querySelector(t);if(e)return e;throw new Error("[Editor] Не найден обязательный элемент: "+t)}async initializeEditor(){try{await this.storageManager.waitForReady(),await this.loadState(),await this.preloadAllMockups(),console.debug("[editor] Инициализация завершена")}catch(t){console.error("[editor] Ошибка инициализации:",t),this.initializeWithDefaults()}}async initializeWithDefaults(){console.debug("[editor] Инициализация с дефолтными значениями");try{await this.updateMockup()}catch(t){console.error("[editor] Ошибка загрузки mockup по умолчанию:",t)}}initEvents(){this.options?.disableBeforeUnloadWarning||(window.onbeforeunload=t=>{var e;if(0<this.layouts.length&&!this.isAddedToCart&&0<this.layersHistory.length)return e="Дизайн редактора может быть потерян. Вы уверены, что хотите покинуть страницу?",t.preventDefault(),t.returnValue=e});let t;window.addEventListener("resize",()=>{clearTimeout(t),t=setTimeout(()=>{this.handleWindowResize()},150)}),this.events.on(n.MOCKUP_UPDATED,t=>{this.mockupBlock.src=t})}initLoadingEvents(){this.loadingElementsCache.loadingText=this.editorLoadingBlock.querySelector("#loading-text"),this.loadingElementsCache.spinner=this.editorLoadingBlock.querySelector("#spinner"),this.events.on(n.LOADING_TIME_UPDATED,t=>{var{loadingText:e,spinner:o}=this.loadingElementsCache;this.isLoading?5<this.loadingTime?(e&&(e.style.display="block",e.innerText=""+(this.loadingTime/10).toFixed(1)),o&&(o.style.display="block"),this.editorLoadingBlock.style.backgroundColor="rgba(255, 255, 255, 0.745)"):(e&&(e.style.display="none",e.innerText=""),o&&(o.style.display="none"),this.editorLoadingBlock.style.backgroundColor="rgba(255, 255, 255, 0)"):e&&(e.style.display="none",e.innerText="")}),this.events.on(n.MOCKUP_LOADING,t=>{var{loadingText:e,spinner:o}=this.loadingElementsCache;t?(this.loadingInterval&&clearInterval(this.loadingInterval),this.loadingTime=0,this.isLoading=!0,console.debug("[mockup] loading mockup"),this.loadingInterval=setInterval(()=>{this.loadingTime++,this.emit(n.LOADING_TIME_UPDATED,this.loadingTime)},100)):(this.editorLoadingBlock.style.backgroundColor="rgba(255, 255, 255, 0)",e&&(e.style.display="none",e.innerText=""),o&&(o.style.display="none"),this.isLoading=!1,this.loadingInterval&&(clearInterval(this.loadingInterval),this.loadingInterval=null),this.loadingTime=0)})}emit(t,e){this.events.emit(t,e)}initKeyboardShortcuts(){document.addEventListener("keydown",t=>{var e=document.activeElement;e&&("INPUT"===e.tagName||"TEXTAREA"===e.tagName||"true"===e.contentEditable||e.isContentEditable)||(t.ctrlKey&&"KeyZ"===t.code&&!t.shiftKey?(t.preventDefault(),this.undo()):(t.ctrlKey&&t.shiftKey&&"KeyZ"===t.code||t.ctrlKey&&"KeyY"===t.code&&!t.shiftKey)&&(t.preventDefault(),this.redo()))})}createBackgroundBlock(){var t=document.createElement("div");return t.classList.add("editor-position"),t.id="editor-background",this.editorBlock.appendChild(t),t}createMockupBlock(){var t=document.createElement("img");return t.classList.add("editor-position"),t.id="editor-mockup",this.editorBlock.appendChild(t),t}createCanvasesContainer(){var t=document.createElement("div");return t.classList.add("editor-position"),t.id="editor-canvases-container",t.style.zIndex="10",t.style.pointerEvents="auto",this.editorBlock.appendChild(t),t}createEditorLoadingBlock(){var t=document.createElement("div"),e=(t.style.display="flex",t.classList.add("editor-position"),t.id="editor-loading",t.style.zIndex="1000",t.style.pointerEvents="none",document.createElement("div")),e=(e.id="loading-text",e.style.display="none",e.style.textAlign="center",e.style.position="absolute",e.style.top="50%",e.style.left="50%",e.style.transform="translate(-50%, -50%)",t.appendChild(e),document.createElement("div"));return e.id="spinner",e.style.display="none",t.appendChild(e),this.editorBlock.appendChild(t),t}async updateMockup(){console.debug(`[mockup] update for ${this._selectType} ${this._selectSide} `+this._selectColor.name),this.emit(n.MOCKUP_LOADING,!0);try{var t=this.findMockupUrl();if(!t)throw new Error("[mockup] Не найден mockup для текущих параметров");var e=await this.loadAndConvertImage(t);this.emit(n.MOCKUP_UPDATED,e),this.mockupBlock.src=e,console.debug("[mockup] Mockup успешно обновлен")}catch(t){throw console.error("[mockup] Ошибка обновления mockup:",t),t}finally{this.emit(n.MOCKUP_LOADING,!1)}}findMockupUrl(){var t,e=`${this._selectType}-${this._selectSide}-`+this._selectColor.name;return this.mockupCache.has(e)?this.mockupCache.get(e):(t=this.getProductByType(this._selectType))?(t=t.mockups.find(t=>t.side===this._selectSide&&t.color.name===this._selectColor.name)?.url||null,this.mockupCache.set(e,t),t):(this.mockupCache.set(e,null),null)}getProductByType(e){var t;return this.productCache.has(e)||(t=this.productConfigs.find(t=>t.type===e))&&this.productCache.set(e,t),this.productCache.get(e)}clearMockupCache(){this.mockupCache.clear()}async loadAndConvertImage(r){return this.imageCache.has(r)?(console.debug("[cache] Изображение загружено из кэша:",r),this.imageCache.get(r)):new Promise((i,s)=>{let a=new Image;a.setAttribute("crossOrigin","anonymous"),a.onload=()=>{try{var t,e=document.createElement("canvas"),o=(e.width=a.width,e.height=a.height,e.getContext("2d"));o?(o.drawImage(a,0,0),t=e.toDataURL("image/png"),this.imageCache.set(r,t),console.debug("[cache] Изображение сохранено в кэш:",r),i(t)):s(new Error("Не удалось получить контекст canvas"))}catch(t){s(t)}},a.onerror=()=>{s(new Error("Ошибка загрузки изображения: "+r))},a.src=r})}async saveState(){console.debug("[state] Сохранение состояния редактора");try{var t={date:(new Date).toISOString(),type:this._selectType,color:this._selectColor.name,side:this._selectSide,size:this._selectSize};console.debug(`[state] Сохраняем: type=${t.type}, color=${t.color}, side=${t.side}, size=`+t.size),await this.storageManager.saveEditorState(t),console.debug("[state] Состояние успешно сохранено")}catch(t){console.error("[state] Ошибка сохранения состояния:",t)}}async saveLayouts(){console.debug("[layers] Сохранение слоёв");try{await this.storageManager.saveLayers(this.layouts),console.debug("[layers] Слои успешно сохранены")}catch(t){console.error("[layers] Ошибка сохранения слоёв:",t)}}async loadLayouts(){console.debug("[layers] Загрузка слоёв");try{var t=await this.storageManager.loadLayers();t&&Array.isArray(t)?(this.layouts=t.map(t=>new l.Layout(t)),console.debug(`[layers] Загружено ${this.layouts.length} слоёв`)):(this.layouts=[],console.debug("[layers] Нет сохранённых слоёв")),this.saveLayersToHistory()}catch(t){console.error("[layers] Ошибка загрузки слоёв:",t),this.layouts=[],this.saveLayersToHistory()}}async loadState(){console.debug("[state] Загрузка состояния редактора");try{var t,e=await this.storageManager.loadEditorState();e?(this.isStateExpired(e.date)?(console.warn("[state] Состояние устарело, очищаем"),await this.storageManager.clearEditorState(),await this.updateMockup(),this.loadProduct(),this.initColorsList(),this.initSizesList(),this.showLayoutList(),this.updateLayouts()):await this.applyState(e)?(console.debug("[state] Состояние успешно загружено"),await this.updateMockup(),this.loadProduct(),0<this.productBlocks.length&&(this.productBlocks.forEach(t=>{t.style.background="rgb(222 222 222)"}),t=this.productBlocks.find(t=>t.classList.contains("editor-settings__product-block__"+this._selectType)))&&(t.style.background=""),await this.loadLayouts(),this.initColorsList(),this.initSizesList(),this.showLayoutList(),this.updateLayouts(),await this.saveLayouts()):(console.warn("[state] Не удалось применить сохраненное состояние"),await this.updateMockup(),this.loadProduct(),this.initColorsList(),this.initSizesList(),this.showLayoutList(),this.updateLayouts()),this.updateSum()):(console.debug("[state] Сохраненное состояние не найдено"),await this.updateMockup(),this.loadProduct(),this.initColorsList(),this.initSizesList(),this.showLayoutList(),this.updateLayouts(),this.updateSum())}catch(t){console.error("[state] Ошибка загрузки состояния:",t),await this.updateMockup(),this.loadProduct(),this.initColorsList(),this.initSizesList(),this.showLayoutList(),this.updateLayouts(),this.updateSum()}}isStateExpired(t){var t=new Date(t),e=Date.now()-24*i.STATE_EXPIRATION_DAYS*60*60*1e3;return t.getTime()<e}async applyState(e){try{if(!e.type||!e.color||!e.side)return console.warn("[state] Некорректное состояние: отсутствуют обязательные поля"),!1;console.debug(`[state] Восстановление состояния: type=${e.type}, color=${e.color}, side=${e.side}, size=`+e.size);var t,o=this.productConfigs.find(t=>t.type===e.type);return o?(t=o.mockups.find(t=>t.color.name===e.color))?(this._selectType=e.type,this._selectColor=t.color,this._selectSide=e.side,this._selectSize=e.size||this._selectSize,console.debug(`[state] Состояние применено: type=${this._selectType}, color=${this._selectColor.name}, side=${this._selectSide}, size=`+this._selectSize),!0):(console.warn(`[state] Mockup с цветом ${e.color} не найден для продукта `+e.type),!1):(console.warn(`[state] Продукт типа ${e.type} не найден`),!1)}catch(t){return console.error("[state] Ошибка применения состояния:",t),!1}}setType(t){this._selectType!==t&&(this._selectType=t,this.clearMockupCache(),this.emit(n.STATE_CHANGED,void 0),this.saveState().catch(t=>console.error("[state] Ошибка сохранения:",t)))}setColor(t){this._selectColor!==t&&(this._selectColor=t,this.clearMockupCache(),this.emit(n.STATE_CHANGED,void 0),this.saveState().catch(t=>console.error("[state] Ошибка сохранения:",t)))}setSide(t){this._selectSide!==t&&(this._selectSide=t,this.clearMockupCache(),this.emit(n.STATE_CHANGED,void 0),this.saveState().catch(t=>console.error("[state] Ошибка сохранения:",t)))}setSize(t){this._selectSize!==t&&(this._selectSize=t,this.emit(n.STATE_CHANGED,void 0),this.saveState().catch(t=>console.error("[state] Ошибка сохранения:",t)))}addLayout(t){this.isRestoringFromHistory?this.layouts.push(t):(this.layouts.push(t),this.saveLayersToHistory()),this.emit(n.LAYOUT_ADDED,t),this.updateLayouts(),this.showLayoutList(),this.saveLayouts().catch(t=>console.error("[layers] Ошибка сохранения слоёв:",t))}removeLayout(e){var t=this.layouts.findIndex(t=>t.id===e);if(-1!==t&&this.layouts[t])return this.layouts.splice(t,1),this.isRestoringFromHistory||this.saveLayersToHistory(),this.emit(n.LAYOUT_REMOVED,e),this.updateLayouts(),this.saveLayouts().catch(t=>console.error("[layers] Ошибка сохранения слоёв:",t)),!0;return!1}updateLayout(e,t){var o=this.layouts.find(t=>t.id===e);return!!o&&(Object.assign(o,t),this.isRestoringFromHistory||("url"in t||"name"in t)&&this.saveLayersToHistory(),this.emit(n.LAYOUT_UPDATED,o),this.saveLayouts().catch(t=>console.error("[layers] Ошибка сохранения слоёв:",t)),!0)}getLayout(e){return this.layouts.find(t=>t.id===e)}getLayouts(){return this.layouts}initHistoryUndoBlock(){console.debug("[history block] init undo"),this.editorHistoryUndoBlock.style.cursor="pointer",this.editorHistoryUndoBlock.onclick=async()=>{console.debug("[history undo block] clicked"),await this.undo()},this.updateHistoryButtonsState()}initHistoryRedoBlock(){console.debug("[history redo block] init redo"),this.editorHistoryRedoBlock.style.cursor="pointer",this.editorHistoryRedoBlock.onclick=async()=>{console.debug("[history redo block] clicked"),await this.redo()},this.updateHistoryButtonsState()}initProductList(){var t;this.productListBlock&&this.productItemBlock&&(console.debug("[ProductList] init product list"),this.productItemBlock.style.display="none",this.productConfigs.forEach(t=>{var e=this.productItemBlock.cloneNode(!0),o=(e.style.display="table",e.querySelector(".product-item-image")),o=(o&&(o=(0,d.getLastChild)(o))&&(o.style.backgroundImage=`url(${t.mockups[0]?.url})`,o.style.backgroundSize="cover",o.style.backgroundPosition="center",o.style.backgroundRepeat="no-repeat"),e.querySelector(".product-item-text")),o=(o&&(o=(0,d.getLastChild)(o))&&(o.innerText=t.productName),e.firstElementChild);o.classList.add("editor-settings__product-block__"+t.type),o.style.cursor="pointer",o.style.borderColor="transparent",e.onclick=()=>this.changeProduct(t.type),this.productBlocks.push(o),this.productListBlock.firstElementChild.appendChild(e)}),0<this.productBlocks.length)&&(this.productBlocks.forEach(t=>{t.style.background="rgb(222 222 222)"}),t=this.productBlocks.find(t=>t.classList.contains("editor-settings__product-block__"+this._selectType)))&&(t.style.background="")}initColorsList(){var t;this.editorColorsListBlock&&this.editorColorItemBlock&&(console.debug("[settings] init colors for "+this._selectType),t=this.getProductByType(this._selectType))&&(this.editorColorItemBlock.style.display="none",this.editorColorsListBlock.firstElementChild.innerHTML="",this.colorBlocks=[],t.mockups.filter(t=>t.side===this._selectSide).map(t=>t.color).forEach(t=>{var e=this.editorColorItemBlock.cloneNode(!0),o=(e.style.display="table",e.firstElementChild);o.classList.add("editor-settings__color-block__"+t.name),o.style.cursor="pointer",o.style.backgroundColor=t.hex,o.style.borderColor="transparent",e.onclick=()=>this.changeColor(t.name),this.colorBlocks.push(o),this.editorColorsListBlock.firstElementChild.appendChild(e)}),0<this.colorBlocks.length)&&(this.colorBlocks.forEach(t=>{t.style.borderColor="#f3f3f3"}),t=this.colorBlocks.find(t=>t.classList.contains("editor-settings__color-block__"+this._selectColor.name)))&&(t.style.borderColor="")}initSizesList(){var t;this.editorSizesListBlock&&this.editorSizeItemBlock&&(console.debug("[settings] init sizes for "+this._selectType),t=this.getProductByType(this._selectType))&&t.sizes&&(this.editorSizeItemBlock.style.display="none",this.editorSizesListBlock.firstElementChild.innerHTML="",this.sizeBlocks=[],t.sizes.forEach(t=>{var e=this.editorSizeItemBlock.cloneNode(!0);e.style.display="table",e.style.cursor="pointer",e.style.userSelect="none",e.classList.add("editor-settings__size-block__"+t);e.firstElementChild.style.borderColor="#f3f3f3";var o=(0,d.getLastChild)(e);o&&(o.innerText=t),e.onclick=()=>this.changeSize(t),this.sizeBlocks.push(e),this.editorSizesListBlock.firstElementChild.appendChild(e)}),0<this.sizeBlocks.length)&&(this.sizeBlocks.forEach(t=>{t=t.firstElementChild;t&&(t.style.borderColor="#f3f3f3")}),t=this.sizeBlocks.find(t=>t.classList.contains("editor-settings__size-block__"+this._selectSize)))&&(t=t.firstElementChild)&&(t.style.borderColor="")}showLayoutList(){console.debug("[settings] [layouts] show layouts list"),this.editorLayoutItemBlock?this.editorLayoutsListBlock?(this.editorLayoutItemBlock.style.display="none",this.editorLayoutsListBlock.firstElementChild.innerHTML="",console.debug("[settings] [layouts] layouts list block children: "+this.editorLayoutsListBlock.firstElementChild.children.length),this.layouts.forEach(t=>{var e=this.editorLayoutItemBlock.cloneNode(!0);e.style.display="table";let o=this._selectLayout===t.id;var i=this.editorLayoutItemBlockViewClass?e.querySelector(this.editorLayoutItemBlockViewClass):null,s=this.editorLayoutItemBlockNameClass?e.querySelector(this.editorLayoutItemBlockNameClass):null,a=this.editorLayoutItemBlockRemoveClass?e.querySelector(this.editorLayoutItemBlockRemoveClass):null,r=this.editorLayoutItemBlockEditClass?e.querySelector(this.editorLayoutItemBlockEditClass):null;i&&(t.isImageLayout()?((i=i.firstElementChild)&&(i.style.backgroundImage=`url(${t.url})`,i.style.backgroundSize="contain",i.style.backgroundPosition="center",i.style.backgroundRepeat="no-repeat"),o?i.style.borderColor="rgb(254, 94, 58)":i.style.borderColor=""):t.type),s&&(i=s.firstElementChild)&&("image"===t.type?(s=t.name?t.name.includes("\n")?t.name.split("\n")[0]+"...":40<t.name.length?t.name.slice(0,40)+"...":t.name:"Изображение",i.innerText=s):"text"===t.type&&(i.innerText=t.name||"Текст")),a&&(a.style.cursor="pointer",a.onclick=()=>{this.removeLayout(t.id),this.showLayoutList(),o&&this.cancelEditLayout()},this.restoreIconFromDataOriginal(a.firstElementChild)),r&&(o||"start"===t.id?r.style.display="none":r.style.display="table",r.style.cursor="pointer",r.onclick=()=>this.editLayout(t),this.restoreIconFromDataOriginal((0,d.getLastChild)(r))),this.editorLayoutsListBlock.firstElementChild.appendChild(e)}),this.updateSum(),console.debug("[settings] [layouts] layouts shown: "+this.editorLayoutsListBlock.firstElementChild.children.length)):console.error("[settings] [layouts] editorLayoutsListBlock is not initialized"):console.error("[settings] [layouts] editorLayoutItemBlock is not initialized")}initAddOrderButton(){this.editorAddOrderButton&&(this.editorAddOrderButton.style.cursor="pointer",this.events.on(n.MOCKUP_LOADING,t=>{this.editorAddOrderButton&&(t?(this.editorAddOrderButton.style.opacity="0.5",this.editorAddOrderButton.style.cursor="not-allowed",this.editorAddOrderButton.style.pointerEvents="none",console.debug("[order] Кнопка заблокирована (идет генерация)")):(this.editorAddOrderButton.style.opacity="1",this.editorAddOrderButton.style.cursor="pointer",this.editorAddOrderButton.style.pointerEvents="auto",console.debug("[order] Кнопка разблокирована")))}),this.editorAddOrderButton.onclick=async()=>{if(this.isAddingToCart)console.warn("[order] Процесс добавления уже идет, игнорируем повторное нажатие");else if(0===this.getSum())alert("Для добавления заказа продукт не может быть пустым");else if(0===this.layouts.length)alert("Пожалуйста, дождитесь завершения генерации дизайна"),console.warn("[order] Попытка добавить в корзину без дизайна");else{let t=this.editorAddOrderButton?.querySelector(".tn-atom"),o=(t=t||this.editorAddOrderButton?.querySelector("div, span"))?.textContent?.trim()||"Добавить в корзину";try{this.isAddingToCart=!0,this.setAddToCartButtonLoading(!0,"Добавление...");var i,s,a,r,n,l,d=Math.floor(Math.random()*(99e6+1))+999999;console.debug("[order] Начало создания заказа");let e=await this.exportArt(!0,512);console.debug("[order] Экспорт дизайна завершен:",Object.keys(e)),0===Object.keys(e).length?(alert("Ошибка: не удалось экспортировать дизайн. Попробуйте еще раз."),console.error("[order] Экспорт вернул пустой результат")):(i=Object.keys(e).map(t=>({image_url:e[t]||""})),s=(console.debug("[order] Загрузка изображений на сервер..."),i.map(async t=>{var e=t.image_url.split(",")[1];return{side:t,uploadedUrl:await this.uploadImageToServer(e)}})),a=((await Promise.all(s)).forEach(({side:t,uploadedUrl:e})=>{t.image_url=e}),console.debug("[order] Изображения загружены на сервер"),`${this.capitalizeFirstLetter(this.getProductName())} с вашим ${1==Object.keys(e).length?"односторонним":"двухсторонним"} принтом`),r=this.layouts.map(t=>({...t,url:void 0})),n=await this.storageManager.getUserId(),(l=new FormData).append("layouts",JSON.stringify(r)),l.append("user_id",n),l.append("art",d.toString()),await fetch(this.apiConfig.webhookCart,{method:"POST",body:l}),(0,c.createProduct)({quantity:this.getQuantity(),name:a,size:this._selectSize,color:this._selectColor,sides:i,article:d,price:this.getSum()}),this.isAddedToCart=!0,console.debug("[order] Заказ успешно создан"),this.setAddToCartButtonLoading(!1,"✓ Добавлено!"),setTimeout(()=>{this.setAddToCartButtonLoading(!1,o)},2e3))}catch(t){console.error("[order] Ошибка создания заказа:",t),alert("Ошибка при создании заказа"),this.setAddToCartButtonLoading(!1,o)}finally{setTimeout(()=>{this.isAddingToCart=!1,console.debug("[order] Флаг isAddingToCart сброшен")},2e3)}}})}setAddToCartButtonLoading(e,o){if(this.editorAddOrderButton){this.injectPulseAnimation();var i=this.editorAddOrderButton;let t=i.querySelector(".tn-atom");var s=(t=t||i.querySelector("div, span"))||i;e?(i.style.opacity="0.7",i.style.cursor="not-allowed",i.style.pointerEvents="none",o&&(s.textContent=o),i.style.animation="cartButtonPulse 1.5s ease-in-out infinite",console.debug("[order] [animation] Кнопка заблокирована:",o)):(i.style.opacity="1",i.style.cursor="pointer",i.style.pointerEvents="auto",i.style.animation="none",o&&(s.textContent=o),console.debug("[order] [animation] Кнопка разблокирована:",o))}}injectPulseAnimation(){var t;document.getElementById("cart-button-pulse-animation")||((t=document.createElement("style")).id="cart-button-pulse-animation",t.textContent=`
            @keyframes cartButtonPulse {
                0%, 100% {
                    transform: scale(1);
                    opacity: 0.7;
                }
                50% {
                    transform: scale(1.02);
                    opacity: 0.85;
                }
            }
        `,document.head.appendChild(t),console.debug("[animation] CSS анимация пульсации добавлена"))}setGenerateButtonLoading(e,o){if(this.formButton){this.injectPulseAnimation();var i=this.formButton;let t=i.querySelector(".tn-atom");var s=(t=t||i.querySelector("div, span"))||i;e?(i.style.opacity="0.7",i.style.cursor="not-allowed",i.style.pointerEvents="none",o&&(s.textContent=o),i.style.animation="cartButtonPulse 1.5s ease-in-out infinite",console.debug("[generate] [animation] Кнопка заблокирована:",o)):(i.style.opacity="1",i.style.cursor="pointer",i.style.pointerEvents="auto",i.style.animation="none",o&&(s.textContent=o),console.debug("[generate] [animation] Кнопка разблокирована:",o))}}setControlsDisabled(t){let e=t?"0.5":"1",o=t?"none":"auto",i=t?"not-allowed":"pointer";this.changeSideButton&&(this.changeSideButton.style.opacity=e,this.changeSideButton.style.pointerEvents=o,this.changeSideButton.style.cursor=i),this.colorBlocks.forEach(t=>{t=t.parentElement;t&&(t.style.opacity=e,t.style.pointerEvents=o,t.style.cursor=i)}),this.productBlocks.forEach(t=>{t=t.parentElement;t&&(t.style.opacity=e,t.style.pointerEvents=o,t.style.cursor=i)}),console.debug("[controls] Элементы управления "+(t?"заблокированы":"разблокированы"))}initUploadImageButton(){this.editorUploadImageButton&&(this.resetUserUploadImage(),this.editorUploadImageButton.style.cursor="pointer",this.editorUploadImageButton.addEventListener("click",()=>{this.uploadUserImage()}))}initFixQuantityForm(){if(this.quantityFormBlock){var t;let e=this.quantityFormBlock.querySelector("form")?.querySelector('input[name="quantity"]');e&&(t=()=>{var t=e.value.trim();(""===t||isNaN(Number(t))||(t=parseInt(t,10))<1||0===t)&&(e.value="1")},e.addEventListener("input",t),e.addEventListener("blur",t),e.addEventListener("change",t),t())}}async initForm(){if(this.formBlock&&this.formButton&&this.formInputVariableName){let r=this.formBlock,e=this.formInputVariableName;var t=this.formButton;let o=async()=>{if(console.debug("[form] [button] clicked"),this.isGenerating)console.warn("[form] Генерация уже идет, игнорируем повторное нажатие");else{var t=r.querySelector(`[name="${e}"]`),o=t.value;if(this.loadedUserImage||o&&""!==o.trim()&&!(o.length<1)){console.debug("[form] [input] prompt: "+o),this.isGenerating=!0,this.setGenerateButtonLoading(!0,"Генерация..."),this.setControlsDisabled(!0),this.emit(n.MOCKUP_LOADING,!0);let e=this._selectLayout||l.Layout.generateId();try{var i=await(0,c.generateImage)({uri:this.apiConfig.webhookRequest,prompt:o,shirtColor:this._selectColor.name,image:!this._selectLayout||this.loadedUserImage!==this.layouts.find(t=>t.id===this._selectLayout)?.url?this.loadedUserImage:null,withAi:this.editorLoadWithAi,layoutId:e,isNew:!this._selectLayout,background:!this.editorRemoveBackground});try{window.ym(103279214,"reachGoal","generated")}catch(t){}this.emit(n.MOCKUP_LOADING,!1);var s,a=await this.getImageData(i);console.debug("[form] [input] image data received"),this._selectLayout?(s=this.layouts.find(t=>t.id===e))&&s.isImageLayout()&&(console.debug("[form] [input] updating layout: "+s.id),s.name=o,s.url=a,console.debug("[form] [input] layout updated"),this.showLayoutList(),this.updateLayouts(),this.saveState()):this.addLayout(l.Layout.createImage({id:e,view:this._selectSide,url:a,name:o,position:{x:0,y:0}})),t.style.borderColor="#f3f3f3",this._selectLayout=null,t.value="",this.cancelEditLayout(),this.resetUserUploadImage(),this.showLayoutList(),this.setGenerateButtonLoading(!1,"✓ Готово!"),this.setControlsDisabled(!1),setTimeout(()=>{this.setGenerateButtonLoading(!1,"Сгенерировать"),this.isGenerating=!1,console.debug("[form] Флаг isGenerating сброшен")},2e3)}catch(t){try{window.OpenReplay.issue("generate",{uri:this.apiConfig.webhookRequest,prompt:o,shirtColor:this._selectColor.name,image:!this._selectLayout||this.loadedUserImage!==this.layouts.find(t=>t.id===this._selectLayout)?.url?this.loadedUserImage:null,withAi:this.editorLoadWithAi,layoutId:e,isNew:!this._selectLayout,background:!this.editorRemoveBackground})}catch(t){console.error("Ошибка установки ID пользователя в tracker:",t)}this.emit(n.MOCKUP_LOADING,!1),console.error("[form] [input] error",t),alert("Ошибка при генерации изображения"),this.setGenerateButtonLoading(!1,"Сгенерировать"),this.setControlsDisabled(!1),this.isGenerating=!1}finally{this.loadedUserImage&&this.resetUserUploadImage(),this._selectLayout&&(this._selectLayout=null,this.cancelEditLayout())}}else console.warn("[form] [input] prompt is empty or too short"),alert("Минимальная длина запроса 1 символ")}};var i=await new Promise(e=>{let o=setInterval(()=>{var t=r.querySelector("form");t&&(clearInterval(o),e(t))},100);setTimeout(()=>{clearInterval(o),e(null)},1e4)});i?(i.action="",i.method="GET",i.onsubmit=t=>{t.preventDefault(),o()},(i=i.querySelector(`textarea[name='${e}']`))&&(i.style.padding="8px"),t.onclick=o,t.style.cursor="pointer",console.debug("[form] Инициализация формы завершена")):console.warn("[form] form not found")}}restoreIconFromDataOriginal(t){var e;t&&(e=t.attributes.getNamedItem("data-original")?.value)&&(t.style.backgroundImage=`url("${e}")`)}changeProduct(t){var e;this.isGenerating?console.warn("[changeProduct] Генерация в процессе, переключение заблокировано"):(this._selectType=t,this.clearMockupCache(),(e=this.getProductByType(t))&&!e.mockups.find(t=>t.side===this._selectSide&&t.color.name===this._selectColor.name)&&(e=e.mockups.find(t=>t.side===this._selectSide))&&(this._selectColor=e.color,console.debug(`[product] Цвет изменен на ${this._selectColor.name} для продукта `+t)),this.updateProductBlocksUI(),this.updateMockup(),this.loadProduct(),this.showLayoutList(),this.updateLayouts(),this.updateSum(),this.saveState())}updateProductBlocksUI(){var t;0!==this.productBlocks.length&&(this.productBlocks.forEach(t=>{t.style.background="rgb(222 222 222)"}),t=this.productBlocks.find(t=>t.classList.contains("editor-settings__product-block__"+this._selectType)))&&(t.style.background="")}changeSide(){var t;this.isGenerating?console.warn("[changeSide] Генерация в процессе, переключение заблокировано"):(t="front"===this._selectSide?"back":"front",this.setActiveSide(t),this.updateMockup(),this.showLayoutList(),this.updateLayouts(),this.saveState(),this.emit(n.STATE_CHANGED,void 0))}changeColor(e){var t;this.isGenerating?console.warn("[changeColor] Генерация в процессе, переключение заблокировано"):(t=this.getProductByType(this._selectType))&&(t=t.mockups.find(t=>t.color.name===e))&&(this._selectColor=t.color,this.clearMockupCache(),this.updateColorBlocksUI(e),this.updateMockup(),this.saveState())}updateColorBlocksUI(e){var t;0!==this.colorBlocks.length&&(this.colorBlocks.forEach(t=>{t.style.borderColor="#f3f3f3"}),t=this.colorBlocks.find(t=>t.classList.contains("editor-settings__color-block__"+e)))&&(t.style.borderColor="")}changeSize(t){this.updateSizeBlocksUI(t),this._selectSize=t,this.saveState()}updateSizeBlocksUI(e){var t,o;0!==this.sizeBlocks.length&&(this.sizeBlocks.forEach(t=>{t=t.firstElementChild;t&&(t.style.borderColor="#f3f3f3")}),t=this.sizeBlocks.find(t=>t.classList.contains("editor-settings__size-block__"+e)))&&(o=t.firstElementChild)&&(o.style.borderColor="")}editLayout(t){var e;console.debug("[settings] [layouts] edit layout "+t.id),this._selectLayout=t.id,this.formBlock&&this.formInputVariableName&&((e=this.formBlock.querySelector(`[name="${this.formInputVariableName}"]`))?(e.value=t.name||"",e.style.borderColor="rgb(254, 94, 58)",e.focus(),console.debug(`[settings] [layouts] Установлено значение в форму: "${t.name}"`)):console.warn(`[settings] [layouts] Не найден элемент формы с именем "${this.formInputVariableName}"`)),t.isImageLayout()?(this.loadedUserImage=t.url,this.setUserUploadImage(t.url),this.initAiButtons(),this.hideAiButtons()):(this.loadedUserImage=null,this.resetUserUploadImage()),this.showLayoutList()}cancelEditLayout(){var t;console.debug("[settings] [layouts] cancel edit layout"),this._selectLayout=null,this.formBlock&&this.formInputVariableName&&(t=this.formBlock.querySelector(`[name="${this.formInputVariableName}"]`))&&(t.value="",t.style.borderColor="#f3f3f3"),this.loadedUserImage=null,this.editorLoadWithAi=!1,this.showLayoutList(),console.debug("[settings] [layouts] Редактирование отменено")}initAiButtons(){this.editorLoadWithAi=!1,this.editorRemoveBackground=!1,this.changeLoadWithAi(),this.changeRemoveBackground(),this.editorLoadWithAiButton&&(this.editorLoadWithAiButton.style.cursor="pointer",this.editorLoadWithAiButton.onclick=()=>{this.changeLoadWithAi(!0)}),this.editorLoadWithoutAiButton&&(this.editorLoadWithoutAiButton.style.cursor="pointer",this.editorLoadWithoutAiButton.onclick=()=>{this.changeLoadWithAi(!1)}),this.editorRemoveBackgroundButton&&(this.editorRemoveBackgroundButton.style.cursor="pointer",this.editorRemoveBackgroundButton.onclick=()=>{this.changeRemoveBackground(!this.editorRemoveBackground)})}hideAiButtons(){this.editorLoadWithAi=!0,this.editorLoadWithAiButton&&((this.editorLoadWithAiButton.parentElement?.parentElement?.parentElement).style.display="none")}showAiButtons(){this.editorLoadWithAiButton&&((this.editorLoadWithAiButton.parentElement?.parentElement?.parentElement).style.display="flex")}uploadUserImage(){console.debug("[upload user image] starting user image upload"),this.showAiButtons();var t=document.createElement("input");t.type="file",t.accept="image/*",t.style.display="none",t.onchange=t=>{var e,t=t.target.files?.[0];t&&(console.debug("[upload user image] file selected:",t.name),t.type.startsWith("image/")?((e=new FileReader).onload=async t=>{t=t.target?.result,console.debug("[upload user image] file loaded as data URL"),t=await this.getImageData(t);this.setUserUploadImage(t),console.debug("[upload user image] image layout added successfully")},e.onerror=()=>{console.error("[upload user image] error reading file"),alert("Ошибка при загрузке файла")},e.readAsDataURL(t)):(console.warn("[upload user image] selected file is not an image"),alert("Пожалуйста, выберите файл изображения")))},document.body.appendChild(t),t.click(),document.body.removeChild(t)}setUserUploadImage(t){var e;this.loadedUserImage=t,this.editorUploadViewBlock&&(this.editorUploadViewBlock.style.display="table",e=(0,d.getLastChild)(this.editorUploadViewBlock))&&(e.style.backgroundImage=`url(${t})`,e.style.backgroundSize="contain",e.style.backgroundPosition="center",e.style.backgroundRepeat="no-repeat")}resetUserUploadImage(){this.editorUploadViewBlock&&(this.editorUploadViewBlock.style.display="none"),this.loadedUserImage=null,this.cancelEditLayout()}changeLoadWithAi(t=!1){var e,o,i;console.debug("[ai buttons] changeLoadWithAi вызван, value="+t),this.editorLoadWithAi=t,this.editorLoadWithAiButton&&this.editorLoadWithoutAiButton&&(e=this.editorLoadWithAiButton,o=this.editorLoadWithoutAiButton,t?(t=e.firstElementChild,i=o.firstElementChild,t&&(t.style.borderColor="",console.debug("[ai buttons] С ИИ: сброшен borderColor (оранжевый)")),i&&(i.style.borderColor="#f2f2f2",console.debug("[ai buttons] Без ИИ: установлен borderColor=#f2f2f2 (серый)"))):(t=e.firstElementChild,i=o.firstElementChild,t&&(t.style.borderColor="#f2f2f2",console.debug("[ai buttons] С ИИ: установлен borderColor=#f2f2f2 (серый)")),i&&(i.style.borderColor="",console.debug("[ai buttons] Без ИИ: сброшен borderColor (оранжевый)")))),this.updateRemoveBackgroundVisibility()}changeRemoveBackground(t=!1){var e;console.debug("[remove bg button] changeRemoveBackground вызван, value="+t),this.editorRemoveBackground=t,this.editorRemoveBackgroundButton&&(e=this.editorRemoveBackgroundButton.firstElementChild)&&(t?(e.style.borderColor="",console.debug("[remove bg button] Убрать фон: сброшен borderColor (оранжевый)")):(e.style.borderColor="#f2f2f2",console.debug("[remove bg button] Убрать фон: установлен borderColor=#f2f2f2 (серый)")))}updateRemoveBackgroundVisibility(){var t;this.editorRemoveBackgroundButton&&(t=this.editorRemoveBackgroundButton.parentElement)&&(this.editorLoadWithAi?(t.style.display="none",this.changeRemoveBackground(!1),console.debug("[remove bg button] Кнопка скрыта (С ИИ выбрано)")):(t.style.display="",console.debug("[remove bg button] Кнопка показана (Без ИИ выбрано)")))}loadImage(i){return new Promise((t,e)=>{let o=new Image;o.crossOrigin="anonymous",o.onload=()=>t(o),o.onerror=e,o.src=i})}getQuantity(){var t;return this.quantityFormBlock&&(t=this.quantityFormBlock.querySelector("form")?.querySelector('input[name="quantity"]'))&&parseInt(t.value)||1}getSum(){var t=this.layouts.some(t=>"front"===t.view),e=this.layouts.some(t=>"back"===t.view),o=this.getProductByType(this._selectType);return o?e&&t?o.doubleSidedPrice:o.price:0}updateSum(){var t,e;this.editorSumBlock&&(t=this.getSum(),(e=(0,d.getLastChild)(this.editorSumBlock))&&(e.innerText=t.toString()+" ₽"),this.editorAddOrderButton)&&(e=(0,d.getLastChild)(this.editorAddOrderButton))&&(e.style.backgroundColor=0===t?"rgb(121 121 121)":"")}loadProduct(){var t=this.getProductByType(this._selectType);if(t&&t.printConfig){this.clearAllCanvas();for(var e of t.printConfig)this.createCanvasForSide(e);this.setActiveSide(this._selectSide),setTimeout(()=>{this.isLoading=!1,this.emit(n.MOCKUP_LOADING,!1)},100)}else console.warn("[product] product or printConfig not found")}clearAllCanvas(){this.canvasesContainer&&(this.canvasesContainer.innerHTML=""),this.canvases.forEach(t=>{try{t.dispose()}catch(t){console.error("[canvas] Ошибка очистки canvas:",t)}}),this.canvases=[],this.layersCanvases=[],this.activeCanvas=null}handleWindowResize(){console.debug("[canvas] Изменение размера окна");let e=this.editorBlock.clientWidth,o=this.editorBlock.clientHeight;this.canvases.forEach(t=>{t.setWidth(e),t.setHeight(o)}),this.layersCanvases.forEach(t=>{t.setWidth(e),t.setHeight(o)});var t=this.getProductByType(this._selectType);t&&t.printConfig.forEach(e=>{var t=this.canvases.find(t=>t.side===e.side);t&&this.updatePrintArea(t,e)}),this.canvases.forEach(e=>{let o=e.side;var t=e.getObjects();let i=[];t.forEach(t=>{"area:border"===t.name||"area:clip"===t.name||t.name?.startsWith("guideline")||i.push(t)}),i.forEach(t=>e.remove(t)),console.debug(`[canvas] Удалено ${i.length} объектов для перерисовки на стороне `+o),this.layouts.filter(t=>t.view===o).forEach(t=>{this.addLayoutToCanvas(t)}),e.requestRenderAll()}),console.debug("[canvas] Размер изменен:",{width:e,height:o})}updatePrintArea(t,e){var o=e.size.width/600*this.editorBlock.clientWidth,i=e.size.height/600*this.editorBlock.clientHeight,s=(this.editorBlock.clientWidth-o)/2+e.position.x/100*this.editorBlock.clientWidth,e=(this.editorBlock.clientHeight-i)/2+e.position.y/100*this.editorBlock.clientHeight,a=t.clipPath,a=(a&&a.set({width:o,height:i,left:s,top:e}),this.getObject("area:border",t));a&&a.set({width:o-3,height:i-3,left:s,top:e}),t.requestRenderAll()}createCanvasForSide(t){var e,o;this.canvasesContainer?((e=document.createElement("canvas")).id="layers--"+t.side,e.classList.add("editor-position"),e.setAttribute("ref",t.side),e.style.zIndex="7",this.canvasesContainer.appendChild(e),(e=new fabric.StaticCanvas(e,{width:this.editorBlock.clientWidth,height:this.editorBlock.clientHeight})).side=t.side,e.name="static-"+t.side,(o=document.createElement("canvas")).id="editable--"+t.side,o.setAttribute("ref",t.side),o.classList.add("editor-position"),o.style.zIndex="9",this.canvasesContainer.appendChild(o),(o=new fabric.Canvas(o,{controlsAboveOverlay:!0,width:this.editorBlock.clientWidth,height:this.editorBlock.clientHeight,backgroundColor:"transparent",uniformScaling:!0})).side=t.side,o.name="editable-"+t.side,this.layersCanvases.push(e),this.canvases.push(o),1===this.canvases.length&&(this.activeCanvas=o),this.initMainCanvas(o,t)):console.error("[canvas] canvasesContainer не инициализирован")}initMainCanvas(t,e){var o,i,s,a,r;t&&t instanceof fabric.Canvas?(r=e.size.width/600*this.editorBlock.clientWidth,o=e.size.height/600*this.editorBlock.clientHeight,i=(this.editorBlock.clientWidth-r)/2+e.position.x/100*this.editorBlock.clientWidth,s=(this.editorBlock.clientHeight-o)/2+e.position.y/100*this.editorBlock.clientHeight,a=new fabric.Rect({width:r,height:o,left:i,top:s,fill:"rgb(255, 0, 0)",name:"area:clip",evented:!1}),r=new fabric.Rect({width:r-3,height:o-3,left:i,top:s,fill:"rgba(0,0,0,0)",strokeWidth:3,stroke:"rgb(254, 94, 58)",name:"area:border",opacity:.3,evented:!1,selectable:!1,hasControls:!1,strokeDashArray:[5,5]}),t.add(r),t.clipPath=a,this.setupCanvasEventHandlers(t,e)):console.warn("[canvas] canvas не валиден")}setupCanvasEventHandlers(e,o){e.on("mouse:down",()=>{var t=this.getObject("area:border",e);t&&(t.set("opacity",.8),e.requestRenderAll())}),e.on("mouse:up",()=>{var t=this.getObject("area:border",e);t&&(t.set("opacity",.3),e.requestRenderAll())}),e.on("object:rotating",t=>{if(void 0!==t.target?.angle){var e,o=t.target.angle%360;for(e of[0,90,180,270])Math.abs(o-e)<5&&t.target.rotate(e)}}),e.on("object:moving",t=>{this.handleObjectMoving(t,e,o)}),e.on("object:modified",t=>{this.handleObjectModified(t,e,o)})}handleObjectMoving(e,t,o){var i,s,a,r,n,l;e.target&&"area:border"!==e.target.name&&"area:clip"!==e.target.name&&(r=this.layouts.find(t=>t.id===e.target.name))&&(i=this.getProductByType(this._selectType))&&(r=(0,u.calculateLayoutDimensions)(r,i,this.editorBlock.clientWidth,this.editorBlock.clientHeight),i=e.target.width*e.target.scaleX,s=e.target.height*e.target.scaleY,n=e.target.left+i/2,l=e.target.top+s/2,a=r.printAreaLeft+r.printAreaWidth/2,r=r.printAreaTop+r.printAreaHeight/2,n=Math.abs(n-a)<7,l=Math.abs(l-r)<7,n?(this.showGuideline(t,"vertical",a,0,a,this.editorBlock.clientHeight),e.target.set({left:a-i/2})):this.hideGuideline(t,"vertical"),l?(this.showGuideline(t,"horizontal",0,r,this.editorBlock.clientWidth,r),e.target.set({top:r-s/2})):this.hideGuideline(t,"horizontal"))}handleObjectModified(t,e,o){let i=t.target;var s;i&&(this.hideGuideline(e,"vertical"),this.hideGuideline(e,"horizontal"),t=this.layouts.find(t=>t.id===i.name))&&(e=this.getProductByType(this._selectType))&&(e=(0,u.calculateLayoutDimensions)(t,e,this.editorBlock.clientWidth,this.editorBlock.clientHeight),t.position.x=(i.left-e.printAreaLeft)/e.printAreaWidth,t.position.y=(i.top-e.printAreaTop)/e.printAreaHeight,t.size=i.scaleX,t.aspectRatio=i.scaleY/i.scaleX,t.angle=i.angle,s=i.width*i.scaleX,t._relativeWidth=s=s/e.printAreaWidth,console.debug(`[canvas] Layout ${t.id} updated: position=(${t.position.x.toFixed(3)}, ${t.position.y.toFixed(3)}), size=${t.size.toFixed(3)}, relativeWidth=`+s.toFixed(3)),this.saveLayouts().catch(t=>console.error("[layers] Ошибка сохранения слоёв:",t)))}showGuideline(t,e,o,i,s,a){e="guideline:"+e;this.getObject(e,t)||(o=new fabric.Line([o,i,s,a],{stroke:"rgb(254, 94, 58)",strokeWidth:2,strokeDashArray:[5,5],selectable:!1,evented:!1,name:e}))&&t.add(o)}hideGuideline(t,e){e=this.getObject("guideline:"+e,t);e&&t.remove(e)}getObject(e,t){t=t||this.activeCanvas||this.canvases[0];if(t)return t.getObjects().find(t=>t.name===e)}setActiveSide(i){console.debug("[canvas] Установка активной стороны:",i),this.canvases.forEach(t=>{var e=t.getElement(),o=e.parentElement;t.side===i?(this.activeCanvas=t,o&&(o.style.pointerEvents="auto",o.style.display="block"),e.style.display="block"):(o&&(o.style.pointerEvents="none",o.style.display="none"),e.style.display="none")}),this.layersCanvases.forEach(t=>{t.getElement().style.display=t.side===i?"block":"none"}),this._selectSide=i}async addLayoutToCanvas(e){var t,o=this.canvases.find(t=>t.side===e.view);o?(t=this.getProductByType(this._selectType))&&(t=await(0,u.renderLayout)({layout:e,product:t,containerWidth:this.editorBlock.clientWidth,containerHeight:this.editorBlock.clientHeight,loadImage:this.loadImage.bind(this)}))&&o.add(t):console.warn(`[canvas] canvas для ${e.view} не найден`)}updateLayouts(){this.activeCanvas&&this.updateLayoutsForSide(this._selectSide)}updateLayoutsForSide(e){let a=this.canvases.find(t=>t.side===e);if(a){let o=a.getObjects();o.filter(t=>"area:border"!==t.name&&"area:clip"!==t.name&&!t.name?.startsWith("guideline")).filter(e=>!this.layouts.find(t=>t.id===e.name)).forEach(t=>{a.remove(t)});var t=this.layouts.filter(t=>t.view===e);let i=[],s=[];t.forEach(e=>{var t=o.find(t=>t.name===e.id);t?e.isImageLayout()&&t.layoutUrl!==e.url&&(console.debug(`[canvas] Layout ${e.id} изменился, требуется обновление`),i.push(e)):s.push(e)}),i.forEach(e=>{var t=o.find(t=>t.name===e.id);t&&(console.debug("[canvas] Удаляем старый объект для обновления: "+e.id),a.remove(t)),console.debug("[canvas] Добавляем обновленный объект: "+e.id),this.addLayoutToCanvas(e)}),s.forEach(t=>{this.addLayoutToCanvas(t)}),a.renderAll()}}async preloadAllMockups(){console.debug("[preload] Начало предзагрузки mockups");for(var t of this.productConfigs)for(var e of t.mockups)try{var o=await this.getImageData(e.url);e.url=o,console.debug("[preload] Mockup загружен: "+e.color.name)}catch(t){console.error(`[preload] Ошибка загрузки mockup ${e.url}:`,t)}console.debug("[preload] Предзагрузка завершена")}async getImageData(t){return this.loadAndConvertImage(t)}async uploadImage(a){return console.debug("[upload] Загрузка файла:",a.name),new Promise((i,s)=>{var t=new FileReader;t.onload=async t=>{try{var e=t.target?.result,o=await this.getImageData(e);console.debug("[upload] Файл успешно загружен"),i(o)}catch(t){try{window.OpenReplay.issue("load-file",a.name)}catch(t){console.error("Ошибка установки ID пользователя в tracker:",t)}console.error("[upload] Ошибка обработки файла:",t),s(t)}},t.onerror=()=>{console.error("[upload] Ошибка чтения файла"),s(new Error("Не удалось прочитать файл"))},t.readAsDataURL(a)})}async uploadImageToServer(t){console.debug("[upload] Загрузка изображения на сервер");var e=await this.storageManager.getUserId(),t=await(await fetch(this.apiConfig.uploadImage,{method:"POST",body:JSON.stringify({image:t,user_id:e}),headers:{"Content-Type":"application/json"}})).json();return console.debug("[upload] Изображение загружено на сервер:",t.image_url),t.image_url}getProductName(){return this.getProductByType(this._selectType)?.productName||""}capitalizeFirstLetter(t){return t.charAt(0).toUpperCase()+t.slice(1)}getMockupUrl(e){var t=this.getProductByType(this._selectType);return(t=t&&t.mockups.find(t=>t.side===e&&t.color.name===this._selectColor.name))?t.url:null}async exportArt(o=!0,i=1024){let e={};var t=this.getSidesWithLayers(),t=(console.debug("[export] Найдены стороны с слоями:",t,"(front первый)",o?"с мокапом":"без мокапа",`разрешение: ${i}px`),t.map(async e=>{try{var t=await this.exportSide(e,o,i);if(t)return console.debug(`[export] Сторона ${e} успешно экспортирована`),{side:e,data:t}}catch(t){console.error(`[export] Ошибка при экспорте стороны ${e}:`,t)}return null}));return(await Promise.all(t)).forEach(t=>{t&&(e[t.side]=t.data)}),console.debug(`[export] Экспорт завершен для ${Object.keys(e).length} сторон`),e}getSidesWithLayers(){return[...new Set(this.layouts.map(t=>t.view))].sort((t,e)=>"front"===t?-1:"front"===e?1:0)}async exportSide(e,t=!0,o=1024){var i,s,a,r,n,l,d,c=this.getCanvasesForSide(e);return c.editableCanvas?(this.updateLayoutsForSide(e),console.debug(`[export] Экспортируем сторону ${e}${t?" с мокапом":" без мокапа"} (${o}px)...`),t?(t=await this.loadMockupForSide(e))?(d=this.getProductByType(this._selectType)?.printConfig.find(t=>t.side===e))?({canvas:t,ctx:i,mockupDimensions:s}=this.createExportCanvas(o,t),a=await this.exportDesignWithClipPath(c.editableCanvas,c.layersCanvas,e,o),r=d.size.width/600*s.width,n=d.size.height/600*s.height,l=s.x+(s.width-r)/2+d.position.x/100*s.width,d=s.y+(s.height-n)/2+d.position.y/100*s.height,i.drawImage(a,0,0,a.width,a.height,l,d,r,n),console.debug(`[export] Наложен обрезанный дизайн (clipPath) на мокап для ${e} в области печати (${Math.round(l)}, ${Math.round(d)}, ${Math.round(r)}x${Math.round(n)})`),t.toDataURL("image/png",1)):(console.warn("[export] Не найдена конфигурация печати для "+e),null):null:(s=await this.exportDesignWithClipPath(c.editableCanvas,c.layersCanvas,e,o),console.debug(`[export] Экспортирован чистый дизайн для ${e} (обрезан по clipPath)`),s.toDataURL("image/png",1))):(console.warn(`[export] Canvas для стороны ${e} не найден`),null)}getCanvasesForSide(e){return{editableCanvas:this.canvases.find(t=>t.side===e),layersCanvas:this.layersCanvases.find(t=>t.side===e)}}async loadMockupForSide(t){var e,o=this.getMockupUrl(t);return o?(e=await this.loadImage(o),console.debug(`[export] Загружен мокап для ${t}: `+o),e):(console.warn(`[export] Мокап для стороны ${t} не найден`),null)}createExportCanvas(t,e){var o=document.createElement("canvas"),i=o.getContext("2d"),s=(o.width=t,o.height=t,Math.min(t/e.width,t/e.height)),a=e.width*s,s=e.height*s,r=(t-a)/2,t=(t-s)/2;return i.drawImage(e,r,t,a,s),console.debug(`[export] Нарисован мокап как фон (${a}x${s})`),{canvas:o,ctx:i,mockupDimensions:{x:r,y:t,width:a,height:s}}}async createDesignCanvas(t,e,o){var i=t.getWidth(),s=t.getHeight(),a=document.createElement("canvas"),r=a.getContext("2d");return a.width=10*i,a.height=10*s,await this.addStaticLayersToCanvas(e,r,a,o),await this.addEditableObjectsToCanvas(t,r,a,i,s,o),a}async addStaticLayersToCanvas(t,e,o,i){if(t)try{var s,a=t.toDataURL({format:"png",multiplier:10,quality:1}),r="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==";a!==r&&a.length>r.length&&(s=await this.loadImage(a),e.drawImage(s,0,0,o.width,o.height),console.debug("[export] Добавлены статические слои для "+i))}catch(t){console.warn(`[export] Ошибка экспорта статических слоев для ${i}:`,t)}}async addEditableObjectsToCanvas(t,e,o,i,s,a){try{var r,n=new fabric.StaticCanvas(null,{width:i,height:s,backgroundColor:"transparent"}),l=(t.clipPath&&(r=await new Promise(e=>{t.clipPath.clone(t=>e(t))}),n.clipPath=r,console.debug("[export] Применён clipPath для экспорта стороны "+a)),this.filterDesignObjects(t.getObjects()));for(let t of l){var d=await new Promise(e=>{t.clone(t=>e(t))});n.add(d)}var c,u=n.toDataURL({format:"png",multiplier:10,quality:1}),h="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==";u!==h&&u.length>h.length&&(c=await this.loadImage(u),e.drawImage(c,0,0,o.width,o.height),console.debug("[export] Добавлены объекты дизайна без границ для "+a)),n.dispose()}catch(t){console.warn(`[export] Ошибка создания дизайна без границ для ${a}:`,t)}}filterDesignObjects(t){let e=new Set(["area:border","area:clip","guideline","guideline:vertical","guideline:horizontal"]);return t.filter(t=>!e.has(t.name))}async exportDesignWithClipPath(t,e,o,i){var s=t.clipPath;if(!s)return console.warn("[export] clipPath не найден, экспортируем весь canvas"),this.createDesignCanvas(t,e,o);var a=s.width,r=s.height,n=s.left,s=s.top,t=(console.debug(`[export] clipPath: ${a}x${r} at (${n}, ${s})`),await this.createDesignCanvas(t,e,o)),e=i/Math.max(a,r),o=document.createElement("canvas");o.width=a*e,o.height=r*e;return o.getContext("2d").drawImage(t,10*n,10*s,10*a,10*r,0,0,o.width,o.height),console.debug(`[export] Дизайн обрезан по clipPath: ${o.width}x${o.height}px`),o}async uploadDesignToServer(t){try{console.debug("[export] Загрузка дизайна на сервер");var e,o,i=new FormData;for([e,o]of Object.entries(t)){var s=await(await fetch(o)).blob();i.append(e,s,e+".png")}return console.warn("[export] Загрузка на сервер не реализована"),t}catch(t){return console.error("[export] Ошибка при загрузке на сервер:",t),null}}saveLayersToHistory(){this.currentHistoryIndex<this.layersHistory.length-1&&(this.layersHistory=this.layersHistory.slice(0,this.currentHistoryIndex+1));var t={layers:JSON.parse(JSON.stringify(this.layouts)).map(t=>new l.Layout(t)),timestamp:Date.now()};this.layersHistory.push(t),this.currentHistoryIndex=this.layersHistory.length-1;50<this.layersHistory.length&&(this.layersHistory.shift(),this.currentHistoryIndex--),console.debug(`[history] Сохранено состояние слоёв. Индекс: ${this.currentHistoryIndex}, Всего: ${this.layersHistory.length}, Слоёв: `+this.layouts.length),this.updateHistoryButtonsState()}canUndo(){return this.currentHistoryIndex===this.layersHistory.length-1?2<=this.layersHistory.length:0<this.currentHistoryIndex}canRedo(){return this.currentHistoryIndex<this.layersHistory.length-1}updateHistoryButtonsState(){var t,e=this.canUndo(),o=this.canRedo();this.editorHistoryUndoBlock&&this.editorHistoryUndoBlock.firstElementChild&&(t=this.editorHistoryUndoBlock.firstElementChild,e?(t.style.backgroundColor="",t.style.cursor="pointer"):(t.style.backgroundColor="#f2f2f2",t.style.cursor="default")),this.editorHistoryRedoBlock&&this.editorHistoryRedoBlock.firstElementChild&&(t=this.editorHistoryRedoBlock.firstElementChild,o?(t.style.backgroundColor="",t.style.cursor="pointer"):(t.style.backgroundColor="#f2f2f2",t.style.cursor="default")),console.debug("[history] Состояние кнопок: undo =",e,", redo =",o)}async undo(){if(!this.canUndo())return console.debug("[history] Undo невозможен"),!1;this.currentHistoryIndex===this.layersHistory.length-1&&2<=this.layersHistory.length?this.currentHistoryIndex=this.layersHistory.length-2:this.currentHistoryIndex=Math.max(0,this.currentHistoryIndex-1);var t=this.layersHistory[this.currentHistoryIndex];return t?(console.debug(`[history] Undo к индексу ${this.currentHistoryIndex} из `+(this.layersHistory.length-1)),await this.restoreLayersFromHistory(t),this.updateHistoryButtonsState(),!0):(console.warn("[history] История не найдена"),!1)}async redo(){if(!this.canRedo())return console.debug("[history] Redo невозможен"),!1;this.currentHistoryIndex++;var t=this.layersHistory[this.currentHistoryIndex];return t?(console.debug(`[history] Redo к индексу ${this.currentHistoryIndex} из `+(this.layersHistory.length-1)),await this.restoreLayersFromHistory(t),this.updateHistoryButtonsState(),!0):(console.warn("[history] История не найдена"),!1)}async restoreLayersFromHistory(t){this.isRestoringFromHistory=!0;try{this.layouts=[],t.layers.forEach(t=>{this.layouts.push(new l.Layout(t))}),this.showLayoutList(),this.updateLayouts(),this.updateSum(),await this.saveState(),console.debug(`[history] Восстановлено ${this.layouts.length} слоёв`)}finally{this.isRestoringFromHistory=!1}}destroy(){console.debug("[editor] Очистка ресурсов редактора"),this.loadingInterval&&(clearInterval(this.loadingInterval),this.loadingInterval=null),this.events.destroy(),this.canvases.forEach(t=>{try{t.dispose()}catch(t){console.error("[cleanup] Ошибка очистки canvas:",t)}}),this.canvases=[],this.layersCanvases.forEach(t=>{try{t.dispose()}catch(t){console.error("[cleanup] Ошибка очистки layer canvas:",t)}}),this.layersCanvases=[],console.debug("[editor] Ресурсы успешно очищены")}getCurrentState(){return{type:this._selectType,color:this._selectColor,side:this._selectSide,size:this._selectSize,layouts:this.layouts,isLoading:this.isLoading}}}},"./src/components/Popup.ts":
/*!*********************************!*\
  !*** ./src/components/Popup.ts ***!
  \*********************************/(t,e,o)=>{o.r(e),o.d(e,{default:()=>i});let l=console.debug.bind(console,"[Popup]");class i{constructor({popupId:t,popupContentClass:e,closeButtonClass:o,timeoutSeconds:i=10,autoShow:s=!0,cookieName:a="popup",cookieExpiresDays:r=1}){if(this.closeButton=null,this.autoShow=!1,this.autoShowTimeout=null,this.timeoutSeconds=25,this.cookieName="popup",this.cookieExpiresDays=1,!t||!e)throw new Error("[Popup] popupId or popupContentClass is not provided");var n=document.getElementById(t);if(!n)throw new Error(`Popup block with id ${t} not found`);t=document.querySelector("."+e);if(!t)throw new Error(`Popup content block with class ${e} not found`);this.popupBlock=n,this.popupContentBlock=t,this.initPopupBlock(),this.popupWrapperBlock=this.initPopupWrapper();e=document.querySelector("."+o);e||l(`close button with class ${o} not found`),this.closeButton=e,this.initCloseButton(),i&&(this.timeoutSeconds=i),s&&(this.autoShow=s),a&&(this.cookieName=a),r&&(this.cookieExpiresDays=r),this.popupBlock&&this.closeButton&&this.initAutoShow()}initPopupWrapper(){var t=document.createElement("div");return t.style.display="block",t.id="popup-wrapper",t.style.position="fixed",t.style.right="0",t.style.bottom="0",t.style.width="100%",t.style.zIndex="9999",t.style.pointerEvents="none",t}initPopupBlock(){this.popupBlock.style.display="none"}initCloseButton(){this.closeButton&&(this.closeButton.style.cursor="pointer",this.closeButton.onclick=()=>this.close())}initAutoShow(){this.autoShow&&!document.cookie.includes(this.cookieName+"=true")?this.autoShowTimeout=setTimeout(()=>this.show(),1e3*this.timeoutSeconds):l("is not auto shown")}show(){this.popupWrapperBlock.appendChild(this.popupBlock),this.popupContentBlock.style.pointerEvents="auto",this.popupBlock.style.display="block",document.body.appendChild(this.popupWrapperBlock)}close(){this.popupWrapperBlock.style.display="none",document.cookie=`${this.cookieName}=true; expires=${new Date(Date.now()+24*this.cookieExpiresDays*60*60*1e3).toUTCString()}; path=/;`}}},"./src/managers/EditorStorageManager.ts":
/*!**********************************************!*\
  !*** ./src/managers/EditorStorageManager.ts ***!
  \**********************************************/(t,e,o)=>{o.r(e),o.d(e,{EditorStorageManager:()=>i});class i{constructor(){this.database=null,this.isReady=!1,this.readyPromise=this.init()}async init(){return new Promise((t,e)=>{let o=indexedDB.open("editor",2);o.onupgradeneeded=t=>{t=t.target.result;t.objectStoreNames.contains("history")||t.createObjectStore("history",{keyPath:"id"}),t.objectStoreNames.contains("editor_state")||t.createObjectStore("editor_state",{keyPath:"key"}),t.objectStoreNames.contains("user_data")||t.createObjectStore("user_data",{keyPath:"key"})},o.onerror=()=>{console.error("Ошибка открытия IndexedDB",o.error),e(o.error)},o.onsuccess=()=>{this.database=o.result,this.isReady=!0,t()}})}async waitForReady(){await this.readyPromise}async saveEditorState(t){if(await this.waitForReady(),!this.database)throw new Error("Database не инициализирована");var e=this.database.transaction(["editor_state"],"readwrite").objectStore("editor_state");await Promise.all([this.putData(e,"date",t.date),this.putData(e,"color",t.color),this.putData(e,"side",t.side),this.putData(e,"type",t.type),this.putData(e,"size",t.size)])}async loadEditorState(){if(await this.waitForReady(),!this.database)throw new Error("Database не инициализирована");var t=this.database.transaction(["editor_state"],"readonly").objectStore("editor_state");try{var[e,o,i,s,a]=await Promise.all([this.getData(t,"date"),this.getData(t,"color"),this.getData(t,"side"),this.getData(t,"type"),this.getData(t,"size")]);return e&&o&&i&&s&&a?{date:e,color:o,side:i,type:s,size:a}:null}catch(t){return console.error("Ошибка загрузки состояния редактора:",t),null}}async clearEditorState(){if(await this.waitForReady(),!this.database)throw new Error("Database не инициализирована");var t=this.database.transaction(["editor_state"],"readwrite").objectStore("editor_state");await Promise.all([this.deleteData(t,"date"),this.deleteData(t,"color"),this.deleteData(t,"side"),this.deleteData(t,"type"),this.deleteData(t,"size")])}async getUserId(){if(await this.waitForReady(),!this.database)throw new Error("Database не инициализирована");var t=this.database.transaction(["user_data"],"readwrite").objectStore("user_data");let e=await this.getData(t,"userId");e||(e=crypto.randomUUID(),await this.putData(t,"userId",e));try{window.OpenReplay.setUserID(e)}catch(t){console.error("Ошибка установки ID пользователя в tracker:",t)}return e}async saveToHistory(t,e){if(await this.waitForReady(),!this.database)throw new Error("Database не инициализирована");let i={...t,id:crypto.randomUUID(),timestamp:Date.now(),description:e||"Изменения от "+(new Date).toLocaleString()};let s=this.database.transaction(["history"],"readwrite").objectStore("history");return await new Promise((t,e)=>{let o=s.add(i);o.onerror=()=>e(o.error),o.onsuccess=()=>t()}),i.id}async saveLayerOperation(t,e,o,i,s){if(await this.waitForReady(),!this.database)throw new Error("Database не инициализирована");let a={id:crypto.randomUUID(),timestamp:Date.now(),operation:t,layout:JSON.parse(JSON.stringify(e)),side:o,type:i,description:s||`${"add"===t?"Добавлен":"Удален"} слой: `+(e.name||e.type)};let r=this.database.transaction(["history"],"readwrite").objectStore("history");return await new Promise((t,e)=>{let o=r.add({...a,isLayerOperation:!0});o.onerror=()=>e(o.error),o.onsuccess=()=>t()}),a.id}async getLayerHistory(i,s=50){if(await this.waitForReady(),!this.database)throw new Error("Database не инициализирована");let a=this.database.transaction(["history"],"readonly").objectStore("history");return new Promise((e,t)=>{let o=a.getAll();o.onerror=()=>t(o.error),o.onsuccess=()=>{var t=o.result.filter(t=>t.isLayerOperation&&t.side===i.side&&t.type===i.type).map(t=>({id:t.id,timestamp:t.timestamp,operation:t.operation,layout:t.layout,side:t.side,type:t.type,description:t.description})).sort((t,e)=>e.timestamp-t.timestamp).slice(0,s);e(t)}})}async getRecentLayerOperations(t,e=10){return this.getLayerHistory(t,e)}async getHistory(i,s=50){if(await this.waitForReady(),!this.database)throw new Error("Database не инициализирована");let a=this.database.transaction(["history"],"readonly").objectStore("history");return new Promise((e,t)=>{let o=a.getAll();o.onerror=()=>t(o.error),o.onsuccess=()=>{var t=o.result.filter(t=>t.side===i.side&&t.type===i.type).sort((t,e)=>e.timestamp-t.timestamp).slice(0,s);e(t)}})}async getHistoryItem(i){if(await this.waitForReady(),!this.database)throw new Error("Database не инициализирована");let s=this.database.transaction(["history"],"readonly").objectStore("history");return new Promise((t,e)=>{let o=s.get(i);o.onerror=()=>e(o.error),o.onsuccess=()=>t(o.result||null)})}async deleteHistoryItem(i){if(await this.waitForReady(),!this.database)throw new Error("Database не инициализирована");let s=this.database.transaction(["history"],"readwrite").objectStore("history");await new Promise((t,e)=>{let o=s.delete(i);o.onerror=()=>e(o.error),o.onsuccess=()=>t()})}async clearHistory(t){if(await this.waitForReady(),!this.database)throw new Error("Database не инициализирована");var e;let i=this.database.transaction(["history"],"readwrite").objectStore("history");if(t)for(e of await this.getHistory(t,1e3))await this.deleteHistoryItem(e.id);else await new Promise((t,e)=>{let o=i.clear();o.onerror=()=>e(o.error),o.onsuccess=()=>t()})}async saveLayers(t){if(await this.waitForReady(),!this.database)throw new Error("Database не инициализирована");var e=this.database.transaction(["editor_state"],"readwrite").objectStore("editor_state");await this.putData(e,"layers",t)}async loadLayers(){if(await this.waitForReady(),!this.database)throw new Error("Database не инициализирована");try{var t=this.database.transaction(["editor_state"],"readonly").objectStore("editor_state");return await this.getData(t,"layers")||null}catch(t){return console.error("Ошибка загрузки слоёв:",t),null}}putData(i,s,a){return new Promise((t,e)=>{let o=i.put({key:s,value:a});o.onerror=()=>e(o.error),o.onsuccess=()=>t()})}getData(i,s){return new Promise((t,e)=>{let o=i.get(s);o.onerror=()=>e(o.error),o.onsuccess=()=>t(o.result?.value||null)})}deleteData(i,s){return new Promise((t,e)=>{let o=i.delete(s);o.onerror=()=>e(o.error),o.onsuccess=()=>t()})}}},"./src/models/Layout.ts":
/*!******************************!*\
  !*** ./src/models/Layout.ts ***!
  \******************************/(t,e,o)=>{o.r(e),o.d(e,{Layout:()=>s});let i={POSITION:{x:.5,y:.5},SIZE:1,ASPECT_RATIO:1,ANGLE:0,TEXT:"PrintLoop",FONT:{family:"Arial",size:12}};class s{constructor(t){this.id=t.id||s.generateId(),this.type=t.type,this.position=t.position||{...i.POSITION},this.size=this.validateSize(t.size??i.SIZE),this.aspectRatio=this.validateAspectRatio(t.aspectRatio??i.ASPECT_RATIO),this.view=t.view,this.angle=this.normalizeAngle(t.angle??i.ANGLE),this.name=t.name??null,this._relativeWidth=t._relativeWidth,"image"===t.type?this.url=t.url:"text"===t.type&&(this.text=t.text||i.TEXT,this.font=t.font?{...t.font}:{...i.FONT})}static generateId(){return"undefined"!=typeof crypto&&crypto.randomUUID?crypto.randomUUID():Date.now()+"-"+Math.random().toString(36).substring(2,11)}validateSize(t){return t<=0?(console.warn(`Invalid size ${t}, using default `+i.SIZE),i.SIZE):t}validateAspectRatio(t){return t<=0?(console.warn(`Invalid aspect ratio ${t}, using default `+i.ASPECT_RATIO),i.ASPECT_RATIO):t}normalizeAngle(t){t%=360;return t<0?360+t:t}isImageLayout(){return"image"===this.type&&void 0!==this.url}isTextLayout(){return"text"===this.type&&void 0!==this.text&&void 0!==this.font}setPosition(t,e){this.position={x:t,y:e}}move(t,e){this.position.x+=t,this.position.y+=e}setSize(t){this.size=this.validateSize(t)}rotate(t){this.angle=this.normalizeAngle(this.angle+t)}setAngle(t){this.angle=this.normalizeAngle(t)}setText(t){this.isTextLayout()&&(this.text=t)}setFont(t){this.isTextLayout()&&this.font&&(this.font={...this.font,...t})}clone(){var t;return"image"===this.type?(t={type:"image",url:this.url,position:{...this.position},size:this.size,aspectRatio:this.aspectRatio,view:this.view,angle:this.angle,name:this.name},(t=new s(t))._relativeWidth=this._relativeWidth,t):(t={type:"text",position:{...this.position},size:this.size,aspectRatio:this.aspectRatio,view:this.view,angle:this.angle,name:this.name},void 0!==this.text&&(t.text=this.text),void 0!==this.font&&(t.font={...this.font}),(t=new s(t))._relativeWidth=this._relativeWidth,t)}toJSON(){var t={id:this.id,type:this.type,position:this.position,size:this.size,aspectRatio:this.aspectRatio,view:this.view,angle:this.angle,name:this.name,_relativeWidth:this._relativeWidth};return"image"===this.type?{...t,url:this.url}:"text"===this.type?{...t,text:this.text,font:this.font}:t}static fromJSON(t){return new s(t)}static createImage(t){return new s({...t,type:"image"})}static createText(t){return new s({...t,type:"text"})}}},"./src/utils/TypedEventEmitter.ts":
/*!****************************************!*\
  !*** ./src/utils/TypedEventEmitter.ts ***!
  \****************************************/(t,e,o)=>{o.r(e),o.d(e,{TypedEventEmitter:()=>i});class i{constructor(){this.listeners=new Map}on(t,e){this.listeners.has(t)||this.listeners.set(t,new Set),this.listeners.get(t).add(e)}once(e,o){let i=t=>{o(t),this.off(e,i)};this.on(e,i)}off(t,e){var o=this.listeners.get(t);o&&(o.delete(e),0===o.size)&&this.listeners.delete(t)}emit(e,o){var t=this.listeners.get(e);t&&t.forEach(t=>{try{t(o)}catch(t){console.error(`[EventEmitter] Ошибка в обработчике события "${String(e)}":`,t)}})}removeAllListeners(t){t?this.listeners.delete(t):this.listeners.clear()}listenerCount(t){return this.listeners.get(t)?.size||0}hasListeners(t){return 0<this.listenerCount(t)}eventNames(){return Array.from(this.listeners.keys())}destroy(){this.listeners.clear()}}},"./src/utils/api.ts":
/*!**************************!*\
  !*** ./src/utils/api.ts ***!
  \**************************/(t,e,o)=>{o.r(e),o.d(e,{createProduct:()=>function({quantity:t,name:e,size:o,color:i,sides:s,article:a,price:r}){var n="698341642832_"+Date.now(),l=1<s.length?`<a target="_blank" href="${s[0]?.image_url}" target="_blank">${s[0]?.image_url.slice(-10)}</a>, <a target="_blank" href="${s[1]?.image_url}" target="_blank">${s[1]?.image_url.slice(-10)}</a>`:`<a target="_blank" href="${s[0]?.image_url}" target="_blank">${s[0]?.image_url.slice(-10)}</a>`,n={id:n,name:e,price:r,quantity:t,img:s[0]?.image_url,options:[{option:"Размер",variant:o},{option:"Дизайн",variant:l},{option:"Артикул",variant:a},{option:"Цвет",variant:i.name},{option:"Принт",variant:1==s.length?"Односторонний":"Двухсторонний"}]};if(console.debug("[cart] add product",n),"function"==typeof window.tcart__addProduct)try{window.tcart__addProduct(n);try{window.ym(103279214,"reachGoal","add_to_cart")}catch(t){}}catch(t){console.error("[cart] Ошибка при добавлении продукта в корзину",t)}else console.warn("[cart] Корзина Tilda не загружена.")},generateImage:()=>async function({uri:t,prompt:e,shirtColor:o,image:i,withAi:s,layoutId:a,isNew:r=!0,background:n=!0}){var l=new h.EditorStorageManager,l=await l.getUserId(),d=new FormData;d.set("userId",l),d.set("prompt",e),d.set("shirtColor",o),d.set("placement","center"),d.set("printSize","big"),d.set("transferType",""),d.set("request_type","generate"),d.set("background",n.toString()),a&&d.set("layoutId",a);if(i){console.debug("[generate image]",i);var[l,e]=i.split(","),o=l.split(":")[1].split(";")[0],c=(console.debug("[generate image] [type]",o),atob(e)),u=new Array(c.length);for(let t=0;t<c.length;t++)u[t]=c.charCodeAt(t);n=new Uint8Array(u);d.set("request_type","image"),d.set("user_image",new Blob([n],{type:"image/png"})),d.set("transferType",s?"ai":"no-ai")}r||d.set("request_type","edit");a=await fetch(t,{method:"POST",body:d}),i=await a.json();return i.image_url||i.image}});var h=o(/*! ../managers/EditorStorageManager */"./src/managers/EditorStorageManager.ts")},"./src/utils/canvasUtils.ts":
/*!**********************************!*\
  !*** ./src/utils/canvasUtils.ts ***!
  \**********************************/(t,e,o)=>{function l(e,t,o,i){var s,a,t=t.printConfig.find(t=>t.side===e.view);if(t)return s=t.size.width/600*o,a=t.size.height/600*i,o=Math.round((o-s)/2+t.position.x/100*o),t=Math.round((i-a)/2+t.position.y/100*i),{left:o+s*e.position.x,top:t+a*e.position.y,scaleX:e.size,scaleY:e.size*e.aspectRatio,angle:e.angle,printAreaWidth:s,printAreaHeight:a,printAreaLeft:o,printAreaTop:t};throw new Error("Print config not found for side: "+e.view)}o.r(e),o.d(e,{calculateLayoutDimensions:()=>l,renderLayout:()=>async function(e){var{layout:e,product:o,containerWidth:i,containerHeight:s,loadImage:a}=e,o=l(e,o,i,s),i=window.fabric;if(i){if(e.isImageLayout()){s=await a(e.url),a=new i.Image(s);let t=e.size;var r,n=e._relativeWidth;return n&&0<n?(r=o.printAreaWidth*n,t=r/s.width,console.debug(`[renderLayout] Адаптация к новому размеру: relativeWidth=${n.toFixed(3)}, targetWidth=${r.toFixed(1)}px, scale=`+t.toFixed(3))):1===e.size&&s.width>o.printAreaWidth?(t=o.printAreaWidth/s.width,e.size=t,r=s.width*t/o.printAreaWidth,e._relativeWidth=r,console.debug(`[renderLayout] Автоподгонка размера: ${s.width}px → ${o.printAreaWidth}px, scale=${t.toFixed(3)}, relativeWidth=`+r.toFixed(3))):n&&0!==n||(n=s.width*e.size/o.printAreaWidth,e._relativeWidth=n,console.debug("[renderLayout] Вычислен _relativeWidth для старого layout: "+n.toFixed(3))),a.set({left:o.left,top:o.top,scaleX:t,scaleY:t*e.aspectRatio,angle:o.angle,name:e.id,layoutUrl:e.url}),a}if(e.isTextLayout())return(s=new i.Text(e.text,{fontFamily:e.font.family,fontSize:e.font.size})).set({left:o.left,top:o.top,scaleX:o.scaleX,scaleY:o.scaleY,angle:o.angle,name:e.id}),s}else console.error("[renderLayout] fabric.js не загружен");return null},renderLayoutToCanvas:()=>async function(t,e,o,i,s,a){o=l(e,o,i,s);e.isImageLayout()?(i=await a(e.url),t.save(),t.translate(o.left,o.top),t.rotate(o.angle*Math.PI/180),s=i.width*o.scaleX,a=i.height*o.scaleY,t.drawImage(i,0,0,s,a),t.restore()):e.isTextLayout()&&(t.save(),t.translate(o.left,o.top),t.rotate(o.angle*Math.PI/180),t.font=e.font.size*o.scaleX+"px "+e.font.family,t.fillStyle="black",t.fillText(e.text,0,0),t.restore())}})},"./src/utils/safeRouteIntegrationV2.ts":
/*!*********************************************!*\
  !*** ./src/utils/safeRouteIntegrationV2.ts ***!
  \*********************************************/(t,e,o)=>{o.r(e),o.d(e,{SafeRouteIntegrationV2:()=>i,initSafeRouteV2:()=>a});class i{constructor(){this.phoneData=null,this.initialized=!1,this.originalFormDataAppend=null,this.init()}init(){this.initialized||(console.log("[SafeRoute V2] 🚀 Инициализация агрессивной версии..."),window.addEventListener("message",this.handleMessage.bind(this)),this.interceptFormData(),this.interceptXHR(),this.interceptFetch(),this.interceptSubmit(),this.initialized=!0,console.log("[SafeRoute V2] ✅ Инициализация завершена"),window.safeRouteV2=this)}handleMessage(t){if(t.origin.includes("saferoute.ru"))try{var e="string"==typeof t.data?JSON.parse(t.data):t.data,o=(console.log("[SafeRoute V2] 📬 Сообщение от SafeRoute"),this.extractPhone(e));o&&(console.log("[SafeRoute V2] 📱 Телефон:",o),this.setPhone(o))}catch(t){console.debug("[SafeRoute V2] Ошибка обработки:",t)}}extractPhone(t){return t.phone||t.data?.contacts?.phone||t.contacts?.phone||t.recipient?.phone||null}setPhone(t){var e=this.parsePhone(t);if(e){this.phoneData=e,console.log("[SafeRoute V2] ✅ Телефон сохранен:",this.phoneData);try{sessionStorage.setItem("sr_phone",JSON.stringify(this.phoneData))}catch(t){}this.fillPhoneFields()}else console.warn("[SafeRoute V2] ❌ Не удалось распарсить:",t)}parsePhone(t){t=t.replace(/\D/g,"");if(0===t.length)return null;let e=t;if(t.startsWith("7")&&11===t.length)e=t.substring(1);else if(t.startsWith("8")&&11===t.length)e=t.substring(1);else if(10!==t.length)return null;t=this.formatPhone(e);return{iso:"+7",number:t,full:"+7 "+t}}formatPhone(t){return 10!==t.length?t:`(${t.substring(0,3)}) ${t.substring(3,6)}-${t.substring(6,8)}-`+t.substring(8,10)}fillPhoneFields(){if(this.phoneData){var t=document.querySelectorAll("form");let i=!1;t.forEach(t=>{var e=this.ensureInput(t,"tildaspec-phone-part[]-iso","hidden"),o=this.ensureInput(t,"tildaspec-phone-part[]","tel"),t=this.ensureInput(t,"phone","hidden");e&&this.phoneData&&(e.value=this.phoneData.iso,i=!0),o&&this.phoneData&&(o.value=this.phoneData.number,i=!0),t&&this.phoneData&&(t.value=this.phoneData.full,i=!0)}),i&&console.log("[SafeRoute V2] ✅ Поля заполнены")}}ensureInput(t,e,o){let i=t.querySelector(`input[name="${e}"]`);return i||((i=document.createElement("input")).type=o,i.name=e,i.style.display="none",t.appendChild(i),console.log("[SafeRoute V2] ➕ Создано поле:",e)),i}interceptFormData(){let e=this,o=window.FormData;window.FormData=function(t){t=new o(t);return!e.phoneData||t.has("phone")&&t.get("phone")||(t.set("tildaspec-phone-part[]-iso",e.phoneData.iso),t.set("tildaspec-phone-part[]",e.phoneData.number),t.set("phone",e.phoneData.full),console.log("[SafeRoute V2] 📦 Телефон добавлен в FormData")),t},window.FormData.prototype=o.prototype,console.log("[SafeRoute V2] ✅ FormData перехвачен")}interceptXHR(){let o=this,i=XMLHttpRequest.prototype.open,s=XMLHttpRequest.prototype.send;XMLHttpRequest.prototype.open=function(t,e,...o){return this._url=e,this._method=t,i.apply(this,[t,e,...o])},XMLHttpRequest.prototype.send=function(t){var e=this._url||"";return(e.includes("forms.tildaapi.com")||e.includes("/form/submit"))&&(console.log("[SafeRoute V2] 🌐 Перехват XHR к:",e),o.phoneData&&t instanceof FormData?t.has("phone")&&t.get("phone")||(t.set("tildaspec-phone-part[]-iso",o.phoneData.iso),t.set("tildaspec-phone-part[]",o.phoneData.number),t.set("phone",o.phoneData.full),console.log("[SafeRoute V2] ✅ Телефон добавлен в XHR")):!o.phoneData||"string"!=typeof t||(e=new URLSearchParams(t)).has("phone")&&e.get("phone")||(e.set("tildaspec-phone-part[]-iso",o.phoneData.iso),e.set("tildaspec-phone-part[]",o.phoneData.number),e.set("phone",o.phoneData.full),t=e.toString(),console.log("[SafeRoute V2] ✅ Телефон добавлен в XHR (URLEncoded)"))),s.call(this,t)},console.log("[SafeRoute V2] ✅ XMLHttpRequest перехвачен")}interceptFetch(){let i=this,s=window.fetch;window.fetch=function(t,e){var o="string"==typeof t?t:t instanceof URL?t.href:t.url;return(o.includes("forms.tildaapi.com")||o.includes("/form/submit"))&&(console.log("[SafeRoute V2] 🌐 Перехват fetch к:",o),i.phoneData)&&e?.body instanceof FormData&&(e.body.has("phone")&&e.body.get("phone")||(e.body.set("tildaspec-phone-part[]-iso",i.phoneData.iso),e.body.set("tildaspec-phone-part[]",i.phoneData.number),e.body.set("phone",i.phoneData.full),console.log("[SafeRoute V2] ✅ Телефон добавлен в fetch"))),s.apply(window,[t,e])},console.log("[SafeRoute V2] ✅ fetch перехвачен")}interceptSubmit(){document.addEventListener("submit",t=>{t=t.target;if(console.log("[SafeRoute V2] 📤 Submit формы:",t.action),this.phoneData&&this.fillPhoneFields(),!this.phoneData)try{var e=sessionStorage.getItem("sr_phone");e&&(this.phoneData=JSON.parse(e),this.fillPhoneFields())}catch(t){}},!0),console.log("[SafeRoute V2] ✅ Submit перехвачен")}getPhone(){return this.phoneData}}let s=null;function a(){return s=s||new i}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",a):a()},"./src/utils/tildaUtils.ts":
/*!*********************************!*\
  !*** ./src/utils/tildaUtils.ts ***!
  \*********************************/(t,e,o)=>{o.r(e),o.d(e,{getLastChild:()=>function t(e){if(!e)return null;if(!e.firstElementChild)return e;return t(e.firstElementChild)}})}},a={};function r(t){var e=a[t];return void 0!==e||(e=a[t]={exports:{}},s[t](e,e.exports,r)),e.exports}r.d=(t,e)=>{for(var o in e)r.o(e,o)&&!r.o(t,o)&&Object.defineProperty(t,o,{enumerable:!0,get:e[o]})},r.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),
/*!**********************!*\
  !*** ./src/index.ts ***!
  \**********************/
(r.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})})({}),t=r(/*! ./components/Popup */"./src/components/Popup.ts"),e=r(/*! ./components/Editor */"./src/components/Editor.ts"),o=r(/*! ./components/CardForm */"./src/components/CardForm.ts"),i=r(/*! ./utils/safeRouteIntegrationV2 */"./src/utils/safeRouteIntegrationV2.ts"),window.popup=t.default,window.editor=e.default,window.cardForm=o.CardForm,(0,i.initSafeRouteV2)()})();